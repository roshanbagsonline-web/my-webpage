<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' stroke='black' fill='none' stroke-width='2'>
  <rect x='6' y='7' width='12' height='13' rx='2' />
  <path d='M9 7V4a3 3 0 0 1 6 0v3' />
  <circle cx='10' cy='20' r='1.5'/>
  <circle cx='14' cy='20' r='1.5'/>
</svg>">

<title>Roshan Online</title>
    
    <!-- Styles & Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="app.js"></script>


    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #0f172a; }
        
        /* Smooth transitions for all interactable elements */
        button, input, select, textarea, div { transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform; transition-duration: 200ms; }

        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Date input styling */
        input[type="date"] { position: relative; }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 0.6; transition: 0.2s; }
        input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }

        @media print {
            @page { size: auto; margin: 0; }
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; background-color: white; }
            aside, nav, .no-print, .print-hidden, button { display: none !important; }
            #root { overflow: visible !important; height: auto !important; }
              #InvoiceTemplate {
        transform-origin: top left;
        transform: scale(0.77);
        width: 129.88% !important; /* Forces the layout to fill the width */
        margin: 0 auto;
    }
    
    #PackingSlipTemplate{   transform-origin: top left;
        transform: scale(0.90);
        width: 129.90% !important; }
        }
    </style>
    
    <style>
  table {
    width: 100%;
    border-collapse: collapse;
  }

  tbody tr:nth-child(odd) {
    background-color: #ffffff;
  }

  tbody tr:nth-child(even) {
    background-color: #f8fafc;
  }

  tbody tr:hover {
    background-color: #ddffe0;
  }

  tbody tr.selected {
    background-color: #ddffe0; /* slate */
    color: green;
  }

  td, th {
    padding: 8px;
    border-bottom: 1px solid #ddffe0;
  }
  




</style>

    
    
    

    <!-- Global Error Handler -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const root = document.getElementById('root');
            if (root) {
                root.innerHTML = `
                    <div style="padding: 2rem; color: #b91c1c; font-family: sans-serif; max-width: 800px; margin: 0 auto;">
                        <h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">Application Crashed</h2>
                        <div style="background: #fef2f2; padding: 1rem; border-radius: 0.5rem; border: 1px solid #fca5a5; overflow-x: auto;">
                            <p style="font-weight: bold; margin-bottom: 0.5rem;">${message}</p>
                            <pre style="font-size: 0.875rem;">${error && error.stack ? error.stack : 'No stack trace available.'}</pre>
                            <p style="margin-top: 0.5rem; font-size: 0.75rem;">Source: ${source}:${lineno}</p>
                        </div>
                        <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #dc2626; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">Reload Application</button>
                    </div>
                `;
            }
        };
    </script>


    <!-- Environment Shim -->
    <script>
    window.process = {
        env: {
            API_KEY: ''
        }
    };
</script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>


    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "@google/genai": "https://esm.sh/@google/genai@0.1.1"
      }
    }
    </script>
</head>
<body>
    <div id="root">
        <!-- Loading Spinner -->
        <div class="loader-wrapper">
    <div class="bag-loader">
        <div class="bag bag-left"></div>
        <div class="bag bag-right"></div>
    </div>

    <p class="loading-text">Processing Your Order...</p>
</div>

<style>
.loader-wrapper {
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: #ffffff;
    font-family: system-ui, sans-serif;
}

.bag-loader {
    position: relative;
    width: 90px;
    height: 70px;
}

/* Bag Style */
.bag {
    width: 40px;
    height: 50px;
    border: 2.5px solid #475569;
    border-radius: 6px;
    position: absolute;
    bottom: 0;
    animation: float 1.4s ease-in-out infinite;
}

.bag::before {
    content: "";
    width: 22px;
    height: 14px;
    border: 2.5px solid #475569;
    border-bottom: none;
    border-radius: 14px 14px 0 0;
    position: absolute;
    top: -16px;
    left: 8px;
}

/* Left Bag */
.bag-left {
    left: 0;
    animation-delay: 0s;
}

/* Right Bag */
.bag-right {
    right: 0;
    animation-delay: 0.3s;
}

/* Floating Motion */
@keyframes float {
    0%, 100% { transform: translateY(0); opacity: 1; }
    50% { transform: translateY(-10px); opacity: 0.85; }
}

/* Text */
.loading-text {
    margin-top: 18px;
    font-size: 15px;
    font-weight: 600;
    color: #475569;
}
</style>




    </div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
        import React, { useState, useMemo, useEffect, useRef, useCallback, createContext, useContext } from "react";
        import { createRoot } from "react-dom/client";
        import {
  Save, Plus, Trash2, Printer, Sparkles, Box, Calendar, FileText, User, Loader2, Eraser,
  ClipboardPaste, Wand2, X, RotateCcw, LayoutDashboard, Truck, Edit, CreditCard, BarChart3,
  Settings, ChevronRight, LogOut, Hash, Search, Filter, RefreshCw, CheckCircle2, AlertCircle,
  Download, Eye, Package, SlidersHorizontal, Pencil, ChevronDown, Cloud, Upload, List ,
  ArrowRight, Check, AlertTriangle, FileSpreadsheet, Mail, ExternalLink, CalendarDays,
  Briefcase, ShoppingBag,

  /* ✅ Added for Status Dropdown */
  ListTodo,
  Navigation,
  XCircle,
  CheckCircle
} from "lucide-react";

        

        
        // --- Configuration ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwsivxWnGiAJR02WdJau0qONqQPff5iH1u_4Tsj8pIbGv3USjrkEFVNY-C0m8zVsrrl/exec"; 
        const SETTLEMENT_OPTIONS = ["CC Avenue", "Professional Cod", "Post Office", "Cc Avenue-Link", "Account Transfer", "Cash Free", "UPI Store"];

        // --- Utilities ---
        
        // Fix for date inputs: Returns YYYY-MM-DD in LOCAL time, preventing the "day before" bug from UTC conversion
        const getLocalDateString = (date) => {
            if (!date) return '';
            const d = typeof date === 'string' ? new Date(date) : date;
            if (!(d instanceof Date) || isNaN(d.getTime())) return '';
            const offset = d.getTimezoneOffset() * 60000;
            const local = new Date(d.getTime() - offset);
            return local.toISOString().slice(0, 10);
        };

        const formatDate = (dateStr) => { if (!dateStr) return '-'; try { const d = new Date(dateStr); if (isNaN(d.getTime())) return String(dateStr); return d.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'}); } catch (e) { return '-'; } };
        
        // Updated to use local date logic
        const toInputDate = (dateStr) => { 
            if (!dateStr) return ''; 
            return getLocalDateString(dateStr);
        };
        
        const parseDate = (dateVal) => { 
            if (!dateVal) return null; 
            // Fix: Explicitly treat "YYYY-MM-DD" string as local start of day by appending time
            if (typeof dateVal === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateVal)) {
                return new Date(dateVal + "T00:00:00");
            }
            const d = new Date(dateVal); 
            if (!isNaN(d.getTime())) return d; 
            return null; 
        };

        const numberToWords = (num) => { const a = ['','One ','Two ','Three ','Four ','Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen ']; const b = ['', '', 'Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety']; const inWords = (nVal) => { const n = nVal.toString(); if (n.length > 9) return 'overflow'; let n_array = ('000000000' + n).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/); if (!n_array) return ''; let str = ''; str += (n_array[1] != 0) ? (a[Number(n_array[1])] || b[n_array[1][0]] + ' ' + a[n_array[1][1]]) + 'Crore ' : ''; str += (n_array[2] != 0) ? (a[Number(n_array[2])] || b[n_array[2][0]] + ' ' + a[n_array[2][1]]) + 'Lakh ' : ''; str += (n_array[3] != 0) ? (a[Number(n_array[3])] || b[n_array[3][0]] + ' ' + a[n_array[3][1]]) + 'Thousand ' : ''; str += (n_array[4] != 0) ? (a[Number(n_array[4])] || b[n_array[4][0]] + ' ' + a[n_array[4][1]]) + 'Hundred ' : ''; str += (n_array[5] != 0) ? ((str != '') ? 'And ' : '') + (a[Number(n_array[5])] || b[n_array[5][0]] + ' ' + a[n_array[5][1]]) + 'Only ' : 'Only'; return str; }; return inWords(Math.floor(num)); };
        const getShippingLabel = (mode) => {
        if (mode === "Normal") return "Urgent Deliver"; 
        if (mode === "Post Speed Normal") return "CONTRACT ID : 40201892    ,   Biller ID : 53140"; 
        if (mode === "Post Business Normal") return "CONTRACT ID : 40215194    ,   Biller ID : 53141 "; 
        return ""; };
        
        // Initial Items & Details
        const getInitialItems = () => ([{ id: Math.random().toString(36).substr(2, 9), productName: "", mrp: 0, discount: 0, quantity: 0, gst: 18, hsnCode: "4202", total: 0 }]);
        const getInitialDetails = () => ({ date: getLocalDateString(new Date()), lastInvoiceNo: "Loading...", currentInvoiceNo: "", orderNumber: "", customerName: "", contact: "", address: "", pincode: "", state: "", paymentType: "Online Payment", email: "", freightCharge: 0 });
        const generateOrderNumberString = () => { const now = new Date(); return `RB${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`; };
        
        const parseCurrency = (val) => {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            return parseFloat(val.toString().replace(/,/g, '')) || 0;
        };

        // --- Common Components ---
        const MultiSelectDropdown = ({ options, value, onChange, placeholder = "Select..." }) => {
            const [isOpen, setIsOpen] = useState(false);
            const wrapperRef = useRef(null);
            useEffect(() => { const handleClickOutside = (event) => { if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setIsOpen(false); }; document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside); }, []);
            const selectedItems = useMemo(() => value ? value.split('|').map(s => s.trim()).filter(Boolean) : [], [value]);
            const toggleOption = (option) => { let newSelection; if (selectedItems.includes(option)) newSelection = selectedItems.filter(item => item !== option); else newSelection = [...selectedItems, option]; onChange(newSelection.join(' | ')); };
            return (
                <div className="relative w-full" ref={wrapperRef}>
                    <button type="button" onClick={() => setIsOpen(!isOpen)} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs font-medium text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500/50 hover:border-indigo-300 transition-all flex justify-between items-center text-left min-h-[38px]">
                        <span className={`truncate block pr-2 ${!selectedItems.length ? 'text-slate-400' : ''}`}>{selectedItems.length > 0 ? selectedItems.join(' | ') : placeholder}</span>
                        <ChevronDown size={14} className="text-slate-400 flex-shrink-0" />
                    </button>
                    {isOpen && (
                        <div className="absolute top-full left-0 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-xl shadow-slate-200/50 z-50 max-h-60 overflow-y-auto animate-in fade-in zoom-in-95 duration-100">
                            {options.map(opt => {
                                const isSelected = selectedItems.includes(opt);
                                return (
                                    <div key={opt} onClick={() => toggleOption(opt)} className="flex items-center gap-2 px-3 py-2 hover:bg-indigo-50 cursor-pointer border-b border-slate-50 last:border-none">
                                        <div className={`w-4 h-4 rounded border flex items-center justify-center transition-colors flex-shrink-0 ${isSelected ? 'bg-indigo-600 border-indigo-600' : 'bg-white border-slate-300'}`}>{isSelected && <Check size={10} className="text-white" />}</div>
                                        <span className={`text-xs ${isSelected ? 'font-bold text-indigo-700' : 'text-slate-700'}`}>{opt}</span>
                                    </div>
                                )
                            })}
                        </div>
                    )}
                </div>
            );
        };

        const InputGroup = ({ label, value, onChange, type = "text" }) => (
            <div>
                <label className="block text-xs font-bold text-slate-500 mb-1.5 truncate uppercase tracking-wider" title={label}>{label}</label>
                <input type={type} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-400 transition-all shadow-sm" value={value || ''} onChange={(e) => onChange(e.target.value)} />
            </div>
        );

        // --- Context ---
        const OrderContext = createContext(null);
        const useOrders = () => { const context = useContext(OrderContext); if (!context) throw new Error("useOrders must be used within OrderProvider"); return context; };

       const OrderProvider = ({ children }) => {
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(false);
            const [syncing, setSyncing] = useState(false);
            const [pendingOps, setPendingOps] = useState([]);
            const [lastSyncTime, setLastSyncTime] = useState(null);
            const [settings, setSettings] = useState({ dateRangeType: 'last_6_months' });

            const refreshData = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getOrders`, { redirect: "follow" });
                    const data = await response.json();
                    if (data && data.orders) {
                        const enriched = data.orders.map((o, i) => ({...o, id: `row-${i}`, rowIndex: i}));
                        const now = new Date();
                        let startDate = new Date(0); let endDate = new Date(); endDate.setHours(23, 59, 59, 999);
                        if(settings.dateRangeType === 'current_month') startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        else if(settings.dateRangeType === 'last_3_months') { startDate = new Date(); startDate.setMonth(now.getMonth() - 3); }
                        else if(settings.dateRangeType === 'last_6_months') { startDate = new Date(); startDate.setMonth(now.getMonth() - 6); }
                        else if(settings.dateRangeType === 'last_1_year') { startDate = new Date(); startDate.setFullYear(now.getFullYear() - 1); }
                        else if(settings.dateRangeType === 'custom') { 
                            if (settings.customStartDate) startDate = new Date(settings.customStartDate + "T00:00:00"); 
                            if (settings.customEndDate) endDate = new Date(settings.customEndDate + "T23:59:59.999"); 
                        }
                        const filtered = enriched.filter((o) => { const d = parseDate(o.date); return d ? (d >= startDate && d <= endDate) : true; });
                        setOrders(filtered); setLastSyncTime(new Date());
                    }
                } catch (e) { 
                    console.error("Fetch error", e); 
                    // Fallback to empty or previous if error
                } finally { setLoading(false); }
            };

            useEffect(() => { refreshData(); }, [settings.dateRangeType, settings.customStartDate, settings.customEndDate]);

            const syncData = async () => {
                if (pendingOps.length === 0) { await refreshData(); return; }
                setSyncing(true);
                try {
                    // Optimized sync: process sequentially to avoid sheet conflicts
                    const creates = pendingOps.filter(op => op.type === 'create');
                    const updates = pendingOps.filter(op => op.type === 'update');

                    // Batch Create (Must be sequential for invoice numbers to be accurate)
                    for (const op of creates) {
                        const rows = op.payload;
                        for (const row of rows) {
                            const orderPayload = {
                                action: "addOrder",
                                order: {
  date: row[0],
  orderId: row[1],
  billNo: row[2],
  customerName: row[3],
  contact: row[4],
  address: row[5],
  pincode: row[6],
  state: row[7],
  paymentType: row[8],
  productName: row[9],
  mrp: row[10],
  discount: row[11],
  price: row[12],
  qty: row[13],
  totalQty: row[14],
  gstRate: row[15],          // decimal (0.18)
  hsn: row[16],
  totalAmount: row[17],
  parentId: row[18],
  paidUtr: row[19],
  orderDate: row[20],
  settleType: row[21],
  awb: row[22],
  email: row[24],
  trackingStatus: row[25],
  barcode: row[26],
  taxableAmount: row[27],
  gstAmount: row[28],
  cgst: row[29],
  settlementCharge: row[30],
  settledDate: row[31],
  settledAmount: row[32],
  settledUtr: row[33],
  productCategory: row[35],
  settlementGenerated: row[37]
}

                            };
                            // Use text/plain to bypass preflight issues
                            await fetch(GOOGLE_SCRIPT_URL, {
                                method: "POST",
                                mode: "cors",
                                body: JSON.stringify(orderPayload)
                            });
                        }
                    }

                    // Batch Update
                    if (updates.length > 0) {
                        const bulkUpdates = updates.map(u => ({ orderId: u.id, changes: u.payload.changes }));
                        await fetch(GOOGLE_SCRIPT_URL, {
                            method: "POST",
                            mode: "cors",
                            body: JSON.stringify({ action: "updateOrders", updates: bulkUpdates })
                        });
                    }
                    
                    setPendingOps([]); 
                    await refreshData();
                    alert("✅ Synchronization Complete!");
                } catch (e) { 
                    alert("❌ Sync partially failed or took too long. Checking connection..."); 
                    console.error("Sync Error", e);
                } finally { setSyncing(false); }
            };

            const addLocalOrder = (rows, orderDetails) => {
                const newOrderId = orderDetails.orderNumber;
                setPendingOps(prev => [...prev, { type: 'create', id: newOrderId, payload: rows, timestamp: Date.now() }]);
                // Optimistic UI update
                 const newOrders = rows.map((row, idx) => ({
    id: `temp-${Date.now()}-${idx}`,
    date: row[0],
    orderId: row[1],
    billNo: row[2],
    customerName: row[3],
    contact: row[4],
    address: row[5],
    pincode: row[6],
    state: row[7],
    paymentType: row[8],
    productName: row[9],
    mrp: row[10],
    discount: row[11],
    price: parseFloat(row[12]),
    qty: row[13],
    totalQty: row[14],
    gstRate: row[15] * 100,   // UI expects %
    hsn: row[16],
    totalAmount: row[17],
    parentId: row[18],
    paidUtr: row[19],
    orderDate: row[20],
    settleType: row[21],
    awb: row[22],
    email: row[24],
    trackingStatus: row[25] || "Pending",
    barcode: row[26],
    taxableAmount: row[27],
    gstAmount: row[28],
    cgst: row[29],
    settlementCharge: row[30],
    settledDate: row[31],
    settledAmount: row[32],
    settledUtr: row[33],
    productCategory: row[35],
    settlementGenerated: row[37] || "Not Generated"
                }));
                setOrders(prev => [...newOrders, ...prev]);
            };

            const updateLocalOrder = (orderId, updates) => {
                setPendingOps(prev => [...prev, { type: 'update', id: orderId, payload: { orderId, changes: updates }, timestamp: Date.now() }]);
                setOrders(prev => prev.map(o => o.orderId === orderId ? { ...o, ...updates } : o));
            };

            const removePendingOp = (timestamp) => setPendingOps(prev => prev.filter(op => op.timestamp !== timestamp));
            const updatePendingOp = (timestamp, newPayload) => setPendingOps(prev => prev.map(op => op.timestamp === timestamp ? { ...op, payload: newPayload } : op));
            const updateSettings = (newSettings) => setSettings(prev => ({ ...prev, ...newSettings }));

            return <OrderContext.Provider value={{ orders, loading, syncing, pendingOps, settings, lastSyncTime, refreshData, syncData, addLocalOrder, updateLocalOrder, updateSettings, removePendingOp, updatePendingOp }}>{children}</OrderContext.Provider>;
        };
        

      const Sidebar = ({ activeTab, setActiveTab, isOpen, onClose }) => {
  const { pendingOps, syncData, syncing, lastSyncTime, orders } = useOrders();

  const pendingDispatchCount = useMemo(() => {
    if (!orders) return 0;
    return orders.filter(o => {
      const awb = String(o.awb || "").trim().toUpperCase();
      const status = String(o.trackingStatus || "").trim();
      return awb.endsWith("IN") && status === "Pending";
    }).length;
  }, [orders]);

  const menuItems = [
    { id: "order-entry", label: "Order entry", icon: <LayoutDashboard size={20} /> },
    { id: "track-update", label: "Track and update", icon: <Truck size={20} /> },
    { id: "invoice", label: "Invoice", icon: <FileText size={20} /> },
    { id: "edit-orders", label: "Edit orders", icon: <Edit size={20} /> },
    { id: "settlement", label: "Settlement", icon: <CreditCard size={20} /> },
    { id: "reports", label: "Reports", icon: <BarChart3 size={20} /> },
    { id: "settings", label: "Settings", icon: <Settings size={20} /> },
  ];

  return (
    <>
      {/* MOBILE OVERLAY */}
      {isOpen && (
        <div
          className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-40 md:hidden"
          onClick={onClose}
        />
      )}

      {/* SIDEBAR */}
      <aside
        className={`
          fixed inset-y-0 left-0 z-50 w-72 bg-white border-r border-slate-200
          transform transition-transform duration-300 ease-in-out
          ${isOpen ? "translate-x-0 shadow-2xl" : "-translate-x-full"}
          
          md:relative md:translate-x-0 md:shadow-none
          md:flex md:flex-col md:h-screen md:sticky md:top-0
        `}
      >
        {/* MOBILE CLOSE */}
        <button
          onClick={onClose}
          className="md:hidden absolute top-4 right-4 p-2 rounded-lg text-slate-400 hover:text-slate-700"
        >
          <X size={22} />
        </button>

        {/* LOGO */}
        <div
          className="flex justify-center cursor-pointer p-6"
          onClick={() => window.location.reload()}
        >
          <img
            src="https://www.roshanbags.com/Images/AboutusLogo_roshan.png"
            alt="Logo"
            className="w-[130px]"
          />
        </div>

        {/* TITLE */}
        <div className="px-6 pb-6 pt-2 border-b border-slate-100 flex items-center gap-3">
          <a href="http://admin.roshanbags.com/Home/SellerIndex" target="_blank">
            <div className="bg-gradient-to-br from-indigo-600 to-violet-600 p-2.5 rounded-xl shadow-lg hover:scale-105 transition">
              <Box size={24} className="text-white" />
            </div>
          </a>
          <div>
            <h1 className="font-bold text-slate-800 text-lg leading-tight">
              <a
                href="https://docs.google.com/spreadsheets/d/15nwlV4JBp_JP_K7KWVHXiMJBJ56wa36HFX1tikt5QNI/edit"
                target="_blank"
              >
                Online{" "}
                <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-violet-600">
                  Order Entry
                </span>
              </a>
            </h1>
            <span className="text-[10px] text-slate-400 font-medium">
              Internal Management Tool
            </span>
          </div>
        </div>

        {/* DATA SYNC */}
        <div className="px-4 pt-4">
          <div className="bg-slate-50 border border-slate-200 rounded-xl p-3 shadow-inner">
            <div className="flex justify-between items-center mb-2">
              <span className="text-[10px] font-bold text-slate-500 uppercase">
                Data Sync
              </span>
              {pendingOps.length > 0 ? (
                <span className="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full font-bold flex gap-1">
                  <Upload size={10} /> {pendingOps.length} Pending
                </span>
              ) : (
                <span className="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-bold flex gap-1">
                  <CheckCircle2 size={10} /> Synced
                </span>
              )}
            </div>

            <button
              onClick={syncData}
              disabled={syncing}
              className={`w-full flex items-center justify-center gap-2 py-2.5 rounded-lg text-sm font-bold transition
                ${
                  pendingOps.length > 0
                    ? "bg-gradient-to-r from-indigo-600 to-violet-600 text-white"
                    : "bg-white border border-slate-200 text-slate-600 hover:bg-slate-100"
                }`}
            >
              <RefreshCw size={14} className={syncing ? "animate-spin" : ""} />
              {syncing ? "Syncing..." : "Sync Now"}
            </button>

            {lastSyncTime && (
              <div className="text-[10px] text-center text-slate-400 mt-2">
                Last synced:{" "}
                {lastSyncTime.toLocaleTimeString([], {
                  hour: "2-digit",
                  minute: "2-digit",
                })}
              </div>
            )}
          </div>
        </div>

        {/* MENU */}
        <nav className="flex-1 p-4 space-y-1 overflow-y-auto custom-scrollbar">
          <div className="text-xs font-bold text-slate-400 uppercase mb-3 px-4">
            Main Menu
          </div>

          {menuItems.map(item => (
            <button
              key={item.id}
              onClick={() => {
                setActiveTab(item.id);
                onClose();
              }}
              className={`w-full flex items-center justify-between px-4 py-3 rounded-xl transition
                ${
                  activeTab === item.id
                    ? "bg-indigo-50 text-indigo-700 border border-indigo-100 shadow-sm"
                    : "text-slate-500 hover:bg-slate-50"
                }`}
            >
              <div className="flex items-center gap-3">
                <span
                  className={
                    activeTab === item.id
                      ? "text-indigo-600"
                      : "text-slate-400"
                  }
                >
                  {item.icon}
                </span>
                <span className="text-sm font-medium">{item.label}</span>
              </div>

              {item.id === "settings" && pendingDispatchCount > 0 && (
                <span className="h-5 w-5 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center animate-pulse">
                  {pendingDispatchCount}
                </span>
              )}
            </button>
          ))}

          {/* PURCHASE ENTRY */}
          <a
            href="https://roshanbagsonline-web.github.io/roshan/Online_Stock_Entry"
            target="_blank"
            rel="noopener noreferrer"
            className="flex items-center px-4 pt-4 gap-3 text-emerald-600 hover:opacity-80 border-t border-slate-100 mt-4"
          >
            <Briefcase size={20} />
            <span className="text-sm font-medium">Purchase Entry</span>
          </a>
        </nav>
      </aside>
    </>
  );
};


        const PostOfficeDispatchModal = ({ isOpen, onClose, orders }) => {
            // ... (keep existing logic but update colors if needed inside)
            const [weights, setWeights] = useState({});
            const [step, setStep] = useState(1);
            const [recipientEmail, setRecipientEmail] = useState("thygarayanagarho-dop@nic.in");
            const [pincodeData, setPincodeData] = useState({});
            const [isFetching, setIsFetching] = useState(false);

            // Fetch and logic code remains same ...
             const normalizePincode = (pin) => {
                if (!pin) return null;
                const str = String(pin).replace(/[^0-9]/g, '');
                return str.length === 6 ? str : null;
            };

            const filteredOrders = useMemo(() => {
                return orders.filter((o) => {
                    const bc = String(o.awb || "").trim().toUpperCase();
                    const st = String(o.settleType || "").trim();
                    const status = String(o.trackingStatus || "").trim();
                    return (bc.endsWith("IN") || st === "Post Office") && status === "Pending";
                });
            }, [orders]);

            useEffect(() => {
                if (!isOpen) return;
                const fetchPincodeData = async () => {
                    const uniquePincodes = [...new Set(filteredOrders.map((o) => normalizePincode(o.pincode)).filter((p) => p !== null))];
                    const toFetch = uniquePincodes.filter((p) => !pincodeData[p]);
                    if (toFetch.length === 0) return;
                    setIsFetching(true);
                    const newMap = {};
                    for (const pin of toFetch) {
                        try {
                            const res = await fetch(`https://api.postalpincode.in/pincode/${pin}`);
                            if (res.ok) {
                                const data = await res.json();
                                if (data && data[0].Status === "Success" && data[0].PostOffice && data[0].PostOffice.length > 0) {
                                    const po = data[0].PostOffice[0];
                                    newMap[pin] = po.District || po.Division || po.Block || "";
                                } else { newMap[pin] = ""; }
                            }
                        } catch (e) { console.error("Fetch error", e); }
                        await new Promise(r => setTimeout(r, 250));
                    }
                    setPincodeData(prev => ({ ...prev, ...newMap }));
                    setIsFetching(false);
                };
                fetchPincodeData();
            }, [isOpen, filteredOrders]); 

            if (!isOpen) return null;

            const handleWeightChange = (id, val) => setWeights(prev => ({ ...prev, [id]: val }));
            const handleDownload = () => { /* ... existing download logic ... */ 
                const headers = ["SL", "Barcode", "REF", "City", "Pincode", "Name", "ADD1", "ADD2", "ADD3", "ADDREMAIL", "ADDRMOBILE", "SENDERMOBILE", "Weight", "COD", "InsVal", "VPP", "L", "B", "H", "D", "ArticleShape", "ContentType", "Priority", "AltAddress1", "AltAddress2", "AltAddress3", "AltCity", "AltState", "AltPincode", "DeliveryAddType", "DeliveryTime", "DeliveryDate(YYYYMMDD)", "ReferenceNo", "OtpDelivery(Y/N)", "SpdsDelivery(Y/N)"];
                const rows = filteredOrders.map((o, idx) => {
                    const parts = (o.address || "").split(',').map(s => s.trim()).filter(Boolean);
                    const pinKey = normalizePincode(o.pincode);
                    const city = (pinKey && pincodeData[pinKey]) || o.state || "";
                    const isCOD = o.paymentType === 'Cash On Delivery';
                    const codAmt = isCOD ? Math.round(parseCurrency(o.totalAmount)) : "";
                    return [idx + 1, o.awb || "", o.orderId, city, o.pincode, o.customerName, parts[0] || "", parts[1] || "", parts.slice(2).join(', ') || "", o.email || "", o.contact, "9597495674", weights[o.orderId] || "", codAmt, "", "", "", "", "", "", "Rectangle", "Travel Bag", "Urgent", "", "", "", "", "", "", "", "", "", "", "", "Y"].map(v => `"${String(v).replace(/"/g, '""')}"`).join(",");
                });
                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows].join("\n");
                const link = document.createElement("a"); link.href = encodeURI(csvContent); link.download = `Post_Office_Dispatch_${getLocalDateString(new Date())}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };
            const handleSendMail = () => { /* ... existing mail logic ... */ 
                const subject = "Roshan Bags – Booking Articles"; const dateStr = new Date().toLocaleDateString('en-GB');
                let body = `Date: ${dateStr}\nTotal Articles: ${filteredOrders.length}\n\nArticles List:\n`;
                filteredOrders.forEach((o) => { const isCOD = o.paymentType === 'Cash On Delivery'; body += `- ${o.awb || "No Barcode"} / Ref: ${o.orderId}${isCOD ? ` (COD: Rs. ${Math.round(parseCurrency(o.totalAmount))})` : ""}\n`; });
                window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(recipientEmail)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`, '_blank');
                setStep(1); onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[90vh] animate-in fade-in zoom-in duration-200">
                        <div className="bg-slate-900 text-white p-4 flex justify-between items-center bg-gradient-to-r from-slate-900 to-slate-800">
                            <h3 className="font-bold flex items-center gap-2 text-lg"><Truck size={20} className="text-indigo-400"/> Post Office Dispatch</h3>
                            <button onClick={onClose}><X size={20} className="text-slate-400 hover:text-white transition-colors" /></button>
                        </div>
                        {step === 1 ? (
                            <div className="flex-1 flex flex-col p-6 overflow-hidden bg-slate-50">
                                <div className="mb-4 flex justify-between items-center">
                                    <h4 className="font-bold text-slate-700">Identified Orders ({filteredOrders.length})</h4>
                                    <div className="text-xs text-slate-500 bg-white px-3 py-1 rounded-full shadow-sm border border-slate-200">Only orders with 'Post Office' settle type or AWB ending in 'IN'</div>
                                </div>
                                <div className="flex-1 overflow-auto border border-slate-200 rounded-xl custom-scrollbar bg-white shadow-sm">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 text-slate-500 font-bold text-xs uppercase tracking-wider sticky top-0 z-10 border-b border-slate-200">
                                            <tr><th className="p-3">Ref No</th><th className="p-3">Barcode (AWB)</th><th className="p-3">Customer</th><th className="p-3">City (Fetched) {isFetching && <Loader2 className="inline ml-1 animate-spin" size={12}/>}</th><th className="p-3 w-32">Weight (Kg)</th></tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {filteredOrders.map((o) => {
                                                const pinKey = normalizePincode(o.pincode);
                                                const city = (pinKey && pincodeData[pinKey]) || o.state;
                                                return (
                                                <tr key={o.orderId} className="hover:bg-indigo-50/50 transition-colors">
                                                    <td className="p-3 font-mono text-xs">{o.orderId}</td>
                                                    <td className="p-3 font-mono text-xs font-bold text-indigo-700">{o.awb}</td>
                                                    <td className="p-3 text-xs font-medium text-slate-700">{o.customerName}</td>
                                                    <td className="p-3 text-xs truncate max-w-[200px]" title={o.address}>{city && pinKey && pincodeData[pinKey] ? <span className="text-emerald-700 font-bold">{city}</span> : <span>{city} <span className="text-slate-400 text-[10px] ml-1">{isFetching ? '(Fetching...)' : '(State)'}</span></span>}</td>
                                                    <td className="p-3"><input type="number" step="0.01" className="w-full border border-slate-200 bg-slate-50 focus:bg-white rounded px-2 py-1 text-xs focus:ring-2 focus:ring-indigo-500/20 outline-none" placeholder="0.00" value={weights[o.orderId] || ""} onChange={(e) => handleWeightChange(o.orderId, e.target.value)} /></td>
                                                </tr>
                                            )})}
                                            {filteredOrders.length === 0 && (<tr><td colSpan={5} className="p-8 text-center text-slate-400">No matching orders found.</td></tr>)}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="mt-6 flex justify-between items-center pt-4 border-t border-slate-200">
                                    <div className="text-xs text-slate-500 italic">Please enter weights before downloading.</div>
                                    <div className="flex gap-3">
                                        <button onClick={handleDownload} className="flex items-center gap-2 px-5 py-2.5 bg-emerald-600 hover:bg-emerald-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white rounded-xl font-bold shadow-lg shadow-emerald-200 transition-all" disabled={filteredOrders.length === 0 || isFetching}>{isFetching ? <Loader2 size={16} className="animate-spin" /> : <Download size={16} />} {isFetching ? 'Fetching Cities...' : 'Download Excel'}</button>
                                        <button onClick={() => setStep(2)} className="flex items-center gap-2 px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all" disabled={filteredOrders.length === 0}><Mail size={16} /> Send Mail</button>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="p-12 flex flex-col items-center justify-center space-y-6 bg-white">
                                <div className="bg-indigo-50 p-6 rounded-full text-indigo-600 mb-2 ring-4 ring-indigo-50/50"><Mail size={32} /></div>
                                <h3 className="text-2xl font-bold text-slate-800">Send Dispatch Mail</h3>
                                <div className="w-full max-w-sm"><label className="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">Recipient Email</label><input type="email" className="w-full border border-slate-200 bg-slate-50 rounded-xl px-4 py-3 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="Enter email address..." value={recipientEmail} onChange={(e) => setRecipientEmail(e.target.value)} /></div>
                                <div className="flex gap-4 w-full max-w-sm pt-4"><button onClick={() => setStep(1)} className="flex-1 py-3 text-slate-500 hover:text-slate-800 font-bold hover:bg-slate-50 rounded-xl transition-all">Back</button><button onClick={handleSendMail} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200">Send Now</button></div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };



const getCleanAddress = (address, state, pincode, contact) => {
  if (!address) return "";

  let cleaned = address;

  [state, pincode, contact].forEach(value => {
    if (value) {
      const escaped = value.toString().replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      const regex = new RegExp(`[,\\s]*${escaped}[,\\s]*`, "gi");
      cleaned = cleaned.replace(regex, " ");
    }
  });

  return cleaned.replace(/\s{2,}/g, " ").trim();
};


        const InvoiceTemplate = ({ order, items }) => {
        const [district, setDistrict] = useState("");
        useEffect(() => {
  if (!order?.pincode) return;

  const fetchDistrict = async () => {
    try {
      const res = await fetch(
        `https://api.postalpincode.in/pincode/${order.pincode}`
      );
      const data = await res.json();

      if (
        data[0]?.Status === "Success" &&
        data[0]?.PostOffice?.length
      ) {
        setDistrict(data[0].PostOffice[0].District);
      } else {
        setDistrict("");
      }
    } catch (err) {
      console.error("Pincode API error", err);
      setDistrict("");
    }
  };

  fetchDistrict();
}, [order.pincode]);

            const safeItems = items.map(i => ({ ...i, mrp: Number(i.mrp) || 0, qty: Number(i.qty) || 0, price: Number(i.price) || 0, gstRate: Number(i.gstRate) || 0.18, hsn: i.hsn || '4202' }));
            const totalMrp = safeItems.reduce((sum, item) => sum + (item.mrp * item.qty), 0);
            const totalAmount = safeItems.reduce((sum, item) => sum + item.price, 0);
            const discountValue = totalMrp - totalAmount;
            let totalTaxable = 0; let totalGST = 0;
            const processedItems = safeItems.map(item => { const lineTotal = item.price; let rate = item.gstRate; if (rate > 1) rate = rate / 100; const taxable = lineTotal / (1 + rate); const tax = lineTotal - taxable; totalTaxable += taxable; totalGST += tax; return { ...item, taxable, tax, rate }; });
            const getOrderDateFromId = (orderId, date) => { if (orderId && orderId.startsWith("RB")) { const year = orderId.substring(2, 6); const month = orderId.substring(6, 8); const day = orderId.substring(8, 10); return `${day}-${month}-${year}`; } return formatDate(date); };
            
            const cleanAddress = getCleanAddress(
  order.address,
  order.state,
  order.pincode,
  order.contact
);

            return (  
                <div id="InvoiceTemplate" className="bg-white text-black p-8 max-w-[210mm] mx-auto shadow-2xl my-8 print:shadow-none print:m-0 print:w-full print:max-w-none font-sans">
                    <div className="border-2 border-black">
                        <div className="text-center font-bold border-b-2 border-black text-sm py-1">Tax Invoice</div>
                        <div className="flex justify-between items-start p-4 border-b-2 border-black"><div className="w-1/2"><img src="https://www.roshanbags.com/Images/AboutusLogo_roshan.png" alt="Roshan Bags Logo" className="w-[190px] h-auto" /></div><div className="w-1/2 text-right text-xs font-bold leading-tight"><p>33,SOUTH USMAN ROAD,</p><p>NEAR BUS TERMINUS,T.NAGAR, CHENNAI-600017</p><p>Ph : <span className="text-blue-600">95974 95674</span> E-Mail: info@roshanbags.com</p><p>GST : 33AAIFR7046M1ZT</p></div></div>
                        <div className="flex border-b-2 border-black text-sm"><div className="w-[60%] border-r-2 border-black p-2 space-y-1"><div className="flex"><span className="font-bold w-24 flex-shrink-0">Name :</span> <span className="font-bold uppercase">{order.customerName}</span></div><div className="flex"><span className="font-bold w-24 flex-shrink-0">Address :</span> <span className="break-words w-full text-xs">{cleanAddress}</span></div>
                       <div className="flex">
  <span className="font-bold w-24 flex-shrink-0">Place :</span>
  <span>
    {[district || order.state, order.state ,order.pincode   ]
      .filter(Boolean)
      .join(", ")}
  </span>
</div>

                        
                        <div className="flex"><span className="font-bold w-24 flex-shrink-0">Contact :</span> <span>{order.contact}</span></div></div>
                        
                        <div className="w-[40%]"><div className="flex border-b border-black">
                        <div className="w-1/2 p-2 border-r border-black font-bold">Invoice No</div><div className="w-1/2 p-2 font-bold text-lg">{order.billNo}</div></div><div className="flex border-b border-black"><div className="w-1/2 p-1 px-2 border-r border-black text-xs font-bold">Invocie Date</div><div className="w-1/2 p-1 px-2 text-xs">{formatDate(order.date)}</div></div><div className="flex border-b border-black"><div className="w-1/2 p-1 px-2 border-r border-black text-xs font-bold">Order No</div><div className="w-1/2 p-1 px-2 text-xs text-green-700 font-bold truncate" title={order.orderId}>{order.orderId}</div></div><div className="flex border-b border-black"><div className="w-1/2 p-1 px-2 border-r border-black text-xs font-bold">Order Date</div><div className="w-1/2 p-1 px-2 text-xs">{getOrderDateFromId(order.orderId, order.date)}</div></div><div className="flex"><div className="w-1/2 p-1 px-2 border-r border-black text-xs font-bold">Payment Method</div><div className="w-1/2 p-1 px-2 text-xs">{order.paymentType}</div></div></div></div>
                        <div className="flex bg-[#004c8c] text-white font-bold text-center text-xs border-b border-black print:bg-[#004c8c] print:text-white print:print-color-adjust-exact"><div className="w-[50%] py-2 border-r border-white">Product Details</div><div className="w-[10%] py-2 border-r border-white">Qty</div><div className="w-[15%] py-2 border-r border-white">Taxable Amount</div><div className="w-[13%] py-2 border-r border-white">C Gst + S Gst</div><div className="w-[12%] py-2">Total Price</div></div>
                        <div className="min-h-[300px] text-xs relative">{processedItems.map((item, idx) => { const halfTax = item.tax / 2; const halfRate = (item.rate * 100) / 2; const unitPrice = item.qty > 0 ? item.price / item.qty : 0; const mrp = Number(item.mrp) || 0; const discountPct = mrp > 0 && unitPrice > 0 ? Math.round(((mrp - unitPrice) / mrp) * 100) : 0; return (<div key={idx} className="flex border-b border-dotted border-slate-300 last:border-none"><div className="w-[50%] p-2 border-r border-black flex flex-col justify-center"><span className="font-bold text-sm">{idx + 1} {item.productName}</span><span className="text-[10px] text-slate-600 font-bold mt-0.5">( HSN {item.hsn || '4202'} ), MRP : {mrp} {discountPct > 0 && `(Off : ${discountPct}%)`} Price : {unitPrice.toFixed(0)}</span></div><div className="w-[10%] p-2 border-r border-black flex items-center justify-center font-bold">{item.qty}</div><div className="w-[15%] p-2 border-r border-black flex items-center justify-center">{item.taxable.toFixed(2)}</div><div className="w-[13%] p-2 border-r border-black flex flex-col items-center justify-center text-[10px]"><span>{halfTax.toFixed(2)} + {halfTax.toFixed(2)}</span><span>({halfRate}% + {halfRate}%)</span></div><div className="w-[12%] p-2 flex items-center justify-center font-bold text-sm">{item.price.toFixed(0)}</div></div>); })}</div>
                        <div className="border-t-2 border-black flex print:print-color-adjust-exact"><div className="w-[50%] bg-[#004c8c] text-white text-center font-bold text-lg py-2 flex items-center justify-center print:bg-[#004c8c]">Total</div><div className="w-[10%] bg-[#004c8c] text-white font-bold text-center py-2 border-l border-white flex items-center justify-center print:bg-[#004c8c]">{safeItems.reduce((acc, i) => acc + i.qty, 0)}</div><div className="w-[15%] bg-[#004c8c] text-white font-bold text-center py-2 border-l border-white flex items-center justify-center print:bg-[#004c8c]">{totalTaxable.toFixed(2)}</div><div className="w-[13%] bg-[#004c8c] text-white font-bold text-center py-2 border-l border-white flex items-center justify-center text-xs print:bg-[#004c8c]">{totalGST.toFixed(2)}</div><div className="w-[12%] bg-[#004c8c] text-white font-bold text-center py-2 border-l border-white flex items-center justify-center print:bg-[#004c8c]">{Math.round(totalAmount)}</div></div>
                        <div className="flex border-t border-black text-xs font-bold"><div className="w-[65%] p-4 border-r border-black flex flex-col justify-between bg-slate-50"><div><div className="mb-8 p-2 bg-slate-200 text-center border border-slate-300">Amount In Words :</div><div className="text-center text-sm uppercase font-bold text-slate-800">Rupees {numberToWords(Math.round(totalAmount))} Only</div></div><div className="mt-8 text-[10px] text-slate-500 font-normal italic">Note: This is a system-generated invoice and does not require a signature or company seal.</div></div><div className="w-[35%]"><div className="flex border-b border-black"><div className="w-1/2 p-2 bg-slate-300 text-center">Total Item Value</div><div className="w-1/2 p-2 text-center text-sm">{totalMrp.toFixed(0)}</div></div><div className="flex border-b border-black"><div className="w-1/2 p-2 bg-slate-300 text-center">Discount Value</div><div className="w-1/2 p-2 text-center text-sm">{discountValue.toFixed(0)}</div></div><div className="flex border-b border-black"><div className="w-1/2 p-2 bg-slate-300 text-center">Total Taxable Amount</div><div className="w-1/2 p-2 text-center text-sm">{totalTaxable.toFixed(2)}</div></div><div className="flex border-b border-black"><div className="w-1/2 p-2 bg-slate-300 text-center">GST Amount</div><div className="w-1/2 p-2 text-center text-sm">{totalGST.toFixed(2)}</div></div><div className="flex bg-slate-200 border-b border-black"><div className="w-1/2 p-2 bg-slate-400 text-center text-white">Net Amount</div><div className="w-1/2 p-2 text-center text-lg">{Math.round(totalAmount)}</div></div><div className="p-4 text-right text-blue-900 text-sm mt-2">For ROSHAN</div></div></div>
                    </div>
                </div>
            );
        };

        const PackingSlipTemplate = ({ order, items, settings }) => {
            const shippingLabel = getShippingLabel(settings.shippingMode);
            const isCOD = order.paymentType === 'Cash On Delivery';
            const grandTotal = items.reduce((sum, item) => sum + (Number(item.price) || 0), 0);
            return (
                <div className={`bg-white text-black p-8 mx-auto shadow-xl w-[148mm] min-h-[210mm] border-2 border-dashed border-slate-400 my-8 print:shadow-none print:m-0 print:border-none font-sans text-sm`}>
                    {shippingLabel && ( <div className="text-center border-2 border-black p-2 mb-4 font-bold text-sm break-words bg-slate-100">{shippingLabel}</div> )}
                    <div className="text-center mb-4 pb-4 border-b border-black"><h1 className="text-2xl font-bold uppercase text-[#201C4F] flex justify-center"><img src="https://www.roshanbags.com/Images/AboutusLogo_roshan.png" alt="Roshan Bags Logo" className="w-[140px] h-auto" /></h1><p className="text-xs font-mono mt-1">Order #{order.orderId}</p>{settings.weight && <p className="text-sm font-bold mt-1 border border-black inline-block px-2 py-0.5 rounded">Weight: {settings.weight} Kgs </p>}</div>
                    <div className="mb-4 pb-4 border-b border-dashed border-slate-400"><div className="font-bold text-xs uppercase text-slate-500 mb-1">Sold By:</div><div className="font-bold text-lg text-[#2a3b8f]">ROSHAN</div><div className="text-xs">33, South Usman Road, Near Bus Terminus</div><div className="text-xs">T.Nagar, Chennai - 600017</div><div className="text-xs mt-1">Ph: 95974 95674</div></div>
                    <div className="mb-4 border-b border-dashed border-slate-400 pb-4"> <div className="flex items-center gap-1"><Truck size={16} className="text-slate-500 mb-1" /><span className="font-bold text-xs uppercase text-slate-500">Deliver To:</span></div><div className="font-bold uppercase text-base text-slate-900 text-lg">{order.customerName}</div><div className="whitespace-pre-wrap mt-1 leading-tight font-bold text-black-900 text-lg">{order.address}</div><div className="mt-1 font-bold text-lg">{order.state} {order.pincode ? `- ${order.pincode}` : ''}</div><div className="mt-2 font-bold text-lg">Ph: {order.contact}</div></div>
                    
                    {isCOD && ( <div className="border-2 border-black p-2 text-center bg-green-100 mt-2"><div className="font-extrabold text-lg">COD Collectable Amount</div><div className="font-extrabold text-3xl mt-1">Rs. {Math.round(grandTotal)}</div></div> )}
                    {settings.showItems && ( <div className="mb-4"><table className="w-full text-left text-xs"><thead className="border-b-2 border-black"><tr><th className="py-2 text-slate-700 text-sm">Item Description</th><th className="py-2 text-right text-slate-600">Qty</th></tr></thead><tbody>{items.map((item, idx) => (<tr key={idx} className="border-b border-slate-800"><td className="py-2 pr-2"><div className="font-bold text-black text-sm">{item.productName}</div><div className="text-[12px] text-slate-800 font-bold">SKU: {item.hsn || '-'}</div></td><td className="py-2 text-right font-bold text-black text-sm">{Number(item.qty) || 0}</td></tr>))}</tbody></table></div> )}
                    <div className="flex justify-between items-center pt-2 border-t-2 border-black font-bold text-base mb-2"><span>Order Value:</span><span>Rs. {Math.round(grandTotal)}</span></div>
                    
                    <div className="mt-8 text-center text-[10px] border-t pt-2">Thank you for shopping with Roshan!</div>
                </div>
            );
        };




const OrderInfoGrid = ({ selectedOrder }) => {
            const cardStyle = { background: "linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%)", border: "1px solid #e5e7eb", borderRadius: "12px", padding: "14px 18px", minWidth: "180px", flex: "0 0 auto", display: "flex", flexDirection: "column", boxShadow: "0 2px 6px rgba(0,0,0,0.04)" };
            const labelStyle = { fontSize: "14px", fontWeight:600, color: "#BF00FF", letterSpacing: "0.04em", textTransform: "uppercase", marginBottom: "6px" };
            const valueStyle = { fontSize: "15px", fontWeight: 700, color: "#0f172a", letterSpacing: "0.3px", whiteSpace: "nowrap", background: "#eef2ff", padding: "6px 10px", borderRadius: "6px", display: "inline-block" };
            const formatDisplayDate = (value) => { if (!value) return ""; const d = new Date(value); if (isNaN(d)) return ""; return d.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" }); };
            return (
                <div className="flex gap-4 overflow-x-auto pb-2">
                    <div style={cardStyle}><span style={labelStyle}>Date</span><span style={valueStyle}>{formatDisplayDate(selectedOrder.date)}</span></div>
                    <div style={cardStyle}><span style={labelStyle}>Order ID</span><span style={valueStyle}>{selectedOrder.orderId}</span></div>
                    <div style={cardStyle}><span style={labelStyle}>Bill No</span><span style={valueStyle}>{selectedOrder.billNo}</span></div>
                </div>
            );
        };

        const EditOrdersPage = () => {
            const { orders, loading, updateLocalOrder } = useOrders();
            const [searchTerm, setSearchTerm] = useState("");
            const [searchResults, setSearchResults] = useState([]);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [selectedOrderItems, setSelectedOrderItems] = useState([]);
            const [fromDate, setFromDate] = useState("");
            const [toDate, setToDate] = useState("");
            
            useEffect(() => { 
                const today = new Date(); const past = new Date(); past.setMonth(today.getMonth() - 3); 
                setToDate(getLocalDateString(today)); setFromDate(getLocalDateString(past)); 
            }, []);
            
            const cleanDate = (v) => {
  if (!v) return "";
  return String(v).split("T")[0];
};

            const normalizeDate = (value) => {
                if (!value) return "";
                if (/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
                const d = new Date(value);
                if (isNaN(d.getTime())) return "";
                const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            useEffect(() => {
                if (!searchTerm.trim()) { setSearchResults([]); return; }
                const lowerTerm = searchTerm.toLowerCase();
                const dateFiltered = orders.filter(order => {
                    if (!fromDate || !toDate) return true;
                    if (!order.date) return false;
                    const oDate = parseDate(order.date);
                    const start = parseDate(fromDate); const end = parseDate(toDate);
                    return oDate >= start && oDate <= end;
                });
                const grouped = new Map();
                dateFiltered.forEach(order => {
                    if (!order.orderId) return;
                    if (order.orderId.toLowerCase().includes(lowerTerm) || (order.customerName && order.customerName.toLowerCase().includes(lowerTerm)) || (order.contact && String(order.contact).includes(lowerTerm)) || (order.billNo && order.billNo.toLowerCase().includes(lowerTerm))) {
                        if (!grouped.has(order.orderId)) grouped.set(order.orderId, order);
                    }
                });
                setSearchResults(Array.from(grouped.values()).slice(0, 10));
            }, [searchTerm, orders, fromDate, toDate]);

            const splitByPipe = (val = "") => String(val).split("|").map(v => v.trim()).filter(Boolean);
            const joinByPipe = (arr = []) => arr.map(v => v || "").join(" | ");

            const normalizeSettlementParts = (value, length) => {
                const result = Array.from({ length: length || 1 }, () => "");
                if (!value) return result;
                const str = String(value);
                if (str.includes("|")) {
                    const parts = str.split("|").map(v => v.trim());
                    for (let i = 0; i < length; i++) result[i] = parts[i] || "";
                } else { result[0] = str; }
                return result;
            };

            const handleSelectOrder = (order) => {
                const baseId = order.orderId.includes("Q") ? order.orderId.split("Q")[0] : order.orderId;
                const items = orders
                    .filter(o => o.orderId === baseId || o.orderId?.startsWith(baseId + "Q"))
                    .map(i => ({ ...i, date: normalizeDate(i.date) }))
                    .sort((a,b) => a.orderId.length - b.orderId.length || a.orderId.localeCompare(b.orderId));
                const main = items.find(i => i.orderId === baseId) || items[0];
                const settleTypes = splitByPipe(main.settleType);
                const len = Math.max(settleTypes.length, 1); 
                setSelectedOrder({
                    ...main,
                    settledDateParts: normalizeSettlementParts(
  cleanDate(main.settledDate),
  len
),

                    settledAmountParts: normalizeSettlementParts(main.settledAmount, len),
                    settledUtrParts: normalizeSettlementParts(main.settledUtr, len),
                    paidUtrParts: normalizeSettlementParts(main.paidUtr, len)
                });
                setSelectedOrderItems(items); setSearchResults([]); setSearchTerm("");
            };

            const handleChange = (field, value) => {
                if (!selectedOrder) return;
                const safe = field === "date" ? normalizeDate(value) : value;
                setSelectedOrder(prev => {
                    let u = { ...prev, [field]: safe };
                    if (field === "settleType") {
                        const len = splitByPipe(value).length || 1;
                        u.settledDateParts = normalizeSettlementParts(u.settledDate, len);
                        u.settledAmountParts = normalizeSettlementParts(u.settledAmount, len);
                        u.settledUtrParts = normalizeSettlementParts(u.settledUtr, len);
                        u.paidUtrParts = normalizeSettlementParts(u.paidUtr, len);
                    }
                    return u;
                });
                const syncFields = ["date","customerName","contact","address","pincode","state","email","paymentType","trackingStatus","awb","settleType","barcode","settlementCharge"];
                if (syncFields.includes(field)) { setSelectedOrderItems(p => p.map(i => ({ ...i, [field]: safe }))); }
            };

            const handleItemChange = (index, field, value) => { 
                const newItems = [...selectedOrderItems]; 
                newItems[index] = { ...newItems[index], [field]: value }; 
                if (['mrp', 'discount', 'qty'].includes(field)) {
                    const m = parseFloat(newItems[index].mrp) || 0; const d = parseFloat(newItems[index].discount) || 0; const q = parseFloat(newItems[index].qty) || 0;
                    newItems[index].price = Math.round((m / 100) * (100 - d) * q);
                }
                const totalQty = newItems.reduce((sum, item) => sum + (parseFloat(item.qty) || 0), 0);
                const grandTotal = newItems.reduce((sum, item) => sum + (parseFloat(item.price) || 0), 0);
                newItems.forEach(item => {
                    const isMainOrder = !item.orderId?.includes("Q");
                    if (isMainOrder) { item.totalQty = totalQty; item.totalAmount = grandTotal; } 
                    else { item.totalQty = ""; item.totalAmount = ""; item.barcode = ""; item.email = ""; }
                });
                setSelectedOrderItems(newItems); 
            };
            
            const handleSave = () => {
                if (!selectedOrder) return;
                const sd = joinByPipe(selectedOrder.settledDateParts);
                const sa = joinByPipe(selectedOrder.settledAmountParts);
                const su = joinByPipe(selectedOrder.settledUtrParts);
                const pu = joinByPipe(selectedOrder.paidUtrParts);
                selectedOrderItems.forEach(item => {
                    const isMain = !item.orderId.includes("Q");
                    updateLocalOrder(item.orderId, isMain ? { ...item, date: normalizeDate(item.date), settleType: selectedOrder.settleType, settledDate: sd, settledAmount: sa, settledUtr: su, paidUtr: pu } : { orderId: item.orderId, productName: item.productName, mrp: item.mrp, discount: item.discount, price: item.price, qty: item.qty, gstRate: item.gstRate, hsn: item.hsn, trackingStatus: item.trackingStatus === "Cancel" ? "Cancel" : "" });
                });
                alert("Changes saved locally. Don't forget to Sync!");
            };

            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const toDateInput = (val) => {
                if (!val) return "";
                const cleanVal = String(val).trim();
                if (/^\d{4}-\d{2}-\d{2}$/.test(cleanVal)) return cleanVal;
                const dmyMatch = cleanVal.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                if (dmyMatch) { const [_, d, m, y] = dmyMatch; return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`; }
                const dMonYMatch = cleanVal.match(/^(\d{1,2})\/([A-Za-z]{3})\/(\d{4})$/);
                if (dMonYMatch) { const [_, d, mon, y] = dMonYMatch; const mIndex = months.findIndex(m => m.toLowerCase() === mon.toLowerCase()); if (mIndex !== -1) { const m = String(mIndex + 1).padStart(2, '0'); return `${y}-${m}-${d.padStart(2, '0')}`; } }
                const d = new Date(cleanVal); if (!isNaN(d.getTime())) { const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
                return "";
            };
            const fromDateInput = (val) => { if (!val) return ""; const parts = val.split("-"); if (parts.length !== 3) return val; const [y, m, d] = parts; return `${d}/${m}/${y}`; };

          return (
                <div className="w-full max-w-[1600px] mx-auto p-6 space-y-6 h-full flex flex-col bg-slate-50/50">
                    <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-xl shadow-slate-200/40 relative z-[60]">
                        <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                            <div className="flex items-center gap-4"><div className="p-3 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-100 text-white"><Edit size={24} /></div><div><h1 className="text-2xl font-black text-slate-800 tracking-tight">Order <span className="text-indigo-600">Editor</span></h1><p className="text-slate-400 text-xs font-bold uppercase tracking-widest">Update existing order records</p></div></div>
                            <div className="flex flex-col md:flex-row gap-4 w-full lg:w-auto"><div className="flex items-center gap-3 bg-white px-4 py-2.5 rounded-2xl border border-slate-200 shadow-sm focus-within:border-indigo-400 focus-within:ring-4 focus-within:ring-indigo-500/10 transition-all"><CalendarDays size={18} className="text-slate-400" /><input type="date" className="bg-transparent text-xs outline-none text-slate-700 font-bold w-32" value={fromDate} onChange={e => setFromDate(e.target.value)} /><span className="text-slate-300 font-bold">to</span><input type="date" className="bg-transparent text-xs outline-none text-slate-700 font-bold w-32" value={toDate} onChange={e => setToDate(e.target.value)} /></div>
                                <div className="relative w-full md:w-96 group"><input type="text" className="w-full pl-12 pr-4 py-3 bg-white border border-slate-200 rounded-2xl focus:border-indigo-400 focus:ring-4 focus:ring-indigo-500/10 outline-none text-slate-800 placeholder-slate-400 transition-all shadow-sm font-medium" placeholder="Order ID, Bill No, Name, Mobile..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /><Search className="absolute left-4 top-3.5 text-slate-400 group-focus-within:text-indigo-500 transition-colors" size={20} />{loading && <Loader2 className="absolute right-4 top-3.5 text-indigo-500 animate-spin" size={20} />}
                                    {searchResults.length > 0 && (
                                        <div className="absolute top-full left-0 right-0 mt-3 bg-white rounded-2xl border border-slate-200 shadow-2xl p-2 z-[100] animate-in fade-in slide-in-from-top-2 duration-200">
                                            {searchResults.map((res, idx) => (
                                                <button key={idx} onClick={() => handleSelectOrder(res)} className="w-full text-left px-4 py-3 hover:bg-indigo-50 rounded-xl transition-all flex justify-between items-center group mb-1 border border-transparent hover:border-indigo-100"><div><div className="font-black text-slate-800 text-sm flex items-center gap-3">{res.orderId}<span className="text-[10px] font-bold text-slate-400 px-2 py-0.5 bg-slate-50 border border-slate-200 rounded-lg group-hover:bg-white transition-colors">{res.date ? formatDate(res.date) : 'No Date'}</span></div><div className="text-xs text-slate-500 mt-1 font-medium">{res.customerName} <span className="mx-1 text-slate-300">|</span> {res.contact}</div></div><div className="text-right"><div className="text-xs font-black text-indigo-600 bg-indigo-50/50 px-3 py-1 rounded-xl border border-indigo-100/50 group-hover:bg-indigo-100 transition-colors">{res.billNo}</div></div></button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {selectedOrder ? (
                        <div className="flex-1 overflow-hidden flex flex-col min-h-0 bg-white rounded-[2.5rem] border border-slate-200 shadow-2xl relative">
                            <div className="sticky top-0 bg-white/80 backdrop-blur-xl border-b border-slate-100 p-6 flex justify-between items-center z-40">
                                <div className="flex items-center gap-6"><div className="flex -space-x-2"><div className="w-10 h-10 rounded-full bg-indigo-600 border-4 border-white flex items-center justify-center text-white font-black text-xs shadow-lg">ID</div><div className="w-10 h-10 rounded-full bg-emerald-600 border-4 border-white flex items-center justify-center text-white font-black text-xs shadow-lg">CS</div><div className="w-10 h-10 rounded-full bg-violet-600 border-4 border-white flex items-center justify-center text-white font-black text-xs shadow-lg">TR</div></div><div><div className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-0.5">Editing Record</div><h3 className="text-xl font-black text-slate-800 tracking-tight">{selectedOrder.orderId} <span className="text-slate-300 mx-2 font-normal">/</span> <span className="text-indigo-600">{selectedOrder.billNo}</span></h3></div></div>
                                <div className="flex items-center gap-4"><div className="bg-slate-50 px-4 py-2 rounded-2xl border border-slate-200 flex items-center gap-3"><span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span><span className="text-xs font-black text-slate-600 uppercase tracking-widest">{selectedOrder.trackingStatus || 'Active'}</span></div><button onClick={handleSave} className="flex items-center gap-2 px-8 py-3.5 bg-slate-900 hover:bg-black text-white rounded-2xl font-black text-sm shadow-xl shadow-slate-200 transition-all active:scale-95 group"><Save size={18} className="group-hover:scale-110 transition-transform" />Commit Changes</button></div>
                            </div>

                            <div className="flex-1 overflow-y-auto custom-scrollbar p-8 space-y-10">
                                <section><div className="flex items-center gap-2 mb-6"><div className="w-1 h-6 bg-indigo-500 rounded-full"></div><h4 className="text-xs font-black text-slate-500 uppercase tracking-[0.3em]">Master Records</h4></div><OrderInfoGrid selectedOrder={selectedOrder} /></section>
                                <div className="grid grid-cols-1 lg:grid-cols-12 gap-10">
                                    <div className="lg:col-span-4 space-y-10">
                                        <section className="bg-slate-50/50 p-6 rounded-3xl border border-slate-100"><div className="flex items-center gap-3 mb-6"><div className="p-2 bg-indigo-100 text-indigo-600 rounded-xl"><User size={20} /></div><h4 className="font-black text-slate-800">Customer Identity</h4></div><div className="space-y-4"><InputGroup label="D - Name" value={selectedOrder.customerName} onChange={(v) => handleChange("customerName", v)} /><InputGroup label="E - Contact" value={selectedOrder.contact} onChange={(v) => handleChange("contact", v)} /><InputGroup label="Y - Email" value={selectedOrder.email} onChange={(v) => handleChange("email", v)} /><div className="grid grid-cols-2 gap-4"><InputGroup label="G - Pincode" value={selectedOrder.pincode} onChange={(v) => handleChange("pincode", v)} /><InputGroup label="H - State" value={selectedOrder.state} onChange={(v) => handleChange("state", v)} /></div><div><label className="block text-xs font-black text-slate-500 mb-1.5 uppercase tracking-wider">F - Full Address</label><textarea className="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm text-slate-800 outline-none focus:border-indigo-400 focus:ring-4 focus:ring-indigo-500/5 transition-all resize-none h-32 shadow-sm font-medium" value={selectedOrder.address || ""} onChange={(e) => handleChange("address", e.target.value)} /></div></div></section>
                                        <section className="bg-slate-50/50 p-6 rounded-3xl border border-slate-100"><div className="flex items-center gap-3 mb-6"><div className="p-2 bg-violet-100 text-violet-600 rounded-xl"><Truck size={20} /></div><h4 className="font-black text-slate-800">Logistics Flow</h4></div><div className="space-y-4"><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-black text-slate-500 mb-1.5 uppercase tracking-wider">I - Method</label><select className="w-full bg-white border border-slate-200 rounded-xl px-3 py-2.5 text-xs font-bold text-slate-700 outline-none focus:border-indigo-400 transition-all shadow-sm" value={selectedOrder.paymentType} onChange={(e) => handleChange('paymentType', e.target.value)}><option value="Online Payment">Online Payment</option><option value="Cash On Delivery">Cash On Delivery</option></select></div><div><label className="block text-xs font-black text-slate-500 mb-1.5 uppercase tracking-wider">Z - Status</label><select className="w-full bg-white border border-slate-200 rounded-xl px-3 py-2.5 text-xs font-bold text-slate-700 outline-none focus:border-indigo-400 transition-all shadow-sm" value={selectedOrder.trackingStatus} onChange={(e) => handleChange('trackingStatus', e.target.value)}><option value="Pending">Pending</option><option value="Packed">Packed</option><option value="Shipped">Shipped</option><option value="In Transit">In Transit</option><option value="Delivered">Delivered</option><option value="Return">Return</option><option value="Cancel">Cancel</option></select></div></div><InputGroup label="W - AWB Tracking" value={selectedOrder.awb} onChange={(v) => handleChange('awb', v)} /><InputGroup label="AA - Parcel Barcode" value={selectedOrder.barcode} onChange={(v) => handleChange('barcode', v)} /></div></section>
                                    </div>
                                    <div className="lg:col-span-8 space-y-10">
                                        <section><div className="flex items-center justify-between mb-6"><div className="flex items-center gap-3"><div className="p-2 bg-emerald-100 text-emerald-600 rounded-xl"><Package size={20} /></div><h4 className="font-black text-slate-800">Product Line Items</h4></div><div className="text-xs font-black text-slate-400 uppercase tracking-widest">{selectedOrderItems.length} Entries</div></div><div className="border border-slate-200 rounded-[2rem] overflow-hidden shadow-xl shadow-slate-200/20"><div className="overflow-x-auto"><table className="w-full text-sm text-left border-collapse"><thead className="bg-slate-900 text-slate-300 font-bold text-[10px] uppercase tracking-[0.2em]"><tr><th className="px-6 py-5 w-12 text-center">#</th><th className="px-6 py-5 min-w-[250px]">Product Description</th><th className="px-6 py-5 w-32">HSN</th><th className="px-6 py-5 w-24 text-right">MRP</th><th className="px-6 py-5 w-20 text-right">Disc%</th><th className="px-6 py-5 w-24 text-right">Qty</th><th className="px-6 py-5 w-32 text-right">Subtotal</th></tr></thead><tbody className="divide-y divide-slate-100">{selectedOrderItems.map((item, idx) => (<tr key={idx} className="hover:bg-slate-50 transition-colors group"><td className="px-6 py-4 text-center text-[10px] font-black text-slate-400">{idx + 1}</td><td className="px-6 py-4"><input type="text" className="w-full bg-transparent outline-none font-bold text-slate-800 focus:text-indigo-600 transition-colors" value={item.productName} onChange={(e) => handleItemChange(idx, 'productName', e.target.value)} placeholder="Product title..." /><div className="text-[10px] font-black text-slate-300 uppercase mt-1 tracking-widest">{item.orderId}</div></td><td className="px-6 py-4"><input type="text" className="w-full bg-transparent outline-none font-mono text-xs text-slate-500 font-bold" value={item.hsn} onChange={(e) => handleItemChange(idx, 'hsn', e.target.value)} /></td><td className="px-6 py-4"><input type="number" className="w-full bg-transparent outline-none text-right font-black text-slate-600" value={item.mrp} onChange={(e) => handleItemChange(idx, 'mrp', e.target.value)} /></td><td className="px-6 py-4"><input type="number" className="w-full bg-transparent outline-none text-right font-black text-slate-400" value={item.discount} onChange={(e) => handleItemChange(idx, 'discount', e.target.value)} /></td><td className="px-6 py-4"><input type="number" className="w-full bg-transparent outline-none text-right font-black text-indigo-600" value={item.qty} onChange={(e) => handleItemChange(idx, 'qty', e.target.value)} /></td><td className="px-6 py-4 text-right"><span className="font-black text-slate-900">₹{parseFloat(item.price || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</span></td></tr>))}</tbody><tfoot className="bg-slate-50 border-t border-slate-200"><tr><td colSpan={5} className="px-6 py-5 text-right font-black text-slate-400 text-[10px] uppercase tracking-widest">Grand Totals</td><td className="px-6 py-5 text-right font-black text-slate-900">{selectedOrderItems.reduce((acc, i) => acc + (parseFloat(i.qty) || 0), 0)}</td><td className="px-6 py-5 text-right font-black text-indigo-600 text-lg">₹{selectedOrderItems.reduce((acc, i) => acc + (parseFloat(i.price) || 0), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr></tfoot></table></div></div></section>
                                        
                                        <section className="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-xl shadow-slate-200/30">
                                            <div className="flex items-center justify-between mb-8"><div className="flex items-center gap-3"><div className="p-2 bg-amber-100 text-amber-600 rounded-xl"><CreditCard size={20} /></div><h4 className="font-black text-slate-800 text-lg">Settlement Matrix</h4></div><div className="w-72"><label className="block text-[10px] font-black text-slate-400 mb-1.5 uppercase tracking-widest">V – Platform Category</label><MultiSelectDropdown options={SETTLEMENT_OPTIONS} value={selectedOrder.settleType} onChange={(v) => handleChange("settleType", v)} /></div></div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                                <div className="space-y-4">
                                                    <div className="bg-blue-50 text-blue-700 border border-blue-200 px-3 py-2 rounded-xl text-[11px] font-black uppercase tracking-widest">AF – Settled Dates</div>
                                                    {selectedOrder.settledDateParts?.map((val, idx) => (
                                                        <div key={idx} className="flex flex-col gap-1"><span className="text-[10px] font-black text-blue-600 ml-1">{selectedOrder.settleType?.split("|")[idx]?.trim() || `Entry ${idx + 1}`}</span><input type="date" value={toDateInput(val)} onChange={(e) => { const updated = [...selectedOrder.settledDateParts]; updated[idx] = fromDateInput(e.target.value); setSelectedOrder(prev => ({ ...prev, settledDateParts: updated })); }} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-xs font-bold outline-none focus:bg-white focus:border-blue-400 transition-all" /></div>
                                                    ))}
                                                </div>
                                                <div className="space-y-4">
                                                    <div className="bg-emerald-50 text-emerald-700 border border-emerald-200 px-3 py-2 rounded-xl text-[11px] font-black uppercase tracking-widest">AG – Amounts (₹)</div>
                                                    {selectedOrder.settledAmountParts?.map((val, idx) => (
                                                        <div key={idx} className="flex flex-col gap-1"><span className="text-[10px] font-black text-emerald-600 ml-1">Amount</span><input type="number" value={val} onChange={(e) => { const updated = [...selectedOrder.settledAmountParts]; updated[idx] = e.target.value; setSelectedOrder(prev => ({ ...prev, settledAmountParts: updated })); }} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-xs font-black text-right outline-none focus:bg-white focus:border-emerald-400 transition-all" placeholder="0.00" /></div>
                                                    ))}
                                                </div>
                                                <div className="space-y-4">
                                                    <div className="bg-violet-50 text-violet-700 border border-violet-200 px-3 py-2 rounded-xl text-[11px] font-black uppercase tracking-widest">AH – Settled UTR</div>
                                                    {selectedOrder.settledUtrParts?.map((val, idx) => (
                                                        <div key={idx} className="flex flex-col gap-1"><span className="text-[10px] font-black text-violet-500 ml-1">{selectedOrder.settleType?.split("|")[idx]?.trim() || "Transaction"}</span><input type="text" value={val} onChange={(e) => { const updated = [...selectedOrder.settledUtrParts]; updated[idx] = e.target.value; setSelectedOrder(prev => ({ ...prev, settledUtrParts: updated })); }} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-xs font-mono font-bold outline-none focus:bg-white focus:border-violet-400 transition-all" placeholder="UTR / Ref No" /></div>
                                                    ))}
                                                </div>
                                                <div className="space-y-4">
                                                    <div className="bg-orange-50 text-orange-700 border border-orange-200 px-3 py-2 rounded-xl text-[11px] font-black uppercase tracking-widest">T – Paid UTR</div>
                                                    {selectedOrder.paidUtrParts?.map((val, idx) => (
                                                        <div key={idx} className="flex flex-col gap-1"><span className="text-[10px] font-black text-orange-500 ml-1">Payment Ref {idx + 1}</span><input type="text" value={val} onChange={(e) => { const updated = [...selectedOrder.paidUtrParts]; updated[idx] = e.target.value; setSelectedOrder(prev => ({ ...prev, paidUtrParts: updated })); }} className="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-xs font-mono font-bold outline-none focus:bg-white focus:border-orange-400 transition-all" placeholder="Paid UTR" /></div>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="mt-8 pt-8 border-t border-slate-100 flex justify-between items-center"><div className="flex items-center gap-4"><span className="text-xs font-black text-slate-400 uppercase tracking-widest">Settled Charges</span><input type="number" className="w-32 bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-sm font-black text-red-600 outline-none focus:bg-white text-right" value={selectedOrder.settlementCharge} onChange={(e) => handleChange("settlementCharge", e.target.value)} /></div><div className="text-right"><div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Cumulative Settlement</div><div className="text-2xl font-black text-emerald-600">₹{selectedOrder.settledAmountParts?.reduce((a, b) => a + (parseFloat(b) || 0), 0).toLocaleString("en-IN", { minimumFractionDigits: 2 })}</div></div></div>
                                        </section>
                                    </div>
                                </div>
                                <div className="h-10"></div>
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 flex flex-col items-center justify-center bg-white rounded-[3rem] border border-slate-200 shadow-xl relative overflow-hidden"><div className="absolute inset-0 opacity-[0.03] pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div><div className="p-10 bg-indigo-50 rounded-[3rem] text-indigo-200 mb-8 animate-pulse shadow-inner border border-indigo-100/50"><Search size={120} strokeWidth={1} /></div><h2 className="text-3xl font-black text-slate-800 tracking-tight">Waiting for Input</h2><p className="text-slate-400 font-bold mt-2 max-w-xs text-center leading-relaxed">Search and select an order from the bar above to begin modifications.</p><div className="mt-10 flex gap-4"><div className="flex items-center gap-2 px-4 py-2 bg-white rounded-full border border-slate-100 shadow-sm text-[10px] font-black text-slate-400 uppercase tracking-widest"><Check size={14} /> Full Edit Access</div><div className="flex items-center gap-2 px-4 py-2 bg-white rounded-full border border-slate-100 shadow-sm text-[10px] font-black text-slate-400 uppercase tracking-widest"><Check size={14} /> Split Settlements</div><div className="flex items-center gap-2 px-4 py-2 bg-white rounded-full border border-slate-100 shadow-sm text-[10px] font-black text-slate-400 uppercase tracking-widest"><Check size={14} /> Live Sync</div></div></div>
                    )}
                </div>
            );
        };

        const InvoicePage = () => {
            const { orders: allRows, loading } = useOrders();
            const [groupedOrders, setGroupedOrders] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [viewMode, setViewMode] = useState("invoice");
            const [filterType, setFilterType] = useState('specific');
            const [specificDate, setSpecificDate] = useState(() => getLocalDateString(new Date())); // Fix default date
            const [packingSettings, setPackingSettings] = useState({ shippingMode: 'Normal', weight: '', showItems: true });
            const [showSettingsPanel, setShowSettingsPanel] = useState(false);
            const [showEditPanel, setShowEditPanel] = useState(false);
            const [editableOrder, setEditableOrder] = useState(null);

            useEffect(() => {
                if (allRows.length === 0) { setGroupedOrders([]); return; }
                const groups = {};
                allRows.forEach(row => {
                    const key = row.parentId || row.orderId;
                    if (!key) return;
                    if (!groups[key]) { groups[key] = { order: { ...row, orderId: key }, items: [] }; } 
                    else { const grpOrder = groups[key].order; if (!grpOrder.pincode && row.pincode) grpOrder.pincode = row.pincode; if (!grpOrder.state && row.state) grpOrder.state = row.state; if (!grpOrder.address && row.address) grpOrder.address = row.address; }
                    groups[key].items.push({ productName: row.productName || "Item", mrp: row.mrp, price: row.price, qty: row.qty, gstRate: row.gstRate, hsn: row.hsn, discount: row.discount });
                });

                // --- START: NEW SORTING LOGIC ---
                const getSortableNumber = (order) => {
                    // Prefer invoiceNo, fall back to orderId
                    const idString = order.invoiceNo || order.orderId || "";
                    
                    // Split by '/', take the last part (the number), and parse it as an integer
                    const parts = idString.split('/');
                    const numericPart = parts[parts.length - 1];
                    
                    // Convert to an integer. If conversion fails, default to 0.
                    return parseInt(numericPart, 10) || 0; 
                };

               setGroupedOrders(
    Object.values(groups).sort((a, b) => {
        // Get the numeric part for comparison
        const numA = getSortableNumber(a.order);
        const numB = getSortableNumber(b.order);

        // Ascending numerical sort
        return numA - numB;
    })
);
                // --- END: NEW SORTING LOGIC ---


            }, [allRows]);
            const filteredOrders = useMemo(() => {
                let filtered = groupedOrders;
                if (filterType === 'recent') { const today = new Date(); const fiveDaysAgo = new Date(); fiveDaysAgo.setDate(today.getDate() - 5); fiveDaysAgo.setHours(0, 0, 0, 0); filtered = filtered.filter(g => { const orderDate = parseDate(g.order.date); return orderDate && orderDate >= fiveDaysAgo; }); }
                else if (filterType === 'specific' && specificDate) { filtered = filtered.filter(g => { const orderDate = parseDate(g.order.date); return orderDate && orderDate.toLocaleDateString('en-CA') === specificDate; }); }
                if (searchTerm) { const lowerTerm = searchTerm.toLowerCase(); filtered = filtered.filter(g => (g.order.orderId?.toLowerCase().includes(lowerTerm)) || (g.order.customerName?.toLowerCase().includes(lowerTerm)) || (g.order.billNo?.toLowerCase().includes(lowerTerm))); }
                return filtered;
            }, [groupedOrders, searchTerm, filterType, specificDate]);
            useEffect(() => { if (selectedOrder) { setEditableOrder(selectedOrder.order); setPackingSettings(prev => ({...prev, weight: ''})); } }, [selectedOrder]);
            const handlePrint = () => window.print();
            const handleEditChange = (field, value) => { if (editableOrder) setEditableOrder({ ...editableOrder, [field]: value }); };
            
            const handleDownload = async () => {
    const invoice = document.getElementById("InvoiceTemplate");
    if (!invoice || !selectedOrder) return;
    const fileName = `${selectedOrder.order.orderId}.pdf`;
    const height = invoice.offsetHeight;
    const maxHeight = 1100; // Approx A4 printable height in px
    let scaleFactor = 1;
    if (height > maxHeight) { scaleFactor = maxHeight / height; invoice.style.transform = `scale(${scaleFactor})`; }
    const opt = { margin: 0, filename: fileName, image: { type: 'jpeg', quality: 1 }, html2canvas: { scale: 3, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
    await html2pdf().set(opt).from(invoice).save();
    invoice.style.transform = "scale(1)";
};

           
            return (
                <div className="w-full max-w-[1600px] mx-auto p-4 md:p-8 h-[calc(100vh-4rem)] flex flex-col">
                    <div className="print:hidden space-y-6 flex-1 flex flex-col min-h-0"><div className="flex flex-col md:flex-row justify-between items-end md:items-center bg-white p-6 rounded-2xl border border-slate-200 shadow-sm gap-6"><div className="flex items-center gap-4"><div className="bg-gradient-to-br from-indigo-600 to-violet-600 p-3 rounded-xl text-white shadow-lg shadow-indigo-200"><FileText size={26} /></div><div><h1 className="text-2xl font-bold text-slate-800">Invoice <span className="text-indigo-600">Generator</span></h1><p className="text-slate-500 text-sm">Print Tax Invoices & Packing Slips</p></div></div><div className="flex flex-wrap items-center gap-3"><div className="flex items-center gap-2 bg-slate-50 p-1.5 rounded-lg border border-slate-200"><button onClick={() => setFilterType('recent')} className={`px-4 py-2 text-xs font-bold rounded-md transition-all ${filterType === 'recent' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Last 5 Days</button><div className="h-6 w-px bg-slate-200 mx-1"></div><input type="date" className={`bg-transparent text-xs outline-none px-2 py-1 rounded transition-colors cursor-pointer ${filterType === 'specific' ? 'text-indigo-600 font-bold' : 'text-slate-500 hover:text-slate-700'}`} value={specificDate} onChange={(e) => { setFilterType('specific'); setSpecificDate(e.target.value); }} /></div><div className="relative"><input type="text" placeholder="Search Order ID / Name..." className="bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-2.5 text-slate-800 w-64 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none text-sm shadow-sm transition-all" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /><Search className="absolute left-3 top-2.5 text-slate-400" size={16} /></div></div></div><div className="flex gap-6 flex-1 min-h-0"><div className="w-1/3 bg-white border border-slate-200 rounded-2xl overflow-hidden flex flex-col shadow-sm"><div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center"><span className="font-bold text-slate-500 text-sm uppercase tracking-wider">Orders List</span><span className="text-xs bg-indigo-100 px-2 py-1 rounded-full text-indigo-700 font-bold">{filteredOrders.length}</span></div><div className="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2">{loading ? <div className="flex justify-center p-8"><Loader2 className="animate-spin text-indigo-500" /></div> : filteredOrders.length === 0 ? <div className="flex flex-col items-center justify-center p-12 text-slate-400 text-center"><Search size={32} className="mb-4 opacity-20" /><p>No orders found.</p></div> : filteredOrders.map((group) => ( <button key={group.order.orderId} onClick={() => setSelectedOrder(group)} className={`w-full text-left p-4 rounded-xl border transition-all ${selectedOrder?.order.orderId === group.order.orderId ? 'bg-indigo-50 border-indigo-200 shadow-sm ring-1 ring-indigo-200' : 'bg-white border-transparent hover:bg-slate-50'}`}><div className="flex justify-between mb-1"><span className="font-mono text-xs text-indigo-700 font-bold bg-indigo-50 px-2 py-0.5 rounded">{group.order.billNo || "N/A"}</span><span className="text-xs text-slate-400">{formatDate(group.order.date)}</span></div><div className="font-bold text-slate-800 truncate text-sm mt-1">{group.order.customerName || "Unknown Customer"}</div><div className="flex justify-between items-end mt-2"><span className="text-xs text-slate-500 font-medium bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">{group.items.length} Items</span><span className="font-mono text-xs text-slate-400">{group.order.orderId}</span></div></button> ))}</div></div><div className="w-2/3 bg-slate-100 border border-slate-300 rounded-2xl flex flex-col overflow-hidden relative shadow-inner">{selectedOrder && editableOrder ? ( <><div className="p-4 border-b border-slate-200 flex justify-between items-center bg-white shadow-sm z-10"><div className="flex gap-2"><button onClick={() => setViewMode('invoice')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${viewMode === 'invoice' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-50'}`}>Tax Invoice</button><button onClick={() => setViewMode('slip')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${viewMode === 'slip' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'text-slate-500 hover:bg-slate-50'}`}>Packing Slip</button><div className="relative"><button onClick={() => setShowEditPanel(!showEditPanel)} className={`p-2 rounded-lg transition-all flex items-center gap-2 ${showEditPanel ? 'bg-indigo-100 text-indigo-700' : 'text-slate-500 hover:bg-slate-50'}`}><Pencil size={18} /></button>{showEditPanel && ( <div className="absolute top-12 left-0 w-80 bg-white border border-slate-200 rounded-xl shadow-2xl p-4 z-30 animate-in fade-in zoom-in-95 duration-100"><div className="flex justify-between items-center mb-3 pb-2 border-b border-slate-100"><div className="text-xs font-bold text-slate-500 uppercase">Edit Details (Preview)</div><button onClick={() => setShowEditPanel(false)}><X size={14} className="text-slate-400 hover:text-slate-800"/></button></div><div className="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2"><div><label className="text-[10px] font-bold text-slate-400 block mb-1">Customer</label><input type="text" className="w-full border border-slate-200 rounded-lg p-2 bg-slate-50 text-xs focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none" value={editableOrder.customerName || ''} onChange={e=>handleEditChange('customerName', e.target.value)} /></div><div><label className="text-[10px] font-bold text-slate-400 block mb-1">Contact</label><input type="text" className="w-full border border-slate-200 rounded-lg p-2 bg-slate-50 text-xs focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none" value={editableOrder.contact || ''} onChange={e=>handleEditChange('contact', e.target.value)} /></div><div><label className="text-[10px] font-bold text-slate-400 block mb-1">Address</label><textarea className="w-full border border-slate-200 rounded-lg p-2 bg-slate-50 text-xs resize-none h-20 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none" value={editableOrder.address || ''} onChange={e=>handleEditChange('address', e.target.value)} /></div><div><label className="text-[10px] font-bold text-slate-400 block mb-1">State</label><input type="text" className="w-full border border-slate-200 rounded-lg p-2 bg-slate-50 text-xs focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none" value={editableOrder.state || ''} onChange={e=>handleEditChange('state', e.target.value)} /></div><div><label className="text-[10px] font-bold text-slate-400 block mb-1">Pincode</label><input type="text" className="w-full border border-slate-200 rounded-lg p-2 bg-slate-50 text-xs focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none" value={editableOrder.pincode || ''} onChange={e=>handleEditChange('pincode', e.target.value)} /></div></div></div> )}</div>{viewMode === 'slip' && ( <div className="relative"><button onClick={() => setShowSettingsPanel(!showSettingsPanel)} className={`p-2 rounded-lg transition-all ${showSettingsPanel ? 'bg-indigo-100 text-indigo-700' : 'text-slate-500 hover:bg-slate-50'}`} title="Slip Settings"><SlidersHorizontal size={18} /></button>{showSettingsPanel && ( <div className="absolute top-12 left-0 w-72 bg-white border border-slate-200 rounded-xl shadow-2xl p-4 z-20 animate-in fade-in zoom-in-95 duration-100"><div className="text-xs font-bold text-slate-500 uppercase mb-3 pb-2 border-b border-slate-100">Slip Settings</div><div className="space-y-4"><div><label className="text-xs text-slate-500 mb-1.5 block">Shipping Mode</label>
                    <select
  className="w-full border border-slate-200 rounded-xl px-3 py-2 text-xs bg-white text-slate-700 outline-none
             focus:ring-2 focus:ring-indigo-500/30 hover:border-slate-300 transition"
  value={packingSettings.shippingMode}
  onChange={(e) =>
    setPackingSettings((p) => ({ ...p, shippingMode: e.target.value }))
  }
>
  <option value="Normal">🚚 Normal Delivery</option>
  <option value="Post Speed Normal">⚡ Post Speed</option>
  <option value="Post Business Normal">📦 Post Business Parcel</option>
</select>

                    
                    </div><div><label className="text-xs text-slate-500 mb-1.5 block">Weight</label>
                    <input type="text" className="w-full border border-slate-200 rounded-lg px-2 py-2 text-xs bg-slate-50 text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500/20" value={packingSettings.weight} placeholder="Optional" onChange={(e) => setPackingSettings(p => ({...p, weight: e.target.value}))} /></div>
                    <div className="flex items-center gap-2"><input type="checkbox" id="showItems" checked={packingSettings.showItems} onChange={(e) => setPackingSettings(p => ({...p, showItems: e.target.checked}))} className="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500" /><label htmlFor="showItems" className="text-xs text-slate-700 select-none">Show Items & Qty</label></div></div></div> )}</div> )}</div>       <button onClick={handleDownload} className="flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg shadow-lg shadow-slate-400/50 font-bold transition-all"><Download size={18} /><span>Download PDF</span></button><button onClick={handlePrint} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 rounded-lg font-bold shadow-sm transition-all"><Printer size={18} /> Print</button></div><div className="flex-1 overflow-y-auto custom-scrollbar bg-slate-200/50 p-8 flex justify-center"><div className="scale-[0.85] origin-top transform-gpu transition-transform shadow-2xl">{viewMode === 'invoice' ? ( <InvoiceTemplate order={editableOrder} items={selectedOrder.items} /> ) : ( <PackingSlipTemplate order={editableOrder} items={selectedOrder.items} settings={packingSettings} /> )}</div></div></> ) : ( <div className="flex flex-col items-center justify-center h-full text-slate-400"><Box size={64} className="opacity-10 mb-4" /><p className="font-medium text-slate-500">Select an order from the list to view invoice</p></div> )}</div></div></div><div className="hidden print:block fixed inset-0 bg-white z-[100] overflow-auto">{selectedOrder && editableOrder && ( viewMode === 'invoice' ? <InvoiceTemplate order={editableOrder} items={selectedOrder.items} /> : <PackingSlipTemplate order={editableOrder} items={selectedOrder.items} settings={packingSettings} /> )}</div>
                </div>
            );
        };

        const OrderEntryForm = () => {
            const { addLocalOrder, pendingOps, orders } = useOrders();
            const [details, setDetails] = useState(getInitialDetails());
            const [items, setItems] = useState(getInitialItems());
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [aiPromptOpen, setAiPromptOpen] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [aiInputText, setAiInputText] = useState("");
            
            const totals = useMemo(() => {
                let subTotal = 0; let totalTax = 0; let totalInclusive = 0;
                items.forEach(item => { let lineInclusiveTotal = item.total; if (lineInclusiveTotal === undefined || lineInclusiveTotal === null) { const totalMrp = item.mrp * item.quantity; const discountAmount = (totalMrp * item.discount) / 100; lineInclusiveTotal = totalMrp - discountAmount; } const gstMultiplier = 1 + (item.gst / 100); const lineTaxable = lineInclusiveTotal / gstMultiplier; const lineTax = lineInclusiveTotal - lineTaxable; subTotal += lineTaxable; totalTax += lineTax; totalInclusive += lineInclusiveTotal; });
                const grandTotal = totalInclusive + (details.freightCharge || 0);
                return { subTotal, totalTax, grandTotal };
            }, [items, details.freightCharge]);
            useEffect(() => {
                const init = async () => {
                    const initialOrderNum = generateOrderNumberString();
                    setDetails(prev => ({ ...prev, orderNumber: initialOrderNum }));
                    let serverLastInvoice = "RON/000000";
                    if (GOOGLE_SCRIPT_URL.includes("script.google.com")) { try { const res = await fetch(GOOGLE_SCRIPT_URL, { redirect: "follow" }); if (res.ok) { const data = await res.json(); if (data && data.lastInvoiceNo) serverLastInvoice = data.lastInvoiceNo; } } catch (e) { console.debug("Fetch invoice failed"); } }
                    let maxInvoiceNum = 0; let maxInvoiceStr = serverLastInvoice;
                    const parseInv = (inv) => { if (!inv) return 0; const parts = inv.split('/'); const num = parseInt(parts[parts.length-1]); return isNaN(num) ? 0 : num; }
                    maxInvoiceNum = parseInv(serverLastInvoice);
                    pendingOps.forEach(op => { if (op.type === 'create') { op.payload.forEach((row) => { const billNo = row[2]; const num = parseInv(billNo); if (num > maxInvoiceNum) { maxInvoiceNum = num; maxInvoiceStr = billNo; } }); } });
                    setDetails(prev => ({ ...prev, lastInvoiceNo: maxInvoiceStr }));
                    const parts = maxInvoiceStr.split('/');
                    if (parts.length >= 2) { const numPart = parts[parts.length - 1]; if (!isNaN(parseInt(numPart))) { const nextNum = parseInt(numPart) + 1; const newNumStr = nextNum.toString().padStart(numPart.length, '0'); const prefix = parts.slice(0, -1).join('/'); const nextInvoice = `${prefix}/${newNumStr}`; setDetails(prev => ({ ...prev, currentInvoiceNo: nextInvoice })); } }
                };
                init();
            }, [pendingOps]); 
            useEffect(() => { const fetchState = async () => { if (details.pincode.length === 6) { try { const response = await fetch(`https://api.postalpincode.in/pincode/${details.pincode}`); if (response.ok) { const data = await response.json(); if (data && data[0].Status === "Success" && data[0].PostOffice.length > 0) { const stateName = data[0].PostOffice[0].State; setDetails(prev => ({ ...prev, state: stateName })); } } } catch (error) {} } }; const timeoutId = setTimeout(fetchState, 500); return () => clearTimeout(timeoutId); }, [details.pincode]);
            const handleDetailChange = (field, value) => { setDetails(prev => ({ ...prev, [field]: value })); };
            const handleItemChange = (id, field, value) => { setItems(prev => prev.map(item => { if (item.id === id) { const updatedItem = { ...item, [field]: value }; if (field === 'mrp' || field === 'quantity' || field === 'discount') { const m = field === 'mrp' ? Number(value) : item.mrp; const q = field === 'quantity' ? Number(value) : item.quantity; const d = field === 'discount' ? Number(value) : item.discount; updatedItem.total = (m * q) * (1 - d / 100); } return updatedItem; } return item; })); };
            const handleTotalChange = (id, value) => { setItems(prev => prev.map(item => { if (item.id === id) return { ...item, total: value }; return item; })); };
            const addItem = () => { const newItem = { id: Math.random().toString(36).substr(2, 9), productName: "", mrp: 0, discount: 0, quantity: 0, gst: 18, hsnCode: "4202", total: 0 }; setItems([...items, newItem]); };
            const removeItem = (id) => { if (items.length > 1) setItems(items.filter(i => i.id !== id)); else setItems(getInitialItems()); };
            const handleReset = () => { const newOrderNum = generateOrderNumberString(); setDetails(prev => ({ ...getInitialDetails(), lastInvoiceNo: prev.lastInvoiceNo, currentInvoiceNo: prev.currentInvoiceNo, orderNumber: newOrderNum })); setItems(getInitialItems()); setAiInputText(""); };
            const handleManualReset = () => { if (confirm("Are you sure you want to reset the form? All unsaved data will be lost.")) handleReset(); };
            const generateOrderNumber = () => { const newNum = generateOrderNumberString(); setDetails(prev => ({ ...prev, orderNumber: newNum })); };
            const handlePasteFromClipboard = async () => { try { const text = await navigator.clipboard.readText(); setAiInputText(text); } catch (err) { alert("Could not access clipboard. Please paste manually."); } };
            const handleClearAiInput = () => setAiInputText("");
            const handleSaveEntry = async () => {
                if (!details.customerName || items.length === 0) { alert("Please provide customer details and at least one item."); return; }
                setIsSaving(true);
                try {
                    const itemsToSave = [...items];
                    if (details.freightCharge > 0) { itemsToSave.push({ id: "freight-charge", productName: "Freight Charges", mrp: details.freightCharge, discount: 0, quantity: 1, gst: 18, hsnCode: "9965", total: details.freightCharge }); }
                    const cleanEmail = (email = "") =>
  email
    .trim()            // remove starting & ending spaces
    .replace(/\s+/g, ""); // remove ALL spaces inside

                    const totalQty = itemsToSave.reduce((acc, item) => acc + (item.quantity || 0), 0);
                    const sheetRows = itemsToSave.map((item, index) => {
                    const isFirst = index === 0; 
                    const rowData = new Array(38).fill("");
                    let lineTotal = item.total !== undefined ? item.total : ((item.mrp * item.quantity) * (1 - item.discount / 100));
                    const gstRate = item.gst || 0; 
                    const taxableAmount = lineTotal / (1 + gstRate / 100); 
                    const gstAmount = lineTotal - taxableAmount;
                        
                    rowData[0] = isFirst ? details.date : ""; 
                    rowData[1] = isFirst ? details.orderNumber : `${details.orderNumber}Q${index}`; 
                    rowData[2] = isFirst ? details.currentInvoiceNo : ""; 
                    rowData[3] = isFirst ? details.customerName : ""; 
                    rowData[4] = isFirst ? details.contact : ""; 
                    rowData[5] = isFirst ? details.address : ""; 
                    rowData[6] = isFirst ? details.pincode : ""; 
                    rowData[7] = isFirst ? details.state : ""; 
                    rowData[8] = isFirst ? details.paymentType : ""; 
                    rowData[9] = item.productName; 
                    rowData[10] = item.mrp; 
                    rowData[11] = item.discount; 
                    rowData[12] = lineTotal.toFixed(2); 
                    rowData[13] = item.quantity; 
                    rowData[14] = isFirst ? totalQty : ""; 
                    rowData[15] = item.gst ? item.gst / 100 : 0; 
                    rowData[16] = item.hsnCode || "4202"; 
                    rowData[17] = isFirst ? totals.grandTotal.toFixed(2) : ""; 
                    rowData[18] = details.orderNumber; 
                    rowData[19] = isFirst ? details.paymentRef : ""; 
                    rowData[20] = details.date; 
                    rowData[21] = ""; 
                    rowData[22] = "";
                    rowData[23] = ""; 
                    rowData[24] = isFirst ? cleanEmail(details.email) : "";
                    rowData[25] = isFirst ? "Pending" : ""; 
                    rowData[26] = ""; 
                    rowData[27] = taxableAmount.toFixed(2); 
                    rowData[28] = gstAmount.toFixed(2); 
                    rowData[29] = (gstAmount / 2).toFixed(2); 
                    rowData[30] = ""; 
                    rowData[31] = ""; 
                    rowData[32] = ""; 
                    rowData[33] = ""; 
                    rowData[34] = "";
                       
                       const productNameLower = (item.productName || "").toLowerCase(); const luggageKeywords = ["luggage", "luggages", "strolly", "trolly", "trolley", "suitcase", "briefcase"]; const isLuggage = luggageKeywords.some(k => productNameLower.includes(k)); 
                       rowData[35] = isLuggage ? "Luggages" : "Bags"; 
                       rowData[36] = ""; 
                       rowData[37] = "Not Generated";
                        return rowData;
                    });
                    addLocalOrder(sheetRows, details);
                    alert("✅ Order saved locally!\n🔄 Please Sync to upload changes.");
                    handleReset(); 
                } catch (e) { console.error("Save Error", e); alert("Failed to save entry."); } 
                finally { setIsSaving(false); }
            };

           const handleAiFill = async () => {
    if (!aiInputText.trim()) return;
    setIsAiLoading(true);

    try {
        const text = aiInputText;

        // Helper to get first match for a label
        const get = (label) => {
            const regex = new RegExp(`${label}\\s*[:：]\\s*(.*)`, "i");
            const match = text.match(regex);
            return match ? match[1].trim() : "";
        };

        // Helper to get all matches for a label
        const getAll = (label) => {
            const regex = new RegExp(`${label}\\s*[:：]\\s*(.*)`, "gi");
            const matches = [...text.matchAll(regex)];
            return matches.map(m => m[1].trim());
        };

        let extractedData = {};
        extractedData.date = getLocalDateString(new Date());

        // ----------- Order Number Validation -----------
        const orderIdsUpper = getAll("ORDER ID");
        const orderIdsLower = getAll("Order ID");
        const allOrderIds = [...orderIdsUpper, ...orderIdsLower];

        if (allOrderIds.length === 0) {
            alert("No Order ID found!");
            setIsAiLoading(false);
            return;
        }

        // Check for mismatched order IDs
        const uniqueOrderIds = [...new Set(allOrderIds)];
        if (uniqueOrderIds.length > 1) {
            alert(`Mixed Order IDs found! Different order numbers detected: ${uniqueOrderIds.join(", ")}`);
            setIsAiLoading(false);
            return;
        }

        extractedData.orderNumber = uniqueOrderIds[0];

        if (!extractedData.orderNumber.startsWith("RB")) {
            alert("Invalid Order Number! It must start with RB");
            setIsAiLoading(false);
            return;
        }

        const orderExists = orders.some(o => (o[1] === extractedData.orderNumber) || (o.orderNumber === extractedData.orderNumber));
        if (orderExists) {
            alert(`Order Number ${extractedData.orderNumber} already exists!`);
            setIsAiLoading(false);
            return;
        }

        // ----------- Bill Number Validation -----------
        const billNoMatches = [...text.matchAll(/BILL\s*NO\s*[:：]\s*([A-Za-z0-9\/-]+)/gi)];
        const allBillNos = billNoMatches.map(m => m[1].trim());

        if (allBillNos.length > 1) {
            const uniqueBillNos = [...new Set(allBillNos)];
            if (uniqueBillNos.length > 1) {
                alert(`Mixed Bill Numbers found! Different bill numbers detected: ${uniqueBillNos.join(", ")}`);
                setIsAiLoading(false);
                return;
            }
        }

        extractedData.billNo = allBillNos[0] || "";
        if (extractedData.billNo) {
            extractedData.billNo = extractedData.billNo.replace(/\/\d{2}-\d{2}\//, "/");
            if (!extractedData.billNo.startsWith("RON")) {
                alert("Invalid Bill Number! It must start with RON");
                setIsAiLoading(false);
                return;
            }

            // Check sequential invoice number
            const last = details.lastInvoiceNo;
            const parseNum = (str) => {
                if (!str) return 0;
                const parts = str.split("/");
                const num = parseInt(parts[parts.length - 1]);
                return isNaN(num) ? 0 : num;
            };
            const lastNum = parseNum(last);
            const extractedNum = parseNum(extractedData.billNo);
            const expectedNext = last.replace(/\d+$/, (lastNum + 1).toString().padStart(last.length - 4, "0"));
            if (extractedNum !== lastNum + 1) {
                alert(`Invalid Bill Number!\nExpected: ${expectedNext}\nFound: ${extractedData.billNo}`);
                setIsAiLoading(false);
                return;
            }
        }

        // ----------- Customer Details -----------
        extractedData.customerName = get("CUSTOMER NAME") || get("Customer Name");
        extractedData.contact = get("CONTACT") || get("Contact");
        extractedData.address = get("ADDRESS") || get("Delivery Address");
        extractedData.pincode = get("PINCODE");
        extractedData.paymentType = get("PAYMENT TYPE") || get("Payment Mode");
        extractedData.email = get("Mail ID") || get("Email");

        // ----------- Products Extraction -----------
        const productRegex = /\d+\.\s*(.*?)\s*\|\s*MRP:\s*₹?(\d+)\s*\|\s*Qty:\s*(\d+)\s*\|\s*Price:\s*₹?(\d+)/gi;
        let match;
        extractedData.items = [];
        while ((match = productRegex.exec(text)) !== null) {
            extractedData.items.push({
                productName: match[1].trim(),
                mrp: Number(match[2]),
                quantity: Number(match[3]),
                sellingPrice: Number(match[4]),
                gst: 18,
                hsnCode: "4202"
            });
        }

        // ----------- Payment Type Normalization -----------
        const normalizePaymentType = (value) => {
            if (!value) return "Online Payment";
            const v = value.toLowerCase();
            if (v.includes("cod") || v.includes("cash on delivery")) return "Cash On Delivery";
            if (v.includes("online")) return "Online Payment";
            return "Online Payment";
        };

        // ----------- Update Details State -----------
        let finalinvoice = extractedData.billNo || details.currentInvoiceNo;
        setDetails(prev => ({
            ...prev,
            currentInvoiceNo: finalinvoice,
            orderNumber: extractedData.orderNumber || prev.orderNumber,
            customerName: extractedData.customerName || prev.customerName,
            contact: extractedData.contact || prev.contact,
            address: extractedData.address || prev.address,
            pincode: extractedData.pincode || prev.pincode,
            email: extractedData.email || prev.email,
            paymentType: normalizePaymentType(extractedData.paymentType)
        }));

        // ----------- Update Items State -----------
        if (extractedData.items.length > 0) {
            const newItems = extractedData.items.map(item => {
                const { mrp, sellingPrice, quantity } = item;
                let discountPercent = 0;
                if (mrp > 0) {
                    discountPercent = 100 - (((sellingPrice / quantity) / mrp) * 100);
                }
                return {
                    id: Math.random().toString(36).substr(2, 9),
                    productName: item.productName,
                    mrp,
                    discount: parseFloat(discountPercent.toFixed(2)),
                    quantity,
                    gst: item.gst,
                    hsnCode: item.hsnCode
                };
            });
            setItems(newItems);
        }

        // ----------- Reset AI Prompt -----------
        setAiPromptOpen(false);
        setAiInputText("");

    } catch (error) {
        console.error("Parsing failed", error);
        alert("Failed to parse details: " + error.message);
    } finally {
        setIsAiLoading(false);
    }  
    
};
   // -------- SAVE ENABLE LOGIC (GLOBAL) --------
const isCustomerValid =
  details.customerName?.trim() &&
  details.contact?.trim() &&
  details.pincode?.trim() &&
  details.address?.trim() &&
  details.state?.trim();
  
const isProductValid =
  items.length > 0 &&
  items.every(item =>
    item.productName?.trim() &&
    item.hsnCode?.trim() &&
    item.mrp > 0 &&
    item.quantity > 0 &&
    item.discount !== undefined
  );

const canSave = !isSaving && isCustomerValid && isProductValid;


            return (
            
            <div className="h-screen overflow-hidden bg-slate-50  h-[calc(100vh-96px)] overflow-y-auto custom-scrollbar">
<div className="w-full max-w-[1600px] mx-auto px-4 md:px-8 py-6  ">
                
                <div className="sticky top-0 z-30 bg-white border-b border-slate-200">
                    <div className="flex flex-col md:flex-row justify-between items-center bg-white p-5 rounded-2xl border border-slate-200 shadow-sm z-10 gap-4"><div className="flex items-center gap-4 w-full md:w-auto"><div className="bg-gradient-to-br from-indigo-600 to-violet-600 p-3 rounded-xl text-white shadow-lg shadow-indigo-200 hidden md:block"><Box size={26} /></div><div><h1 className="text-2xl font-bold text-slate-800 tracking-tight">Online Order <span className="text-indigo-600">Entry</span></h1><p className="text-slate-400 text-xs md:text-sm font-medium">Create and manage new sales orders</p></div></div><div className="flex flex-wrap gap-3 justify-center md:justify-end w-full md:w-auto">
                    <div className="hidden md:flex items-center gap-3 px-5 py-3 bg-white border border-slate-200 rounded-2xl text-sm text-slate-700 shadow-sm hover:shadow-md transition-shadow duration-200">
  {/* Clock / Previous Icon */}
  <svg
    xmlns="http://www.w3.org/2000/svg"
    className="h-5 w-5 text-indigo-500"
    fill="none"
    viewBox="0 0 24 24"
    stroke="currentColor"
    strokeWidth={2}
  >
    <path
      strokeLinecap="round"
      strokeLinejoin="round"
      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
    />
  </svg>

  {/* Texts */}
  <span className="font-semibold text-slate-500 uppercase tracking-wide">Last Invoice:</span>
  <span className="font-mono font-bold text-indigo-600">{details.lastInvoiceNo}</span>
</div>

                    <button
  onClick={() => setAiPromptOpen(true)}
  className={`
    flex items-center gap-2 px-5 py-2.5 rounded-xl font-bold transition-all shadow-lg
    bg-gradient-to-r from-indigo-600 to-violet-600
    hover:from-indigo-500 hover:to-violet-500 text-white
    ${!canSave ? "animate-pulse ring-2 ring-indigo-400/50" : "shadow-indigo-200"}
  `}
  title={!canSave ? "Use Quick Paste or fill all required fields to enable Save" : ""}
>
  <Sparkles size={18} className="text-indigo-100" />
  <span>Quick Paste</span>
</button>

                    <button onClick={handleManualReset} className="flex items-center gap-2 px-4 py-2.5 bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-700 rounded-xl font-medium transition-all group shadow-lg shadow-slate-300/50" title="Reset Form"><RotateCcw size={18} className="group-hover:-rotate-180 transition-transform duration-500" /></button><button
  onClick={handleSaveEntry}
  disabled={!canSave}
  className={`
    flex items-center gap-2 px-6 py-2.5 rounded-xl font-bold transition-all shadow-lg
    ${canSave
      ? "bg-emerald-600 hover:bg-emerald-500 text-white shadow-emerald-200 animate-pulse"
      : "bg-slate-300 text-slate-500 cursor-not-allowed shadow-none"}
  `}
>
  {isSaving ? <Loader2 size={18} className="animate-spin" /> : <Save size={18} />}
  <span>{isSaving ? "Saving..." : "Save Entry"}</span>
</button>


</div></div></div>
                    {aiPromptOpen && ( <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl border border-slate-200 shadow-2xl w-full max-w-2xl overflow-hidden animate-in fade-in zoom-in duration-200 flex flex-col min-h-[400px] max-h-[90vh]"><div className="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center"><div><h3 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Sparkles className="text-indigo-600" size={24}/> Quick Paste Data</h3><p className="text-sm text-slate-500 mt-0.5">Automatically extract Invoice, Order & Product details.</p></div>{!isAiLoading && ( <button onClick={() => setAiPromptOpen(false)} className="text-slate-400 hover:text-slate-800 transition-colors"><X size={24} /></button> )}</div><div className="p-5 flex-grow flex flex-col gap-4 relative">{isAiLoading ? ( <div className="absolute inset-0 z-10 bg-white/90 flex flex-col items-center justify-center p-8 animate-in fade-in duration-300"><div className="relative"><div className="absolute inset-0 bg-indigo-500 blur-xl opacity-20 rounded-full"></div><Loader2 className="relative z-10 w-16 h-16 text-indigo-600 animate-spin" /></div><h3 className="mt-8 text-xl font-bold text-slate-800">Analyzing Order Data...</h3><div className="w-64 h-1.5 bg-slate-100 rounded-full overflow-hidden relative mt-4"><div className="absolute inset-0 bg-gradient-to-r from-indigo-600 via-violet-500 to-indigo-600 animate-[shimmer_1.5s_infinite_linear] w-full origin-left"></div></div><style>{`@keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }`}</style></div> ) : ( <><div className="relative flex-grow flex flex-col"><textarea className="w-full h-64 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-400 outline-none resize-none text-slate-800 placeholder-slate-400 custom-scrollbar font-mono text-sm transition-all" placeholder="Paste invoice text here..." value={aiInputText} onChange={(e) => setAiInputText(e.target.value)} /><button onClick={handleClearAiInput} className="absolute top-3 right-3 p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-200 rounded-lg transition-colors" title="Clear text"><Eraser size={16} /></button></div><div className="flex gap-3"><button onClick={handlePasteFromClipboard} className="flex-1 flex items-center justify-center gap-2 py-3 bg-white hover:bg-slate-50 text-slate-600 font-bold rounded-xl transition-all border border-slate-200 shadow-sm"><ClipboardPaste size={18} /> Paste from Clipboard</button><button onClick={handleAiFill} disabled={!aiInputText.trim()} className="flex-[2] flex items-center justify-center gap-2 py-3 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold rounded-xl transition-all shadow-lg shadow-indigo-200"><Wand2 size={18} /> Process Data</button></div></> )}</div></div></div> )}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="space-y-6">
                            <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow"><h2 className="text-lg font-semibold text-slate-800 mb-5 flex items-center gap-2"><FileText className="text-indigo-500" size={20} /> Order Details</h2><div className="space-y-4"><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Order Number (Auto/RB)</label><div className="flex gap-2"><input type="text" className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-800 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all" value={details.orderNumber} onChange={(e) => handleDetailChange('orderNumber', e.target.value)} placeholder="RB..." /><button onClick={generateOrderNumber} className="bg-slate-800 text-slate-300 px-3 py-2 rounded-lg hover:bg-indigo-600 hover:text-white transition-colors" title="Generate Order ID"><Hash size={18} /></button></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Date</label><div className="relative"><input type="date" className="w-full bg-slate-50 border border-slate-200 rounded-lg pl-3 pr-3 py-2 text-slate-800 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all" value={details.date} onChange={(e) => handleDetailChange('date', e.target.value)} /></div></div><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Invoice No</label><input type="text" className="w-full bg-slate-50 border border-slate-200 font-bold rounded-lg px-3 py-2 text-slate-800 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all" value={details.currentInvoiceNo} onChange={(e) => handleDetailChange('currentInvoiceNo', e.target.value)} /></div></div>
                            
                            <div>
  <label className="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">
    Payment Type
  </label>

  <div className="grid grid-cols-2 gap-3">
    {/* ONLINE */}
    <button
      type="button"
      onClick={() => handleDetailChange("paymentType", "Online Payment")}
      className={`flex items-center justify-center gap-2 px-4 py-3 rounded-xl border text-sm font-bold transition-all
        ${
          details.paymentType === "Online Payment"
            ? "bg-indigo-600 border-indigo-600 text-white shadow-md scale-[1.02]"
            : "bg-white border-slate-300 text-slate-600 hover:border-indigo-300 hover:bg-indigo-50"
        }`}
    >
      💳 Online
    </button>

    {/* COD */}
    <button
      type="button"
      onClick={() => handleDetailChange("paymentType", "Cash On Delivery")}
      className={`flex items-center justify-center gap-2 px-4 py-3 rounded-xl border text-sm font-bold transition-all
        ${
          details.paymentType === "Cash On Delivery"
            ? "bg-emerald-600 border-emerald-600 text-white shadow-md scale-[1.02]"
            : "bg-white border-slate-300 text-slate-600 hover:border-emerald-300 hover:bg-emerald-50"
        }`}
    >
      💵 COD
    </button>
  </div>
</div>
</div>


{/* PAYMENT REF / UTR */}
{details.paymentType === "Online Payment" && (
  <div className="mt-4">
    <label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">
      Payment Ref / UTR
    </label>

    <input
      type="text"
      placeholder="Enter UTR / Transaction ID"
      value={details.paymentRef || ""}
      onChange={(e) =>
        handleDetailChange("paymentRef", e.target.value)
      }
      className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 text-slate-800
                 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all"
    />

    <p className="text-[11px] text-slate-400 mt-1">
      Required for online payments only
    </p>
  </div>
)}

                            </div>
                            <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow"><h2 className="text-lg font-semibold text-slate-800 mb-5 flex items-center gap-2"><User className="text-indigo-500" size={20} /> Customer Info</h2><div className="space-y-4"><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Customer Name</label><input type="text" className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-800 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all" value={details.customerName} onChange={(e) => handleDetailChange('customerName', e.target.value)} placeholder="John Doe" /></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Contact Number</label><input type="text" className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-800 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all" value={details.contact} onChange={(e) => handleDetailChange('contact', e.target.value)} placeholder="+91..." /></div><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Email</label><input type="email" className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-800 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all" value={details.email} onChange={(e) => handleDetailChange('email', e.target.value)} placeholder="email@example.com" /></div></div><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Address</label><textarea className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-800 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all resize-none h-24" value={details.address} onChange={(e) => handleDetailChange('address', e.target.value)} placeholder="Street, Locality..." /></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Pincode</label><input type="text" maxLength={6} className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-800 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all" value={details.pincode} onChange={(e) => handleDetailChange('pincode', e.target.value)} placeholder="110001" /></div><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">State</label><input type="text" className="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-800 focus:bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all placeholder-slate-400" value={details.state} onChange={(e) => handleDetailChange('state', e.target.value)} placeholder="State" /></div></div></div></div>
                        </div>
                        <div className="lg:col-span-2 flex flex-col gap-6"><div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex-grow"><div className="flex justify-between items-center mb-6"><h2 className="text-lg font-semibold text-slate-800 flex items-center gap-2"><Box className="text-indigo-500" size={20} /> Product Line Items</h2><button onClick={addItem} className="flex items-center gap-2 px-4 py-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 border border-indigo-200 rounded-lg text-xs font-bold transition-all"><Plus size={16} /> Add Item</button></div><div className="overflow-x-auto rounded-xl border border-slate-200 custom-scrollbar"><table className="w-full text-left text-sm text-slate-500"><thead className="bg-slate-50 text-slate-500 uppercase text-[10px] font-bold tracking-wider"><tr><th className="px-4 py-3 min-w-[300px]">Product Name</th><th className="px-4 py-3 min-w-[100px]">HSN</th><th className="px-4 py-3 min-w-[120px] text-right">MRP</th><th className="px-4 py-3 min-w-[100px] text-right">Disc %</th><th className="px-4 py-3 min-w-[100px] text-center">Qty</th><th className="px-4 py-3 min-w-[120px] text-right">Total</th><th className="px-4 py-3 w-12"></th></tr></thead><tbody className="divide-y divide-slate-100">{items.map((item) => { const lineTotal = item.total !== undefined ? item.total : ((item.mrp * item.quantity) * (1 - item.discount / 100)); return (<tr key={item.id} className="hover:bg-indigo-50/30 transition-colors group"><td className="px-4 py-2"><input type="text" className="w-full bg-transparent border border-transparent hover:border-slate-300 focus:border-indigo-400 focus:ring-0 p-1.5 rounded transition-all text-slate-800 placeholder-slate-400 font-medium" placeholder="Item Name" value={item.productName} onChange={(e) => handleItemChange(item.id, 'productName', e.target.value)} /></td><td className="px-4 py-2"><input type="text" className="w-full bg-transparent border border-transparent hover:border-slate-300 focus:border-indigo-400 focus:ring-0 p-1.5 rounded transition-all text-slate-800" value={item.hsnCode} onChange={(e) => handleItemChange(item.id, 'hsnCode', e.target.value)} /></td><td className="px-4 py-2 text-right"><input type="number" className="w-full bg-transparent border border-transparent hover:border-slate-300 focus:border-indigo-400 focus:ring-0 p-1.5 rounded transition-all text-slate-800 text-right" value={item.mrp || ''} onChange={(e) => handleItemChange(item.id, 'mrp', parseFloat(e.target.value) || 0)} /></td><td className="px-4 py-2 text-right"><input type="number" className="w-full bg-transparent border border-transparent hover:border-slate-300 focus:border-indigo-400 focus:ring-0 p-1.5 rounded transition-all text-slate-800 text-right" value={item.discount || ''} onChange={(e) => handleItemChange(item.id, 'discount', parseFloat(e.target.value) || 0)} /></td><td className="px-4 py-2 text-center"><input type="number" className="w-full bg-transparent border border-transparent hover:border-slate-300 focus:border-indigo-400 focus:ring-0 p-1.5 rounded transition-all text-slate-800 text-center font-bold" value={item.quantity || ''} onChange={(e) => handleItemChange(item.id, 'quantity', parseFloat(e.target.value) || 0)} /></td><td className="px-4 py-2 text-right font-bold text-indigo-700 relative"><span className="absolute left-2 top-3.5 text-xs text-slate-400">₹</span><input type="number" className="w-full bg-transparent border-b border-transparent hover:border-slate-300 focus:border-indigo-500 text-right font-bold text-indigo-700 outline-none" value={lineTotal.toFixed(2)} onChange={(e) => handleTotalChange(item.id, parseFloat(e.target.value) || 0)} /></td><td className="px-4 py-2 text-center"><button onClick={() => removeItem(item.id)} className="text-red-400 hover:text-red-600 hover:bg-red-50 p-1.5 rounded transition-all opacity-0 group-hover:opacity-100" tabIndex={-1}><Trash2 size={16} /></button></td></tr>); })}</tbody></table></div></div><div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-lg"><div className="flex flex-col md:flex-row gap-8 justify-between items-start"><div className="w-full md:w-1/2 space-y-4"><h3 className="text-sm font-bold text-slate-500 uppercase tracking-wider">Additional Charges</h3><div className="bg-slate-50 p-4 rounded-xl border border-slate-100"><div className="flex justify-between items-center"><label className="text-sm font-bold text-slate-700 flex items-center gap-2"><Truck size={16} className="text-slate-400" /> Freight Charges</label><div className="flex items-center gap-2"><span className="text-slate-400 font-bold">₹</span><input type="number" className="w-24 bg-white border border-slate-200 rounded-lg px-3 py-2 text-right font-bold text-slate-800 focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all" value={details.freightCharge || ''} onChange={(e) => handleDetailChange('freightCharge', parseFloat(e.target.value) || 0)} /></div></div></div></div><div className="w-full md:w-1/2 space-y-3"><div className="flex justify-between text-sm text-slate-600"><span>Subtotal (Taxable)</span><span className="font-medium">₹{totals.subTotal.toFixed(2)}</span></div><div className="flex justify-between text-sm text-slate-600"><span>Total Tax (GST)</span><span className="font-medium">₹{totals.totalTax.toFixed(2)}</span></div>{details.freightCharge > 0 && ( <div className="flex justify-between text-sm text-slate-600"><span>Freight Charges</span><span className="font-medium">₹{details.freightCharge.toFixed(2)}</span></div> )}<div className="h-px bg-slate-200 my-3"></div><div className="flex justify-between items-end"><span className="text-xl font-bold text-slate-800">Grand Total</span><span className="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-violet-600">₹{totals.grandTotal.toFixed(2)}</span></div><div className="text-right text-xs text-slate-400 mt-1 font-medium">Inclusive of all taxes</div></div></div></div></div>
                    </div></div>
                </div>
            );
        };

       const pincodeCache = {};

const OrderRow = React.memo(({ order, onOpenPopup, onUpdate, onOpenTracking, settlementOptions }) => {
            const [district, setDistrict] = React.useState("");
            
            React.useEffect(() => {
                const pin = order.pincode || order.zip;
                if (!pin) return;
                const pinStr = String(pin).trim();
                if (pincodeCache[pinStr]) { setDistrict(pincodeCache[pinStr]); return; }
                if (pinStr.length === 6) {
                     fetch(`https://api.postalpincode.in/pincode/${pinStr}`)
                        .then(r => r.json())
                        .then(d => { if (d && d[0]?.Status === 'Success') { const dist = d[0].PostOffice[0].District; pincodeCache[pinStr] = dist; setDistrict(dist); } })
                        .catch(e => {});
                }
            }, [order.pincode, order.zip]);

            const getTrackingLink = (awb) => {
                if (!awb) return "";
                const str = String(awb).trim();
                const lower = str.toLowerCase();
                if (lower.startsWith("maa") || lower.startsWith("cod")) { return "https://www.tpcindia.com/track-info.aspx?id=" + str + "&type=0&service=0"; }
                if (lower.startsWith("et") || lower.startsWith("ct")) { return "https://www.ship24.com/tracking?p=" + str; }
                return "";
            };

            const trackingLink = getTrackingLink(order.awb);

            return (
                <tr className="hover:bg-indigo-50/30 transition-colors group">
                    <td className="px-4 py-3 align-top">
                        <button onClick={() => onOpenPopup(order.orderId)} className="w-full text-left bg-slate-50 hover:bg-white border border-transparent hover:border-indigo-200 rounded-lg p-2 transition-all group-hover:shadow-sm select-text">
                            <div className="font-bold text-indigo-700 font-mono text-xl">{order.billNo || "No Bill"}</div>
                            <div className="font-bold text-slate-800 text-xs mt-1">{order.orderId}</div>
                            <div className="text-[15px] text-slate-600 mt-0.5 font-medium">{formatDate(order.date)}</div>
                        </button>
                    </td>
                    <td className="px-4 py-3 align-top">
                        <div className="font-bold text-slate-800 text-[15px] truncate max-w-[200px]" title={order.customerName}>{order.customerName}</div>
                        <div className="text-[15px] text-green-600 font-mono font-bold mt-[0.65rem]">{order.contact}</div>
                        {(order.pincode || order.zip) && ( <div className="text-[13px] text-slate-700 font-bold mt-1"> {district ? `${district}-${order.pincode || order.zip}` : (order.pincode || order.zip)} </div> )}
                    </td>
                    <td className="px-4 py-3 align-top">
                        <div className={`text-[10px] font-bold px-2 py-1 rounded-full inline-block uppercase tracking-wide ${order.paymentType === 'Online Payment' ? 'bg-emerald-100 text-emerald-700 border border-emerald-200' : 'bg-amber-100 text-amber-700 border border-amber-200'}`}>
                            {order.paymentType === 'Online Payment' ? 'PREPAID' : 'COD'}
                        </div>
                    </td>
                    <td className="px-4 py-3 align-top text-xs font-bold text-slate-600">{order.totalQty}</td>
                    <td className="px-4 py-3 align-top text-sm font-extrabold text-slate-900">₹{order.totalAmount}</td>
                    <td className="px-4 py-3 align-top"><MultiSelectDropdown options={settlementOptions} value={order.settleType || ''} onChange={(val) => onUpdate(order.orderId, 'settleType', val)} /></td>
                    <td className="px-4 py-3 align-top">
                        <div className="flex items-center gap-2">
                            <input type="text" className="w-full bg-white border border-slate-200 rounded-lg px-2 py-1.5 text-xs font-mono text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500/20 transition-all placeholder-slate-300" placeholder="AWB Number" value={order.awb || ''} onChange={(e) => onUpdate(order.orderId, 'awb', e.target.value)} />
                            {trackingLink && ( 
                                <button 
                                    onClick={(e) => {
                                        e.preventDefault();
                                        onOpenTracking({
                                            link: trackingLink,
                                            orderId: order.orderId,
                                            customerName: order.customerName,
                                            contact: order.contact
                                        });
                                    }}
                                    className="p-1.5 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-lg transition-colors border border-indigo-100" 
                                    title="Track Shipment"
                                >
                                    <ExternalLink size={14} />
                                </button> 
                            )}
                        </div>
                    </td>
                    <td className="px-4 py-3 align-top"><select className={`w-full border rounded-lg px-2 py-1.5 text-xs font-bold outline-none focus:ring-2 focus:ring-indigo-500/20 transition-all ${order.trackingStatus === 'Packed' ? 'bg-amber-50 border-amber-200 text-amber-700' : order.trackingStatus === 'Shipped' ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-white border-slate-200 text-slate-600'}`} value={order.trackingStatus || 'Pending'} onChange={(e) => onUpdate(order.orderId, 'trackingStatus', e.target.value)}><option value="Pending">Pending</option><option value="Packed">Packed</option><option value="Shipped">Shipped</option><option value="In Transit">In Transit</option><option value="Delivered">Delivered</option><option value="Return">Return</option><option value="Cancel">Cancel</option></select></td>
                    <td className="px-4 py-3 align-top"><input type="text" className="w-full bg-white border border-slate-200 rounded-lg px-2 py-1.5 text-xs font-mono text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500/20 transition-all placeholder-slate-300" placeholder="Barcode" value={order.barcode || ''} onChange={(e) => onUpdate(order.orderId, 'barcode', e.target.value)} /></td>
                </tr>
            );
        });

        const TrackingModal = ({ data, onClose }) => {
            if (!data) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-[2rem] shadow-2xl w-full h-full max-w-6xl flex flex-col overflow-hidden animate-in fade-in zoom-in duration-200 border border-white/20">
                        {/* Header */}
                        <div className="bg-slate-900 text-white p-5 flex justify-between items-center bg-gradient-to-r from-slate-900 via-slate-800 to-indigo-950">
                            <div className="flex flex-wrap items-center gap-4 md:gap-8">
                                <div className="flex items-center gap-2">
                                    <div className="p-2 bg-indigo-600 rounded-lg shadow-inner">
                                        <Truck size={20} className="text-white"/>
                                    </div>
                                    <span className="font-black text-sm uppercase tracking-widest hidden sm:inline">Track Shipment</span>
                                </div>
                                
                                <div className="h-6 w-px bg-slate-700 hidden md:block"></div>
                                
                                <div className="flex flex-col">
                                    <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Order Reference</span>
                                    <span className="font-mono text-indigo-300 font-bold text-sm">{data.orderId}</span>
                                </div>

                                <div className="h-6 w-px bg-slate-700 hidden md:block"></div>

                                <div className="flex flex-col">
                                    <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Customer Name</span>
                                    <span className="font-bold text-sm text-slate-100">{data.customerName}</span>
                                </div>

                                <div className="h-6 w-px bg-slate-700 hidden md:block"></div>

                                <div className="flex flex-col">
                                    <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Contact Number</span>
                                    <div className="flex items-center gap-3">
                                        <span className="font-bold text-sm text-emerald-400">{data.contact}</span>
                                        <button 
                                            onClick={() => {
                                                navigator.clipboard.writeText(data.link);
                                                alert("Tracking link copied to clipboard!");
                                            }}
                                            className="p-1.5 bg-white/10 hover:bg-white/20 text-emerald-400 rounded-lg transition-colors border border-white/5 flex items-center gap-1.5 group"
                                            title="Copy Tracking Link"
                                        >
                                            <ClipboardPaste size={14} />
                                            <span className="text-[10px] font-bold uppercase tracking-tight group-hover:underline">Copy Link</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <button 
                                onClick={onClose} 
                                className="p-2 bg-white/5 hover:bg-white/10 text-white/60 hover:text-white rounded-full transition-all border border-white/5"
                            >
                                <X size={24} />
                            </button>
                        </div>
                        
                        {/* Iframe Content */}
                        <div className="flex-1 bg-slate-50 relative">
                            <iframe 
                                src={data.link} 
                                className="w-full h-full border-none bg-white" 
                                title="Tracking Provider Page"
                                sandbox="allow-same-origin allow-scripts allow-forms allow-popups"
                            ></iframe>
                        </div>

                        {/* Footer */}
                        <div className="bg-white p-3 border-t border-slate-100 flex justify-end">
                            <button 
                                onClick={onClose}
                                className="px-6 py-2 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition-colors shadow-lg"
                            >
                                Close View
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        
         const TrackAndUpdate = () => {
            const { orders, loading, refreshData, updateLocalOrder } = useOrders();
            const [searchTerm, setSearchTerm] = useState("");
            const [statusFilter, setStatusFilter] = useState("In Transit");
            const [settleTypeFilter, setSettleTypeFilter] = useState("All");
            const [fromDate, setFromDate] = useState("");
            const [toDate, setToDate] = useState("");
            const [popupOrder, setPopupOrder] = useState(null);
            const [trackingData, setTrackingData] = useState(null);
            const [visibleCount, setVisibleCount] = useState(50); 
            const [statusOpen, setStatusOpen] = useState(false);

            const STATUS_OPTIONS = [
              { value: "All", label: "All Status", icon: ListTodo, color: "text-slate-500" },
              { value: "Pending", label: "Pending", icon: ListTodo, color: "text-amber-500" },
              { value: "Packed", label: "Packed", icon: Package, color: "text-indigo-500" },
              { value: "Shipped", label: "Shipped", icon: Truck, color: "text-blue-500" },
              { value: "In Transit", label: "In Transit", icon: Navigation, color: "text-orange-500" },
              { value: "Delivered", label: "Delivered", icon: CheckCircle, color: "text-emerald-500" },
              { value: "Return", label: "Return", icon: RotateCcw, color: "text-violet-500" },
              { value: "Cancel", label: "Cancel", icon: XCircle, color: "text-red-500" }
            ];

            useEffect(() => {
                const today = new Date();
                const sixtyDaysAgo = new Date();
                sixtyDaysAgo.setDate(today.getDate() - 60);
                let fromDate;
                const monthStart = new Date(sixtyDaysAgo.getFullYear(), sixtyDaysAgo.getMonth(), 1);
                const diffDays = Math.floor((today - monthStart) / (1000 * 60 * 60 * 24));
                if (diffDays < 60) { fromDate = monthStart; } else { fromDate = new Date(sixtyDaysAgo.getFullYear(), sixtyDaysAgo.getMonth() + 1, 1); }
                setFromDate(getLocalDateString(fromDate));
                setToDate(getLocalDateString(today));
            }, []);
            
            useEffect(() => { setVisibleCount(50); }, [searchTerm, statusFilter, settleTypeFilter, fromDate, toDate]);

            const handleUpdate = useCallback((orderId, field, value) => {
                if (field === 'trackingStatus') {
                    const isMainOrder = !orderId.includes('Q');
                    if (isMainOrder) {
                        const isCancellation = value === "Cancel" || value === "Return";
                        orders.forEach(o => { if (o.orderId && o.orderId.startsWith(orderId + "Q")) { updateLocalOrder(o.orderId, { [field]: isCancellation ? value : "" }); } });
                    }
                }
                updateLocalOrder(orderId, { [field]: value });
            }, [updateLocalOrder, orders]);

            const handleScroll = (e) => { const { scrollTop, scrollHeight, clientHeight } = e.currentTarget; if (scrollHeight - scrollTop <= clientHeight + 100) { setVisibleCount(prev => prev + 50); } };
            
            const statusCounts = useMemo(() => {
                let raw = orders;
                if (searchTerm) { const lowerTerm = searchTerm.toLowerCase(); raw = raw.filter(o => (o.orderId && o.orderId.toLowerCase().includes(lowerTerm)) || (o.customerName && o.customerName.toLowerCase().includes(lowerTerm)) || (o.contact && String(o.contact).includes(searchTerm)) ); }
                if (fromDate && toDate) { 
                    const start = new Date(fromDate + "T00:00:00"); 
                    const end = new Date(toDate + "T23:59:59.999"); 
                    raw = raw.filter(o => { const oDate = o.date ? parseDate(o.date) : null; return oDate && oDate >= start && oDate <= end; }); 
                }
                if (settleTypeFilter !== "All") { raw = raw.filter(o => (o.settleType || "") === settleTypeFilter); }
                const uniqueMap = new Map(); 
                raw.forEach(o => { if (!o.orderId) return; if (!uniqueMap.has(o.orderId)) { uniqueMap.set(o.orderId, o); } else { const existing = uniqueMap.get(o.orderId); if ((!existing.totalAmount || existing.totalAmount === "0") && (o.totalAmount && o.totalAmount !== "0")) { uniqueMap.set(o.orderId, o); } } });
                const final = Array.from(uniqueMap.values());
                const counts = { All: final.length, Pending: 0, Packed: 0, Shipped: 0, 'In Transit': 0, Delivered: 0, Return: 0, Cancel: 0 };
                final.forEach(o => { const s = o.trackingStatus; if (counts[s] !== undefined) counts[s]++; });
                return counts;
            }, [orders, searchTerm, fromDate, toDate, settleTypeFilter]);

            const filteredOrders = useMemo(() => {
                let rawFiltered = orders;
                if (searchTerm) { const lowerTerm = searchTerm.toLowerCase(); rawFiltered = rawFiltered.filter(o => (o.orderId && o.orderId.toLowerCase().includes(lowerTerm)) || (o.customerName && o.customerName.toLowerCase().includes(lowerTerm)) || (o.contact && String(o.contact).includes(searchTerm)) ); }
                if (fromDate && toDate) { 
                    const start = new Date(fromDate + "T00:00:00"); 
                    const end = new Date(toDate + "T23:59:59.999"); 
                    rawFiltered = rawFiltered.filter(o => { const oDate = o.date ? parseDate(o.date) : null; return oDate && oDate >= start && oDate <= end; }); 
                }
                if (statusFilter !== "All") rawFiltered = rawFiltered.filter(o => o.trackingStatus === statusFilter);
                if (settleTypeFilter !== "All") rawFiltered = rawFiltered.filter(o => (o.settleType || "") === settleTypeFilter);
                const uniqueMap = new Map(); 
                rawFiltered.forEach(o => { if (!o.orderId) return; if (!uniqueMap.has(o.orderId)) { uniqueMap.set(o.orderId, o); } else { const existing = uniqueMap.get(o.orderId); if ((!existing.totalAmount || existing.totalAmount === "0") && (o.totalAmount && o.totalAmount !== "0")) { uniqueMap.set(o.orderId, o); } } });
                return Array.from(uniqueMap.values()).sort((a, b) => { const numA = parseFloat(String(a.billNo || "").replace(/\D/g, "")) || 0; const numB = parseFloat(String(b.billNo || "").replace(/\D/g, "")) || 0; return numA - numB; });
            }, [orders, searchTerm, fromDate, toDate, statusFilter, settleTypeFilter]);

            const popupItems = useMemo(() => { if (!popupOrder) return []; return orders.filter(o => { if (!o.orderId) return false; return o.orderId === popupOrder || o.orderId.startsWith(popupOrder + "Q"); }).sort((a, b) => { return a.orderId.length - b.orderId.length || a.orderId.localeCompare(b.orderId); }); }, [orders, popupOrder]);
            
             const handleExportCSV = () => {
  try {
    const headers = [
      "Date",
      "Invoice No",
      "Order Number",
      "Customer Name",
      "Mobile Number",
      "Pincode",
      "State",
      "Full Address",
      "Pay Mode",
      "Qty",
      "Amount",
      "AWB",
      "Settle Type",
      "Status",
      "Barcode"
    ];

    const clean = (val) =>
      `"${String(val ?? "").replace(/"/g, '""')}"`;

    const rows = filteredOrders.map(order => {
      const dateStr = order.date
        ? new Date(order.date).toLocaleDateString("en-GB")
        : "";

      let payMode = order.paymentMode || order.mode || "";
      if (!payMode) {
        const sType = (order.settleType || "").toLowerCase();
        payMode = [
          "cc avenue",
          "cc avenue-link",
          "account transfer",
          "cash free",
          "upi store"
        ].includes(sType)
          ? "Prepaid"
          : "COD";
      }

      return [
        clean(dateStr),
        clean(order.billNo),
        clean(order.orderId),
        clean(order.customerName),
        clean(order.contact),
        clean(order.pincode || order.zip),
        clean(order.state),
        clean(order.address || order.fullAddress),
        clean(payMode),
        clean(order.qty || order.quantity),
        clean(order.totalAmount),
        clean(order.awb),
        clean(order.settleType),
        clean(order.trackingStatus),
        clean(order.barcode || "")
      ].join(",");
    });

    const csv = [headers.join(","), ...rows].join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const link = document.createElement("a");
    link.href = url;
    link.download = `Track_Export_${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

  } catch (err) {
    console.error("CSV Export Failed:", err);
    alert("Export failed. Please try again.");
  }
};

            return (
                <div className="w-full max-w-[1800px] mx-auto p-4 md:p-6 h-[calc(100vh-4rem)] flex flex-col space-y-4">
                    <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex flex-col xl:flex-row justify-between items-center gap-4"><div className="flex items-center gap-4"><div className="bg-gradient-to-br from-indigo-600 to-violet-600 p-2.5 rounded-xl text-white shadow-lg shadow-indigo-200"><Truck size={24}/></div><div><h1 className="text-xl font-bold text-slate-800">Track & Update</h1><div className="flex gap-3 text-xs font-medium text-slate-500 mt-1"><span>Total: <span className="text-slate-900 font-bold">{filteredOrders.length}</span></span><span>Packed: <span className="text-amber-600 font-bold">{orders.filter(o => o.trackingStatus === 'Packed').length}</span></span><span>Shipped: <span className="text-emerald-600 font-bold">{orders.filter(o => o.trackingStatus === 'Shipped').length}</span></span></div></div></div><div className="flex flex-col md:flex-row items-center gap-3 w-full xl:w-auto"><div className="flex items-center gap-2 bg-slate-50 p-2 rounded-xl border border-slate-200 w-full md:w-auto shadow-inner"><span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider px-1">Date Range</span><input type="date" className="bg-transparent text-xs outline-none text-slate-700 font-bold" value={fromDate} onChange={e => setFromDate(e.target.value)} /><span className="text-slate-300">-</span><input type="date" className="bg-transparent text-xs outline-none text-slate-700 font-bold" value={toDate} onChange={e => setToDate(e.target.value)} /></div><div className="relative flex-1 md:w-64 w-full"><Search className="absolute left-3 top-2.5 text-slate-400" size={16} /><input type="text" placeholder="Search orders..." className="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/20 transition-all" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                   <button onClick={refreshData} className="p-2 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Refresh from Sheet"><RefreshCw size={20} className={loading ? "animate-spin" : ""} /></button>
                    <button onClick={handleExportCSV} className="p-2 text-slate-500 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors" title="Export CSV"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                    </div></div>
                    <div className="bg-white border border-slate-200 rounded-2xl shadow-sm flex-1 overflow-hidden flex flex-col relative">
                        <div className="overflow-auto custom-scrollbar flex-1" onScroll={handleScroll}>
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-50 text-slate-500 font-bold text-[10px] uppercase tracking-wider sticky top-0 z-10 shadow-sm border-b border-slate-200">
                                    <tr><th className="px-4 py-3 w-40">Date & Order</th><th className="px-4 py-3 w-64">Customer</th><th className="px-4 py-3 w-36">Pay Mode</th><th className="px-4 py-3 w-24">Qty</th><th className="px-4 py-3 w-28">Amount</th><th className="px-4 py-3 w-64"><div className="flex flex-col gap-1"><span>Settle Type</span><select value={settleTypeFilter} onChange={(e) => setSettleTypeFilter(e.target.value)} className="w-full bg-transparent font-bold text-indigo-600 outline-none cursor-pointer text-xs p-0 border-none focus:ring-0"><option value="All">All Types</option>{SETTLEMENT_OPTIONS.map(opt => (<option key={opt} value={opt}>{opt}</option>))}</select></div></th><th className="px-4 py-3 w-48">AWB No</th><th className="px-4 py-3 w-40"><div className="flex flex-col gap-1"><span>Status</span><div className="relative w-full">
  <button onClick={() => setStatusOpen(!statusOpen)} className="w-full flex items-center justify-between bg-white text-indigo-700 font-semibold text-[14px] px-3 py-1.5 rounded-lg border border-indigo-200 shadow-sm hover:bg-slate-50 transition-all">
    <div className="flex items-center gap-2">
      {(() => { const current = STATUS_OPTIONS.find(s => s.value === statusFilter); const Icon = current.icon; return <Icon size={16} className={current.color} />; })()}
      <span>{statusFilter}</span>
    </div>
    <ChevronDown size={16} className="text-indigo-500" />
  </button>
  {statusOpen && ( <div className="absolute z-50 mt-2 w-full bg-white rounded-xl border border-slate-200 shadow-lg overflow-hidden" onClick={(e) => e.stopPropagation()}> {STATUS_OPTIONS.map(({ value, label, icon: Icon, color }) => ( <div key={value} onClick={() => { setStatusFilter(value); setStatusOpen(false); }} className="flex items-center justify-between px-4 py-2 cursor-pointer text-[12px] font-medium hover:bg-indigo-50" > <div className="flex items-center gap-2"> <Icon size={16} className={color} /> {label} </div> <span className="text-indigo-600 font-bold text-xs"> {statusCounts[value] ?? ""} </span> </div> ))} </div> )}
</div>
</div></th><th className="px-4 py-3 w-48">Barcode</th></tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {filteredOrders.slice(0, visibleCount).map((order) => ( <OrderRow key={order.orderId} order={order} onOpenPopup={setPopupOrder} onUpdate={handleUpdate} onOpenTracking={setTrackingData} settlementOptions={SETTLEMENT_OPTIONS} /> ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {popupOrder && (
                         <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setPopupOrder(null)}>
                            <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden animate-in fade-in zoom-in duration-200 border border-slate-200" onClick={e => e.stopPropagation()}>
                                <div className="bg-slate-50 p-4 border-b border-slate-200 flex justify-between items-center"><div><h3 className="font-bold text-lg text-slate-800">Order Details</h3><p className="text-xs text-indigo-600 font-mono font-bold mt-1">{popupOrder}</p></div><button onClick={() => setPopupOrder(null)} className="p-1 hover:bg-slate-200 rounded-full transition-colors"><X size={20} className="text-slate-500" /></button></div>
                                <div className="p-0 max-h-[60vh] overflow-y-auto custom-scrollbar"><table className="w-full text-sm text-left"><thead className="text-[10px] font-bold text-slate-500 uppercase bg-slate-50 border-b border-slate-100 sticky top-0 tracking-wider"><tr><th className="px-4 py-3">Product</th><th className="px-4 py-3 text-right">MRP</th><th className="px-4 py-3 text-right">Qty</th><th className="px-4 py-3 text-right">Total</th></tr></thead><tbody className="divide-y divide-slate-100">{popupItems.map((item, idx) => ( <tr key={idx}><td className="px-4 py-3"><div className="font-medium text-slate-800">{item.productName}</div><div className="text-[10px] text-slate-400 font-mono mt-0.5">HSN: {item.hsn}</div></td><td className="px-4 py-3 text-right text-slate-500">{item.mrp}</td><td className="px-4 py-3 text-right font-bold text-slate-800">{item.qty || item.quantity}</td><td className="px-4 py-3 text-right font-bold text-indigo-700">₹{parseFloat(item.price || item.totalAmount || 0).toFixed(2)}</td></tr> ))}</tbody></table></div>
                                <div className="p-4 bg-slate-50 border-t border-slate-200 text-right"><button onClick={() => setPopupOrder(null)} className="px-5 py-2 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-900 transition-colors">Close</button></div>
                            </div>
                        </div>
                    )}
                    <TrackingModal data={trackingData} onClose={() => setTrackingData(null)} />
                </div>
            );
        };
        


        const SettlementPage = () => {
    const { orders, updateLocalOrder } = useOrders();
    const [selectedType, setSelectedType] = useState("CC Avenue");
    const [activeTab, setActiveTab] = useState('pending');
    const [dateRange, setDateRange] = useState({ start: '', end: '' });
    const [searchTerm, setSearchTerm] = useState("");
    const [settledDateFilter, setSettledDateFilter] = useState("");
    const [showSettleModal, setShowSettleModal] = useState(false);
    const [settleModalData, setSettleModalData] = useState(null); 
    
    const getLocalISODate = (dateInput) => {
        if (!dateInput) return '';
        const d = typeof dateInput === 'string' ? new Date(dateInput) : dateInput;
        if (isNaN(d.getTime())) return '';
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    const formatDate = (dateString) => { 
        if (!dateString) return '-'; 
        const date = new Date(dateString); 
        if (isNaN(date.getTime())) return dateString; 
        return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    };

    const parseDate = (dateVal) => { 
        if (!dateVal) return null; 
        if (typeof dateVal === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateVal)) {
            return new Date(dateVal);
        }
        const d = new Date(dateVal); 
        if (!isNaN(d.getTime())) return d; 
        return null; 
    };

    const parseExcelDate = (excelDate) => {
        if (!excelDate) return '';
        if (typeof excelDate === 'number') {
            const date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
            return getLocalISODate(date);
        }
        const d = new Date(excelDate);
        if (!isNaN(d.getTime())) return getLocalISODate(d);
        return '';
    };

    const [settleForm, setSettleForm] = useState({ amount: '', date: getLocalISODate(new Date()), utr: '', charge: '', type: '' });
    
    const [wizardStep, setWizardStep] = useState(0); 
    const [excelData, setExcelData] = useState([]);
    const [excelHeaders, setExcelHeaders] = useState([]);
    const [uploadMode, setUploadMode] = useState('settlement');
    const [useCommonDate, setUseCommonDate] = useState(false);
    const [commonDate, setCommonDate] = useState(getLocalISODate(new Date()));
    const [colMapping, setColMapping] = useState({
        orderId: '',
        awb: '',
        date: '',
        amount: '',
        charge: '',
        utr: ''
    });
    const [parsedData, setParsedData] = useState([]);
    const fileInputRef = useRef(null);
    
    useEffect(() => { 
        const now = new Date(); 
        const start = getLocalISODate(new Date(now.getFullYear(), now.getMonth(), 1)); 
        const end = getLocalISODate(new Date()); 
        setDateRange({ start, end }); 
    }, []);

    const getSettlementStats = (order) => { 
        const totalOrderAmount = parseFloat(String(order.totalAmount || order.price || "0").replace(/,/g, '')) || 0; 
        
        const settledStr = String(order.settledAmount || ""); 
        const settledParts = settledStr.split('|').map(s => parseFloat(s.trim().replace(/,/g, '')) || 0); 
        const totalSettled = settledParts.reduce((a, b) => a + b, 0); 

        const chargeStr = String(order.settlementCharge || "");
        const chargeParts = chargeStr.split('|').map(s => parseFloat(s.trim().replace(/,/g, '')) || 0);
        const totalCharges = chargeParts.reduce((a, b) => a + b, 0);

        const remaining = totalOrderAmount - totalSettled - totalCharges; 
        let status = 'Unsettled'; 
        if ((totalSettled + totalCharges) === 0) status = 'Unsettled'; 
        else if (remaining > 5) status = 'Partial'; 
        else if (remaining < -5) status = 'Overpaid'; 
        else status = 'Settled'; 
        
        return { totalOrderAmount, totalSettled, totalCharges, remaining, status, settledParts, chargeParts }; 
    };

    const updateOrAppendSplit = (existing, typeToUpdateRaw, newAmount, newDate, newUtr, newCharge) => {
        const typeToUpdate = (typeToUpdateRaw || "").trim();
        const totalOrderAmount = parseFloat(String(existing.totalAmount || existing.price || "0").replace(/,/g, '')) || 0;
        
        let settleTypes = String(existing.settleType || "").split('|').map(s => s.trim()).filter(s => s !== "");
        let settledAmounts = String(existing.settledAmount || "").split('|').map(s => s.trim());
        let settledDates = String(existing.settledDate || "").split('|').map(s => s.trim());
        let settledUtrs = String(existing.settledUtr || "").split('|').map(s => s.trim());
        let settlementCharges = String(existing.settlementCharge || "").split('|').map(s => s.trim());

        const syncArray = (arr, len) => {
            let newArr = [...arr];
            while (newArr.length < len) newArr.push("");
            return newArr.slice(0, len);
        };
        
        settledAmounts = syncArray(settledAmounts, settleTypes.length);
        settledDates = syncArray(settledDates, settleTypes.length);
        settledUtrs = syncArray(settledUtrs, settleTypes.length);
        settlementCharges = syncArray(settlementCharges, settleTypes.length);

        let index = settleTypes.findIndex(t => t.toLowerCase() === typeToUpdate.toLowerCase());
        
        if (index >= 0) {
            const amtVal = parseFloat(newAmount) || 0;
            
            let otherPaymentsTotal = 0;
            settledAmounts.forEach((val, i) => {
                if (i !== index) otherPaymentsTotal += (parseFloat(val) || 0);
            });
            
            let otherChargesTotal = 0;
            settlementCharges.forEach((val, i) => {
                if (i !== index) otherChargesTotal += (parseFloat(val) || 0);
            });

            const calculatedCharge = Math.max(0, totalOrderAmount - otherPaymentsTotal - otherChargesTotal - amtVal).toFixed(2);
            
            settledAmounts[index] = amtVal.toFixed(2);
            settledDates[index] = newDate;
            settledUtrs[index] = newUtr;
            settlementCharges[index] = calculatedCharge;
        } else {
            settleTypes.push(typeToUpdate);
            settledAmounts.push(parseFloat(newAmount || "0").toFixed(2));
            settledDates.push(newDate);
            settledUtrs.push(newUtr);
            settlementCharges.push(newCharge || "0.00");
        }

        return {
            settleType: settleTypes.join(' | '),
            settledAmount: settledAmounts.join(' | '),
            settledDate: settledDates.join(' | '),
            settledUtr: settledUtrs.join(' | '),
            settlementCharge: settlementCharges.join(' | '),
        };
    };
    
    const filteredOrders = useMemo(() => { 
        return orders.filter(o => { 
            if (searchTerm) { 
                const term = searchTerm.toLowerCase(); 
                const matchesOrder = String(o.orderId || "").toLowerCase().includes(term); 
                const matchesAwb = String(o.awb || "").toLowerCase().includes(term); 
                if (!matchesOrder && !matchesAwb) return false; 
            } 
            if (activeTab === 'bulk') return true; 
            if (!selectedType) return true; 
            return (o.settleType || "").toLowerCase().includes(selectedType.toLowerCase()); 
        }); 
    }, [orders, selectedType, searchTerm, activeTab]);
    
    const displayOrders = useMemo(() => { 
        let list = filteredOrders; 
        if (activeTab === 'pending') { 
            list = list.filter(o => { const stats = getSettlementStats(o); return stats.status === 'Unsettled' || stats.status === 'Partial'; }); 
        } else if (activeTab === 'settled') { 
            list = list.filter(o => { const stats = getSettlementStats(o); return stats.totalSettled > 0 || stats.totalCharges > 0; }); 
            if (settledDateFilter) { 
                list = list.filter(o => {
                    if (!o.settledDate) return false;
                    return o.settledDate.split('|').some(dStr => {
                        const d = new Date(dStr.trim());
                        if (isNaN(d.getTime())) return dStr.includes(settledDateFilter);
                        return getLocalISODate(d) === settledDateFilter;
                    });
                }); 
            } 
        } 
        
        if (dateRange.start && dateRange.end && activeTab !== 'bulk') { 
            const start = new Date(dateRange.start); 
            const end = new Date(dateRange.end); 
            list = list.filter(o => { 
                const d = parseDate(o.date); 
                return d && d >= start && d <= end; 
            }); 
        } 
        return list; 
    }, [filteredOrders, activeTab, dateRange, settledDateFilter]);

    const stats = useMemo(() => {
        let totalAmt = 0;
        let settledAmt = 0;
        let pendingAmt = 0;
        let count = 0;

        filteredOrders.forEach(o => {
            const { totalOrderAmount, totalSettled, status } = getSettlementStats(o);
            totalAmt += totalOrderAmount;
            settledAmt += totalSettled;
            if (status !== "Settled" && status !== "Overpaid") {
                pendingAmt += (totalOrderAmount - totalSettled);
            }
            count++;
        });

        return { totalAmt, settledAmt, pendingAmt, count };
    }, [filteredOrders]);

    const handleExportCSV = () => { 
        const headers = ["Order Date", "Order ID", "AWB", "Bill No", "Customer", "Bill Amount", "Settled Amount", "Charges", "Remaining", "Settled Date", "Status", "Settle Type"]; 
        const rows = displayOrders.map(o => { 
            const { totalOrderAmount, totalSettled, totalCharges, remaining, status } = getSettlementStats(o); 
            const formattedSettledDate = o.settledDate ? o.settledDate.split('|').map(d => formatDate(d.trim())).join(' | ') : ""; 
            return [formatDate(o.date), o.orderId, o.awb || "", o.billNo || "", o.customerName || "", totalOrderAmount, totalSettled, totalCharges, remaining, formattedSettledDate, status, o.settleType || ""].map(v => `"${String(v).replace(/"/g, '""')}"`).join(","); 
        }); 
        const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows].join("\n"); 
        const encodedUri = encodeURI(csvContent); 
        const link = document.createElement("a"); 
        link.setAttribute("href", encodedUri); 
        link.setAttribute("download", `Settlement_${activeTab}_${getLocalISODate(new Date())}.csv`); 
        document.body.appendChild(link); 
        link.click(); 
        document.body.removeChild(link); 
    };
    
    const handleFileUpload = (e) => {
        if (typeof XLSX === "undefined") {
            alert("Excel reader not loaded. Please refresh.");
            return;
        }
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            const bstr = evt.target.result;
            const wb = XLSX.read(bstr, { type: "binary" });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(ws, { defval: "" });
            if (!data.length) {
                alert("Empty Excel file");
                return;
            }
            setExcelData(data);
            setExcelHeaders(Object.keys(data[0]));
            setWizardStep(1);
        };
        reader.readAsBinaryString(file);
    };

    const handleMappingSubmit = () => {
        if (!colMapping.orderId && !colMapping.awb) {
            alert("Please map at least Order ID or AWB");
            return;
        }
        const newParsedData = excelData.map((row, idx) => {
            const rowOrderId = row[colMapping.orderId]?.toString().trim();
            const rowAwb = row[colMapping.awb]?.toString().trim();
            let existingOrder;
            if (rowOrderId) {
                existingOrder = orders.find(o => String(o.orderId || "").toLowerCase() === rowOrderId.toLowerCase());
            }
            if (!existingOrder && rowAwb) {
                const cleanInputAwb = rowAwb.toLowerCase();
                existingOrder = orders.find(o => {
                    const dbAwb = String(o.awb || "").toLowerCase();
                    if (!dbAwb) return false;
                    if (dbAwb === cleanInputAwb) return true;
                    if (dbAwb.includes(',')) {
                        const parts = dbAwb.split(',').map(s => s.trim());
                        return parts.includes(cleanInputAwb);
                    }
                    if (dbAwb.includes(cleanInputAwb) || cleanInputAwb.includes(dbAwb)) return true;
                    return false;
                });
            }
            const settleAmtRaw = uploadMode !== 'charges' ? parseFloat(String(row[colMapping.amount] || "0").replace(/,/g, '')) : 0;
            const chargeAmtRaw = uploadMode !== 'settlement' ? parseFloat(String(row[colMapping.charge] || "0").replace(/,/g, '')) : 0;
            let dateVal = useCommonDate ? commonDate : parseExcelDate(row[colMapping.date]);
            const utrVal = row[colMapping.utr] || "";
            let status = 'ready';
            let msg = 'Ready';
            let orderTotal = 0;
            if (!existingOrder) {
                status = 'error';
                msg = 'Not Found';
            } else {
                const stats = getSettlementStats(existingOrder);
                orderTotal = stats.totalOrderAmount;
                if (uploadMode === 'settlement' || uploadMode === 'both') {
                    if (settleAmtRaw > orderTotal + 10) {
                         status = 'warning';
                         msg = 'Possible Overpay';
                    }
                }
            }
            return {
                id: idx,
                foundOrder: existingOrder,
                inputOrderId: rowOrderId,
                inputAwb: rowAwb,
                settledAmount: settleAmtRaw,
                chargeAmount: chargeAmtRaw,
                settledDate: dateVal,
                settledUtr: utrVal,
                status,
                msg,
                orderTotal
            };
        });
        setParsedData(newParsedData);
        setWizardStep(2);
    };

    const handleExecuteBulk = () => {
        const toProcess = parsedData.filter(p => p.status !== 'error');
        if (toProcess.length === 0) return;
        toProcess.forEach(p => {
            const orderId = p.foundOrder.orderId;
            const existing = orders.find(o => o.orderId === orderId);
            if (!existing) return;
            const typeToProcess = selectedType;
            let newAmount = p.settledAmount.toFixed(2);
            let newDate = p.settledDate;
            let newUtr = p.settledUtr;
            let newCharge = p.chargeAmount > 0 ? p.chargeAmount.toFixed(2) : "";
            const result = updateOrAppendSplit(existing, typeToProcess, newAmount, newDate, newUtr, newCharge);
            const updates = { 
                ...result,
                "Settle Type": result.settleType, 
                "Settled Amount": result.settledAmount, 
                "Settled Date": result.settledDate, 
                "Settled UTR": result.settledUtr, 
                "Settlement Charge": result.settlementCharge 
            };
            updateLocalOrder(orderId, updates);
        });
        alert(`Processed ${toProcess.length} records successfully.`);
        setWizardStep(0);
        setExcelData([]);
        setParsedData([]);
        if (fileInputRef.current) fileInputRef.current.value = "";
        setActiveTab('settled');
    };

    const handleOpenSettleModal = (order) => { 
        const { remaining } = getSettlementStats(order); 
        setSettleModalData(order); 
        setSettleForm({ amount: remaining > 0 ? remaining.toString() : '', date: getLocalISODate(new Date()), utr: '', charge: '', type: order.settleType?.split('|')[0]?.trim() || selectedType }); 
        setShowSettleModal(true); 
    };
    
    const handleSettleSubmit = () => { 
        if (!settleModalData) return; 
        const existing = settleModalData; 
        const result = updateOrAppendSplit(existing, settleForm.type, parseFloat(settleForm.amount).toFixed(2), settleForm.date, settleForm.utr, settleForm.charge || "0");
        const updates = { 
                ...result,
                "Settle Type": result.settleType, 
                "Settled Amount": result.settledAmount, 
                "Settled Date": result.settledDate, 
                "Settled UTR": result.settledUtr, 
                "Settlement Charge": result.settlementCharge 
        };
        updateLocalOrder(existing.orderId, updates); 
        setShowSettleModal(false); 
    };

            return (
                <div className="w-full max-w-[1600px] mx-auto p-6 space-y-6 h-[calc(100vh-4rem)] flex flex-col">
                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center gap-6"><div><h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">Settlement <span className="text-indigo-600">& Reconciliation</span></h1><p className="text-slate-500 text-sm mt-1">Manage payment settlements and reconcile bank statements.</p></div><div className="flex flex-col sm:flex-row gap-4 w-full md:w-auto items-end"><div className="flex flex-col"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 px-1">Find Order / AWB</label><div className="relative"><Search className="absolute left-2 top-2.5 text-slate-400" size={14} /><input type="text" className="pl-8 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/20 transition-all w-52 font-medium" placeholder="Order # or AWB..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div></div>{activeTab !== 'bulk' && (<div className="bg-slate-50 p-1.5 rounded-lg border border-slate-200"><label className="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-0.5 px-1">Settle Type</label><select className="bg-transparent font-bold text-slate-700 outline-none w-48 text-sm py-0.5" value={selectedType} onChange={(e) => setSelectedType(e.target.value)}>{SETTLEMENT_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select></div>)}{activeTab !== 'bulk' && (<div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200 h-[46px] shadow-sm"><input type="date" className="bg-transparent text-xs font-bold outline-none text-slate-700" value={dateRange.start} onChange={e => setDateRange({ ...dateRange, start: e.target.value })} /><span className="text-slate-300">-</span><input type="date" className="bg-transparent text-xs font-bold outline-none text-slate-700" value={dateRange.end} onChange={e => setDateRange({ ...dateRange, end: e.target.value })} /></div>)}{activeTab !== 'bulk' && (<button onClick={handleExportCSV} className="flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-emerald-700 transition-colors shadow-lg shadow-emerald-200 h-[46px]"><Upload size={14} className="rotate-360" /> Export DATA</button>)}</div></div>
                    {activeTab !== 'bulk' && (<div className="grid grid-cols-1 md:grid-cols-4 gap-4"><div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm"><div className="text-xs font-bold text-slate-400 uppercase">Total Orders</div><div className="text-2xl font-bold text-slate-800 mt-1">{stats.count}</div></div><div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm"><div className="text-xs font-bold text-slate-400 uppercase">Total Value</div><div className="text-2xl font-bold text-slate-800 mt-1">₹{stats.totalAmt.toLocaleString()}</div></div><div className="bg-orange-50/50 p-4 rounded-xl border border-orange-100 shadow-sm"><div className="text-xs font-bold text-orange-500 uppercase">Pending Settlement</div><div className="text-2xl font-bold text-orange-700 mt-1">₹{stats.pendingAmt.toLocaleString()}</div></div><div className="bg-emerald-50/50 p-4 rounded-xl border border-emerald-100 shadow-sm"><div className="text-xs font-bold text-emerald-500 uppercase">Settled Amount</div><div className="text-2xl font-bold text-emerald-700 mt-1">₹{stats.settledAmt.toLocaleString()}</div></div></div>)}
                    
                    <div className="bg-white border border-slate-200 rounded-2xl shadow-sm flex-1 overflow-hidden flex flex-col relative">
                        <div className="flex border-b border-slate-100">
                            <button onClick={() => setActiveTab('pending')} className={`px-6 py-4 text-sm font-bold border-b-2 transition-all ${activeTab === 'pending' ? 'border-orange-500 text-orange-600 bg-orange-50' : 'border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50'}`}>Pending Settlements</button>
                            <button onClick={() => setActiveTab('settled')} className={`px-6 py-4 text-sm font-bold border-b-2 transition-all ${activeTab === 'settled' ? 'border-emerald-500 text-emerald-600 bg-emerald-50' : 'border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50'}`}>Settled History</button>
                            <button onClick={() => setActiveTab('bulk')} className={`px-6 py-4 text-sm font-bold border-b-2 transition-all flex items-center gap-2 ${activeTab === 'bulk' ? 'border-indigo-500 text-indigo-600 bg-indigo-50' : 'border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-50'}`}><Upload size={16} /> Bulk Settlement / Charge Upload</button>
                        </div>
                        
                        <div className="flex-1 overflow-auto custom-scrollbar p-0 bg-white">
                            {activeTab === 'bulk' ? (
                                <div className="p-8 max-w-5xl mx-auto">
                                    {/* Wizard Steps Indicator */}
                                    <div className="flex items-center justify-between mb-8 max-w-2xl mx-auto">
                                        <div className={`flex items-center gap-2 ${wizardStep >= 0 ? 'text-indigo-600' : 'text-slate-300'}`}><span className="w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold border-current">1</span><span className="font-bold text-sm">Upload</span></div>
                                        <div className={`h-0.5 flex-1 mx-4 ${wizardStep >= 1 ? 'bg-indigo-600' : 'bg-slate-200'}`}></div>
                                        <div className={`flex items-center gap-2 ${wizardStep >= 1 ? 'text-indigo-600' : 'text-slate-300'}`}><span className="w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold border-current">2</span><span className="font-bold text-sm">Map & Config</span></div>
                                        <div className={`h-0.5 flex-1 mx-4 ${wizardStep >= 2 ? 'bg-indigo-600' : 'bg-slate-200'}`}></div>
                                        <div className={`flex items-center gap-2 ${wizardStep >= 2 ? 'text-indigo-600' : 'text-slate-300'}`}><span className="w-8 h-8 rounded-full border-2 flex items-center justify-center font-bold border-current">3</span><span className="font-bold text-sm">Preview</span></div>
                                    </div>

                                    {/* Step 1: Upload */}
                                    {wizardStep === 0 && (
                                        <div className="bg-slate-50 border-2 border-dashed border-slate-300 rounded-2xl p-12 text-center hover:bg-indigo-50/50 hover:border-indigo-300 transition-all group">
                                            <div className="w-16 h-16 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform text-indigo-600"><FileSpreadsheet size={32} /></div>
                                            <h3 className="text-xl font-bold text-slate-800 mb-2">Upload Settlement File</h3>
                                            <p className="text-slate-500 text-sm mb-6">Supports Excel (.xlsx, .xls) or CSV. Infinite columns supported.</p>
                                            <input type="file" ref={fileInputRef} accept=".xlsx, .xls, .csv" onChange={handleFileUpload} className="hidden" id="file-upload" />
                                            <label htmlFor="file-upload" className="inline-block px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl cursor-pointer hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-colors">Select File</label>
                                        </div>
                                    )}

                                    {/* Step 2: Configuration */}
                                    {wizardStep === 1 && (
                                        <div className="space-y-6 animate-in slide-in-from-right-8 fade-in duration-300">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                {/* Left Panel: Settings */}
                                                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-6">
                                                    <h3 className="font-bold text-slate-800 flex items-center gap-2 pb-2 border-b border-slate-100"><Settings size={18} /> Upload Settings</h3>
                                                    
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Upload Type</label>
                                                        <div className="space-y-2">
                                                            {['settlement', 'charges', 'both'].map((mode) => (
                                                                <label key={mode} className={`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition-all ${uploadMode === mode ? 'border-indigo-500 bg-indigo-50 text-indigo-700' : 'border-slate-200 hover:bg-slate-50'}`}>
                                                                    <input type="radio" name="uploadMode" value={mode} checked={uploadMode === mode} onChange={() => setUploadMode(mode)} className="accent-indigo-600 w-4 h-4" />
                                                                    <span className="capitalize font-bold text-sm">{mode === 'both' ? 'Settlement + Charges' : `${mode} Upload`}</span>
                                                                </label>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Select Payment Type for this batch */}
                                                    <div>
                                                        <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Settlement Type To Apply</label>
                                                        <select className="w-full text-sm p-3 rounded-lg border border-slate-200 bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500/20 font-bold text-slate-700" value={selectedType} onChange={(e) => setSelectedType(e.target.value)}>
                                                            {SETTLEMENT_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                        </select>
                                                    </div>

                                                    <div>
                                                        <label className="flex items-center gap-2 cursor-pointer mb-2">
                                                            <input type="checkbox" checked={useCommonDate} onChange={(e) => setUseCommonDate(e.target.checked)} className="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
                                                            <span className="text-sm font-bold text-slate-700">Use Common Settled Date</span>
                                                        </label>
                                                        {useCommonDate && (
                                                            <div className="flex items-center gap-2 mt-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                                                <Calendar size={16} className="text-slate-400" />
                                                                <input type="date" value={commonDate} onChange={(e) => setCommonDate(e.target.value)} className="bg-transparent text-sm font-bold text-slate-700 outline-none w-full" />
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>

                                                {/* Right Panel: Mapping */}
                                                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                                                    <h3 className="font-bold text-slate-800 flex items-center gap-2 pb-2 border-b border-slate-100"><FileSpreadsheet size={18} /> Column Mapping</h3>
                                                    
                                                    <div className="space-y-3">
                                                        {[
                                                            { key: 'orderId', label: 'Order No', req: true },
                                                            { key: 'awb', label: 'AWB', req: true },
                                                            { key: 'date', label: 'Settled Date', req: !useCommonDate && uploadMode !== 'charges', hide: useCommonDate },
                                                            { key: 'amount', label: 'Settled Amount', req: uploadMode !== 'charges', hide: uploadMode === 'charges' },
                                                            { key: 'charge', label: 'Charges', req: uploadMode !== 'settlement', hide: uploadMode === 'settlement' },
                                                            { key: 'utr', label: 'UTR (Optional)', req: false, hide: uploadMode === 'charges' }
                                                        ].map((field) => (
                                                            !field.hide && (
                                                                <div key={field.key} className="flex flex-col">
                                                                    <label className="text-[11px] font-bold text-slate-500 uppercase mb-1 flex justify-between">
                                                                        {field.label} {field.req && <span className="text-red-500">*</span>}
                                                                    </label>
                                                                    <select 
                                                                        className={`w-full text-sm p-2 rounded-lg border outline-none focus:ring-2 focus:ring-indigo-500/20 ${colMapping[field.key] ? 'border-indigo-300 bg-indigo-50 text-indigo-900 font-bold' : 'border-slate-200 bg-slate-50 text-slate-500'}`}
                                                                        value={colMapping[field.key]}
                                                                        onChange={(e) => setColMapping({...colMapping, [field.key]: e.target.value})}
                                                                    >
                                                                        <option value="">Select Column...</option>
                                                                        {excelHeaders.map(h => <option key={h} value={h}>{h}</option>)}
                                                                    </select>
                                                                </div>
                                                            )
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="flex justify-between items-center pt-4">
                                                <button onClick={() => setWizardStep(0)} className="text-slate-500 font-bold hover:text-slate-800 text-sm">Back</button>
                                                <button onClick={handleMappingSubmit} className="px-6 py-2.5 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 flex items-center gap-2">Next Step <ArrowRight size={16} /></button>
                                            </div>
                                        </div>
                                    )}

                                    {/* Step 3: Preview */}
                                    {wizardStep === 2 && (
                                        <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm animate-in slide-in-from-right-8 fade-in duration-300">
                                            <div className="flex justify-between items-center mb-6">
                                                <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">Verify & Execute</h3>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xs font-bold uppercase text-slate-400">Records:</span>
                                                    <span className="text-sm font-bold bg-slate-100 px-2 py-1 rounded">{parsedData.length}</span>
                                                </div>
                                            </div>

                                            <div className="overflow-x-auto border border-slate-200 rounded-xl mb-6 custom-scrollbar max-h-[500px]">
                                                <table className="w-full text-sm text-left">
                                                    <thead className="bg-slate-50 text-slate-500 text-[10px] uppercase font-bold tracking-wider sticky top-0 z-10">
                                                        <tr>
                                                            <th className="px-4 py-2">Status</th>
                                                            <th className="px-4 py-2">Matched Order</th>
                                                            {(uploadMode === 'settlement' || uploadMode === 'both') && <th className="px-4 py-2 text-right">Settle Amt</th>}
                                                            {(uploadMode === 'charges' || uploadMode === 'both') && <th className="px-4 py-2 text-right">Charge</th>}
                                                            <th className="px-4 py-2">Date</th>
                                                            <th className="px-4 py-2">Input Ref</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-100">
                                                        {parsedData.map((row, idx) => (
                                                            <tr key={idx} className={row.status === 'error' ? 'bg-red-50' : row.status === 'warning' ? 'bg-amber-50' : 'bg-white'}>
                                                                <td className="px-4 py-2">
                                                                    {row.status === 'ready' && <span className="text-emerald-600 font-bold flex items-center gap-1"><Check size={14}/> OK</span>}
                                                                    {row.status === 'error' && <span className="text-red-600 font-bold flex items-center gap-1"><X size={14}/> {row.msg}</span>}
                                                                    {row.status === 'warning' && <span className="text-amber-600 font-bold flex items-center gap-1"><AlertTriangle size={14}/> {row.msg}</span>}
                                                                </td>
                                                                <td className="px-4 py-2">
                                                                    {row.foundOrder ? (
                                                                        <>
                                                                            <div className="font-bold text-slate-800 text-xs">{row.foundOrder.orderId}</div>
                                                                            <div className="text-[10px] text-indigo-600 font-mono">{row.foundOrder.awb}</div>
                                                                        </>
                                                                    ) : (
                                                                        <span className="text-slate-400 text-xs italic">No Match</span>
                                                                    )}
                                                                </td>
                                                                {(uploadMode === 'settlement' || uploadMode === 'both') && <td className="px-4 py-2 text-right font-bold">₹{row.settledAmount}</td>}
                                                                {(uploadMode === 'charges' || uploadMode === 'both') && <td className="px-4 py-2 text-right font-bold text-red-600">-₹{row.chargeAmount}</td>}
                                                                <td className="px-4 py-2 text-xs">{row.settledDate}</td>
                                                                <td className="px-4 py-2 text-xs text-slate-500 max-w-[150px] truncate" title={row.inputAwb || row.inputOrderId}>
                                                                    {row.inputAwb || row.inputOrderId}
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div className="flex justify-end gap-3">
                                                <button onClick={() => setWizardStep(1)} className="px-4 py-2 text-slate-500 hover:text-slate-800 font-bold text-sm">Back to Mapping</button>
                                                <button onClick={handleExecuteBulk} className="px-6 py-2 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition-colors">Confirm Upload</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-slate-50 text-slate-500 font-bold text-[10px] uppercase tracking-wider sticky top-0 z-10 shadow-sm border-b border-slate-200">
                                        <tr>
                                            <th className="px-6 py-3">Order Date</th><th className="px-6 py-3">Order Details</th><th className="px-6 py-3">Customer</th><th className="px-6 py-3 text-right">Bill Amount</th><th className="px-6 py-3 text-right">Settled Amount</th><th className="px-6 py-3"><div className="flex flex-col gap-1"><span>Settled Date</span>{activeTab === 'settled' && (<input type="date" className="text-[10px] font-normal border border-slate-300 rounded px-1 py-0.5 bg-white" value={settledDateFilter} onChange={(e) => setSettledDateFilter(e.target.value)} onClick={(e) => e.stopPropagation()}/>)}</div></th><th className="px-6 py-3">Status</th>{activeTab === 'pending' && <th className="px-6 py-3 text-right">Action</th>}
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 bg-white">
                                        {displayOrders.map(order => { 
                                            const { totalOrderAmount, totalSettled, remaining, status } = getSettlementStats(order); 
                                            return (
                                                <tr key={order.orderId} className="hover:bg-indigo-50/20 transition-colors">
                                                    <td className="px-6 py-4 whitespace-nowrap text-slate-500 text-xs">{formatDate(order.date)}</td>
                                                    <td className="px-6 py-4"><div className="font-bold text-slate-800">{order.billNo}</div><div className="text-xs font-mono text-indigo-600">{order.orderId}</div>{order.awb && <div className="text-[10px] font-bold text-slate-600 font-mono mt-1 flex items-center gap-1 bg-slate-100 px-1.5 py-0.5 rounded w-fit border border-slate-200"><span className="opacity-50">AWB:</span>{order.awb}</div>}{order.settleType && <div className="text-[10px] text-slate-400 mt-1 truncate max-w-[150px]" title={order.settleType}>{order.settleType}</div>}</td>
                                                    <td className="px-6 py-4"><div className="font-medium text-slate-800">{order.customerName}</div><div className="text-xs text-slate-500">{order.contact}</div></td>
                                                    <td className="px-6 py-4 text-right font-medium text-slate-700">₹{totalOrderAmount.toFixed(2)}</td>
                                                    <td className="px-6 py-4 text-right">{totalSettled > 0 ? <div className="flex flex-col items-end"><span className="font-bold text-emerald-600">₹{totalSettled.toFixed(2)}</span></div> : <span className="text-slate-300">-</span>}{remaining > 0 && totalSettled > 0 && <div className="text-[10px] text-red-500 font-bold bg-red-50 px-1 rounded mt-1">Short: {remaining.toFixed(2)}</div>}</td>
                                                    <td className="px-6 py-4 text-xs text-slate-500">{order.settledDate ? order.settledDate.split('|').map((d, i) => <div key={i}>{formatDate(d.trim())}</div>) : '-'}</td>
                                                    <td className="px-6 py-4">{status === 'Settled' ? <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-emerald-100 text-emerald-800 uppercase tracking-wide">Settled</span> : status === 'Partial' ? <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-amber-100 text-amber-800 uppercase tracking-wide">Partial</span> : <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-slate-100 text-slate-600 uppercase tracking-wide">Unsettled</span>}</td>
                                                    {activeTab === 'pending' && (<td className="px-6 py-4 text-right"><button onClick={() => handleOpenSettleModal(order)} className="text-indigo-600 hover:text-indigo-800 text-xs font-bold border border-indigo-200 rounded px-3 py-1.5 hover:bg-indigo-50 transition-colors">Mark Settle</button></td>)}
                                                </tr>
                                            ); 
                                        })}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    </div>

                    {showSettleModal && settleModalData && (<div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200"><div className="bg-slate-900 text-white p-4 flex justify-between items-center"><h3 className="font-bold flex items-center gap-2"><CreditCard size={18} /> Settle Order</h3><button onClick={() => setShowSettleModal(false)}><X size={20} className="text-slate-400 hover:text-white transition-colors" /></button></div><div className="p-6 space-y-4"><div className="flex justify-between items-end border-b border-slate-100 pb-3"><div><div className="text-xs text-slate-500 font-bold uppercase tracking-wider">Order ID</div><div className="font-bold text-lg text-indigo-700 font-mono">{settleModalData.orderId}</div></div><div className="text-right"><div className="text-xs text-slate-500 font-bold uppercase tracking-wider">Total Bill</div><div className="font-bold text-lg text-slate-800">₹{settleModalData.totalAmount || 0}</div></div></div><div className="bg-orange-50 p-3 rounded-lg border border-orange-100 flex justify-between"><span className="text-xs font-bold text-orange-700 uppercase tracking-wider">Pending</span><span className="font-bold text-orange-700">₹{settleForm.amount}</span></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">New Amount</label><input type="number" className="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm font-bold outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/20" value={settleForm.amount} onChange={(e) => setSettleForm({...settleForm, amount: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Date</label><input type="date" className="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/20" value={settleForm.date} onChange={(e) => setSettleForm({...settleForm, date: e.target.value})} /></div></div><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">UTR / Ref</label><input type="text" className="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/20" value={settleForm.utr} onChange={(e) => setSettleForm({...settleForm, utr: e.target.value})} /></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Settle Type</label><select className="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/20" value={settleForm.type} onChange={(e) => setSettleForm({...settleForm, type: e.target.value})}><option value="">Select...</option>{SETTLEMENT_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select></div><div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wider">Charge</label><input type="number" className="w-full border border-slate-200 bg-slate-50 rounded-lg px-3 py-2 text-sm outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/20" value={settleForm.charge} placeholder="0.00" onChange={(e) => setSettleForm({...settleForm, charge: e.target.value})} /></div></div><button onClick={handleSettleSubmit} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-200 transition-all">Confirm Settlement</button></div></div></div>)}</div>
            );
        };
        
        
        
        
        
        
        
        
        const TodaySalesModal = ({ isOpen, onClose, orders }: { isOpen: boolean, onClose: () => void, orders: any[] }) => {
    if (!isOpen) return null;
    
    
    
    
const getLocalISODate = (date) => {
    if (!date) return null; // ⬅️ prevent crash
    
    const d = new Date(date);
    if (isNaN(d.getTime())) return null; // ⬅️ handle invalid dates
    
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().split("T")[0];
};


    

    const todayDate = new Date();
    const formattedDate = todayDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
    const dayName = todayDate.toLocaleDateString('en-GB', { weekday: 'long' });
    const dateStr = getLocalISODate(todayDate);

    // Calculate Stats
    const stats = useMemo(() => {
        const todayOrders = orders.filter(o => {
    const d = getLocalISODate(o.date);
    return d && d === dateStr;
});

        let bagsCount = 0;
        let bagsAmount = 0;
        let luggageCount = 0;
        let luggageAmount = 0;

        todayOrders.forEach(o => {
            const amt = parseFloat(String(o.totalAmount || 0).replace(/,/g, ''));
            const name = (o.productName || "").toLowerCase();
            const isLuggage = ["luggage", "strolly", "trolley", "suitcase", "briefcase"].some(k => name.includes(k));
            
            if (isLuggage) {
                luggageCount += 1;
                luggageAmount += amt;
            } else {
                bagsCount += 1;
                bagsAmount += amt;
            }
        });

        return {
            bagsCount, bagsAmount, luggageCount, luggageAmount,
            total: bagsAmount + luggageAmount,
            count: todayOrders.length
        };
    }, [orders, dateStr]);

    return (
        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-50 flex items-center justify-center p-4 overflow-y-auto">
            <div className="bg-white w-full max-w-3xl rounded-[2.5rem] shadow-2xl overflow-hidden animate-in zoom-in duration-300 relative border border-white/20">
                
                {/* Close Button */}
                <button onClick={onClose} className="absolute top-4 right-4 z-10 bg-black/5 hover:bg-black/10 p-2 rounded-full transition-colors">
                    <X size={20} className="text-slate-600" />
                </button>

                <div className="flex flex-col h-full">
                    {/* Header Section */}
                    <div className="px-8 pt-8 pb-4 text-center">
                        <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-green-200 text-slate-900 text-[16px] font-bold uppercase tracking-widest mb-4">
                            <Calendar size={12} /> Daily Sales Report
                        </div>
                        <h2 className="text-3xl font-bold text-slate-800 tracking-tight">{formattedDate}</h2>
                    </div>

                    {/* Day Banner */}
                    <div className="bg-amber-400 py-3 relative overflow-hidden flex justify-center items-center shadow-inner">
                        <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                        <span className="text-amber-950 font-black text-4xl tracking-widest uppercase relative z-10 drop-shadow-sm">{dayName}</span>
                    </div>

                    {/* Stats Grid */}
                    <div className="p-8 grid grid-cols-2 gap-6 bg-gradient-to-b from-white to-slate-50">
                        {/* Bags Card */}
                        <div className="bg-white p-5 rounded-3xl border border-slate-100 shadow-xl shadow-slate-200/50 flex flex-col items-center text-center group hover:scale-[1.02] transition-transform duration-300">
                            <div className="w-14 h-14 bg-violet-100 rounded-2xl flex items-center justify-center text-violet-600 mb-4 group-hover:rotate-12 transition-transform duration-300 shadow-inner">
                                <ShoppingBag size={28} />
                            </div>
                            <div className="text-2xl font-bold text-slate-400 uppercase tracking-wider mb-1">Bags</div>
                            <div className="text-2xl font-bold text-slate-800 mb-2">{stats.bagsCount}</div>
                            <div className="mt-auto pt-3 border-t border-slate-100 w-full">
                                <span className="text-violet-600 font-bold text-5xl">₹{stats.bagsAmount.toLocaleString()}</span>
                            </div>
                        </div>

                        {/* Luggage Card */}
                        <div className="bg-white p-5 rounded-3xl border border-slate-100 shadow-xl shadow-slate-200/50 flex flex-col items-center text-center group hover:scale-[1.02] transition-transform duration-300">
                            <div className="w-14 h-14 bg-indigo-100 rounded-2xl flex items-center justify-center text-indigo-600 mb-4 group-hover:-rotate-12 transition-transform duration-300 shadow-inner">
                                <Briefcase size={28} />
                            </div>
                            <div className="text-2xl font-bold text-slate-400 uppercase tracking-wider mb-1">Luggages</div>
                            <div className="text-2xl font-bold text-slate-800 mb-2">{stats.luggageCount}</div>
                            <div className="mt-auto pt-3 border-t border-slate-100 w-full">
                                <span className="text-indigo-600 font-bold text-5xl">₹{stats.luggageAmount.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>

                    {/* Total Section */}
                    <div className="px-6 pb-6">
                        <div className="bg-slate-900 rounded-[2rem] p-6 text-white relative overflow-hidden shadow-2xl">
                            {/* Decorative glow */}
                            <div className="absolute top-0 right-0 w-32 h-32 bg-indigo-500 rounded-full blur-[60px] opacity-30 -mr-10 -mt-10"></div>
                            
                            <div className="relative z-10 text-center">
                                <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Total Revenue Today</div>
                                <div className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-300 mb-3">
                                    ₹ {stats.total.toLocaleString()}
                                </div>
                                <div className="bg-white/10 rounded-xl py-2 px-4 text-[10px] md:text-xl font-medium text-indigo-200 border border-white/5 inline-block max-w-full truncate">
                                    {numberToWords(stats.total)}
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    );
};
        
const ReportsPage = () => {
    const { orders, updateLocalOrder } = useOrders();
    const [dateRange, setDateRange] = useState({ start: '', end: '' });
    const [filterState, setFilterState] = useState("");
    const [filterPayment, setFilterPayment] = useState("");
    const [filterCategory, setFilterCategory] = useState("");
    const [searchTerm, setSearchTerm] = useState("");
    const [showReport, setShowReport] = useState(true);
    const [isDownloadModalOpen, setIsDownloadModalOpen] = useState(false);
    const [downloadMode, setDownloadMode] = useState('all');
    const [activeReportTab, setActiveReportTab] = useState('sales');
    const [settleDateRange, setSettleDateRange] = useState({ start: '', end: '' });
    const [settleTypeFilter, setSettleTypeFilter] = useState("");
    const [settleSearchTerm, setSettleSearchTerm] = useState("");
    const [isTodayModalOpen, setIsTodayModalOpen] = useState(false);
    const [isCompressed, setIsCompressed] = useState(false);

    useEffect(() => { 
        const now = new Date(); 
        const start = getLocalDateString(new Date(now.getFullYear(), now.getMonth(), 1)); 
        const end = getLocalDateString(new Date()); 
        setDateRange({ start, end }); 
        setSettleDateRange({ start, end });
    }, []);

    const uniqueStates = useMemo(() => { const states = new Set(orders.map(o => o.state).filter(Boolean)); return Array.from(states).sort(); }, [orders]);
    
    const processedData = useMemo(() => {
        const start = dateRange.start ? new Date(dateRange.start + "T00:00:00") : new Date(0); 
        const end = dateRange.end ? new Date(dateRange.end + "T23:59:59.999") : new Date(); 
        
        const getCategory = (item) => { if (item.bagsLuggage) return item.bagsLuggage; const name = (item.productName || "").toLowerCase(); const luggageKeywords = ["luggage", "luggages", "strolly", "trolly", "trolley", "suitcase", "briefcase"]; return luggageKeywords.some(k => name.includes(k)) ? "Luggages" : "Bags"; };
        const parentMap = new Map(); orders.forEach(o => { if (o.orderId && !o.orderId.includes('Q')) { parentMap.set(o.orderId, o); } });
        const enrichedOrders = orders.map(o => { 
            if (o.orderId && o.orderId.includes('Q')) { 
                const parentId = o.orderId.split('Q')[0]; 
                const parent = parentMap.get(parentId); 
                if (parent) { 
                    const parentIsCancel = parent.trackingStatus === 'Cancel' || parent.trackingStatus === 'Return';
                    return { 
                        ...o, 
                        date: o.date || parent.date, 
                        state: o.state || parent.state, 
                        paymentType: o.paymentType || parent.paymentType, 
                        bagsLuggage: o.bagsLuggage || parent.bagsLuggage, 
                        customerName: o.customerName || parent.customerName, 
                        billNo: "",
                        trackingStatus: parentIsCancel ? parent.trackingStatus : o.trackingStatus 
                    }; 
                } 
            } 
            return o; 
        });
        const currentOrders = enrichedOrders.filter(o => { const d = parseDate(o.date); if (!d || d < start || d > end) return false; if (searchTerm) { const term = searchTerm.toLowerCase(); const prodMatch = (o.productName || "").toLowerCase().includes(term); const idMatch = (o.orderId || "").toLowerCase().includes(term); if (!prodMatch && !idMatch) return false; } if (filterState) { const selectedStates = filterState.split('|').map(s => s.trim().toLowerCase()); if (selectedStates.length > 0 && !selectedStates.includes((o.state || "").toLowerCase())) { return false; } } if (filterPayment && o.paymentType !== filterPayment) return false; const rowCat = getCategory(o).toLowerCase(); if (filterCategory) { const fc = filterCategory.toLowerCase(); if (fc === "luggages") { if (!rowCat.includes("luggage")) return false; } else if (fc === "bags") { if (rowCat.includes("luggage")) return false; } } return true; });
        const returns = enrichedOrders.filter(o => { const isSettled = o.settlementGenerated === 'Generated' || o.settlementGenerated === 'Yes'; const isCancel = o.trackingStatus === 'Cancel' || o.trackingStatus === 'Return'; const hasValue = parseFloat(String(o.totalAmount || "0").replace(/,/g, '')) > 0 || parseFloat(String(o.qty || "0")) > 0; return isSettled && isCancel && hasValue; });
        const currentIds = new Set(currentOrders.map(o => o.orderId)); const uniqueReturns = returns.filter(o => !currentIds.has(o.orderId));
        const reportRows = [ ...currentOrders.map(o => ({ ...o, type: 'current' })), ...uniqueReturns.map(o => ({ ...o, type: 'return' })) ];
        return reportRows.map(o => { const isCancel = (o.trackingStatus === 'Cancel' || o.trackingStatus === 'Return'); const isGenerated = (o.settlementGenerated === 'Generated' || o.settlementGenerated === 'Yes'); let qty = parseFloat(String(o.qty || 0)); let rawTotal = parseFloat(String(o.price || o.totalAmount || 0)); let totalAmount = rawTotal; let mrp = parseFloat(String(o.mrp || 0)); if (isCancel) { if (isGenerated) { qty = -Math.abs(qty); totalAmount = -Math.abs(totalAmount); mrp = -Math.abs(mrp); } else { qty = 0; totalAmount = 0; mrp = 0; } } let rawRate = parseFloat(String(o.gstRate)) || 0; let ratePercent = rawRate; if (ratePercent > 0 && ratePercent < 1) ratePercent *= 100; if (ratePercent === 0) ratePercent = 18; const sheetTaxable = parseCurrency(o.taxableAmount); const sheetGstAmt = parseCurrency(o.gstAmount); const sheetHalfTax = parseCurrency(o.cgstSgst); let taxable = sheetTaxable; let taxAmt = sheetGstAmt; if (totalAmount === 0) { taxable = 0; taxAmt = 0; } else { if (!taxable || Math.abs(taxable) > Math.abs(totalAmount)) { taxable = totalAmount / (1 + (ratePercent / 100)); } if (!taxAmt || Math.abs(taxAmt) > Math.abs(totalAmount)) { taxAmt = totalAmount - taxable; } } const stateLower = (o.state || "").toLowerCase(); const isTamilNadu = stateLower.includes("tamil nadu") || stateLower.includes("chennai") || stateLower === "tn"; let cgst = 0, sgst = 0, igst = 0; if (isTamilNadu) { if (sheetHalfTax !== 0 && totalAmount !== 0) { const sign = totalAmount < 0 ? -1 : 1; cgst = Math.abs(sheetHalfTax) * sign; sgst = Math.abs(sheetHalfTax) * sign; } else { cgst = taxAmt / 2; sgst = taxAmt / 2; } } else { igst = taxAmt; } return { ...o, displayQty: qty, displayTotal: totalAmount, displayTaxable: taxable, cgst, sgst, igst, gstRate: ratePercent }; });
    }, [orders, dateRange, searchTerm, filterState, filterPayment, filterCategory]);

    const calculateStateSummary = (rows) => { const summary = {}; rows.forEach(row => { const state = (row.state || "Unknown").toUpperCase(); if (!summary[state]) { summary[state] = { state, taxable18: 0, cgst18: 0, sgst18: 0, igst18: 0, taxable5: 0, cgst5: 0, sgst5: 0, igst5: 0, total: 0 }; } if (Math.round(row.gstRate) === 18) { summary[state].taxable18 += row.displayTaxable; summary[state].cgst18 += row.cgst; summary[state].sgst18 += row.sgst; summary[state].igst18 += row.igst; } else { summary[state].taxable5 += row.displayTaxable; summary[state].cgst5 += row.cgst; summary[state].sgst5 += row.sgst; summary[state].igst5 += row.igst; } summary[state].total += row.displayTotal; }); return Object.values(summary); };
    
    const settlementData = useMemo(() => { 
        const startStr = settleDateRange.start; 
        const endStr = settleDateRange.end; 
        const explodedRows = [];

        orders.forEach(o => {
            if (settleSearchTerm) { 
                const term = settleSearchTerm.toLowerCase(); 
                const matchesId = String(o.orderId || "").toLowerCase().includes(term); 
                const matchesBill = String(o.billNo || "").toLowerCase().includes(term); 
                const matchesUtr = String(o.settledUtr || "").toLowerCase().includes(term); 
                if (!matchesId && !matchesBill && !matchesUtr) return; 
            }

            const types = (o.settleType || "").split('|').map(s => s.trim());
            const amts = String(o.settledAmount || "0").split('|').map(s => s.trim());
            const dates = String(o.settledDate || "").split('|').map(s => s.trim());
            const utrs = String(o.settledUtr || "").split('|').map(s => s.trim());
            const charges = String(o.settlementCharge || "0").split('|').map(s => s.trim());
            
            const count = Math.max(types.length, amts.length);

            for(let i=0; i<count; i++) {
                const sType = types[i] || types[0] || ""; 
                const sAmtStr = amts[i] || "0";
                const sDateStr = dates[i] || dates[0] || ""; 
                const sUtr = utrs[i] || "";
                const sChargeStr = charges[i] || "0";

                const sAmt = parseFloat(sAmtStr.replace(/,/g, '')) || 0;
                const sCharge = parseFloat(sChargeStr.replace(/,/g, '')) || 0;
                const oAmt = parseFloat(String(o.totalAmount || "0").replace(/,/g, '')) || 0;

                const rowDateISO = getLocalDateString(sDateStr);
                if (!rowDateISO) continue; 
                if (startStr && rowDateISO < startStr) continue;
                if (endStr && rowDateISO > endStr) continue;

                if (settleTypeFilter && !sType.includes(settleTypeFilter)) continue;

                if (sAmt === 0 && o.settlementGenerated !== "Yes" && sCharge === 0) continue;

                let calculatedCharge = sCharge;
                if (types.length === 1 && calculatedCharge === 0 && oAmt > 0) {
                    calculatedCharge = oAmt - sAmt;
                }

                explodedRows.push({
                    ...o,
                    displaySettleType: sType,
                    displaySettledDate: sDateStr,
                    displayUtr: sUtr,
                    parsedSettledAmount: sAmt,
                    parsedOrderAmount: oAmt, 
                    calculatedCharge: calculatedCharge,
                    isSplit: types.length > 1
                });
            }
        });
        
        return explodedRows.sort((a,b) => new Date(b.displaySettledDate) - new Date(a.displaySettledDate));
    }, [orders, settleDateRange, settleTypeFilter, settleSearchTerm]);

    const settlementStats = useMemo(() => { 
        const processedOrderIds = new Set();
        return settlementData.reduce((acc, curr) => { 
            acc.totalSettled += curr.parsedSettledAmount; 
            if (!processedOrderIds.has(curr.orderId)) {
                acc.totalOrderValue += curr.parsedOrderAmount; 
                processedOrderIds.add(curr.orderId);
            }
            acc.totalCharges += curr.calculatedCharge; 
            acc.count += 1; 
            return acc; 
        }, { totalSettled: 0, totalOrderValue: 0, totalCharges: 0, count: 0 }); 
    }, [settlementData]);

    // --- COMPRESSED VIEW LOGIC (UPDATED TO GROUP BY DATE + TYPE + UTR) ---
    const compressedSettlementData = useMemo(() => {
        const groups = new Map();
        settlementData.forEach(row => {
            // Updated grouping key to include UTR
            const utr = (row.displayUtr || "").trim();
            const key = `${row.displaySettledDate}|${row.displaySettleType}|${utr}`;
            if (!groups.has(key)) {
                groups.set(key, {
                    date: row.displaySettledDate,
                    type: row.displaySettleType,
                    count: 0,
                    orderAmt: 0,
                    settledAmt: 0,
                    charge: 0,
                    utrs: new Set(),
                    bills: new Set()
                });
            }
            const g = groups.get(key);
            g.count += 1;
            g.orderAmt += row.parsedOrderAmount;
            g.settledAmt += row.parsedSettledAmount;
            g.charge += row.calculatedCharge;
            if (row.displayUtr) g.utrs.add(row.displayUtr);
            if (row.billNo) g.bills.add(row.billNo);
        });
        return Array.from(groups.values()).sort((a,b) => new Date(b.date) - new Date(a.date));
    }, [settlementData]);
    
    const handleFinalize = () => { if (!confirm("This will mark orders as Generated or Cancel based on their status. Continue?")) return; processedData.forEach(row => { const isCancel = row.trackingStatus === 'Cancel' || row.trackingStatus === 'Return'; if (isCancel) { updateLocalOrder(row.orderId, { settlementGenerated: "Cancel", "Settlement Generated": "Cancel" }); } else { updateLocalOrder(row.orderId, { settlementGenerated: "Generated", "Settlement Generated": "Generated" }); } }); alert("Report Finalized. Database updated."); setIsDownloadModalOpen(false); };
    
    const generateExcel = (filename, sheets) => { const escapeXml = (str) => { return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;'); }; let xml = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>'; xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">'; sheets.forEach(sheet => { xml += `<Worksheet ss:Name="${sheet.name}"><Table>`; xml += '<Row>'; sheet.headers.forEach(h => { xml += `<Cell><Data ss:Type="String">${escapeXml(h)}</Data></Cell>`; }); xml += '</Row>'; sheet.rows.forEach(row => { xml += '<Row>'; row.forEach(cell => { const type = typeof cell === 'number' ? 'Number' : 'String'; xml += `<Cell><Data ss:Type="${type}">${escapeXml(cell)}</Data></Cell>`; }); xml += '</Row>'; }); xml += '</Table></Worksheet>'; }); xml += '</Workbook>'; const blob = new Blob([xml], {type: 'application/vnd.ms-excel'}); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.href = url; link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
    
    const handleDownloadReport = () => { let rowsToExport = []; let filenameSuffix = ""; if (downloadMode === 'new') { filenameSuffix = "_NewData"; rowsToExport = processedData.filter(row => { const isGenerated = row.settlementGenerated === 'Generated' || row.settlementGenerated === 'Yes'; const isCancel = row.trackingStatus === 'Cancel' || row.trackingStatus === 'Return'; const isMarkedCancel = row.settlementGenerated === 'Cancel'; if (isCancel && isGenerated) return true; if (!isGenerated && !isMarkedCancel) return true; return false; }); } else { filenameSuffix = "_AllData"; rowsToExport = processedData; } const salesHeader = ["Date", "OR ID", "BILL NO", "STATE", "HSN", "PRODUCT", "QUANTITY", "TOTAL QUANTITY", "Taxable Value 18%", "CGST 9%", "SGST 9%", "IGST 18%", "Taxable Value 5%", "CGST 2.5%", "SGST 2.5%", "IGST 5%", "TOTAL", "CANCEL", "SETTLEMENT TYPE"]; const salesRows = rowsToExport.map(row => { const is18 = Math.round(row.gstRate) === 18; return [formatDate(row.date), row.orderId, row.billNo, row.state, row.hsn || "4202", row.productName, row.displayQty, row.totalQty, is18 ? Number(row.displayTaxable.toFixed(2)) : 0, is18 ? Number(row.cgst.toFixed(2)) : 0, is18 ? Number(row.sgst.toFixed(2)) : 0, is18 ? Number(row.igst.toFixed(2)) : 0, !is18 ? Number(row.displayTaxable.toFixed(2)) : 0, !is18 ? Number(row.cgst.toFixed(2)) : 0, !is18 ? Number(row.sgst.toFixed(2)) : 0, !is18 ? Number(row.igst.toFixed(2)) : 0, Number(row.displayTotal.toFixed(2)), (row.trackingStatus === 'Cancel' || row.trackingStatus === 'Return') ? 'Yes' : 'No', row.settleType]; }); const summaryRowsData = calculateStateSummary(rowsToExport); const summaryHeader = ["STATE", "Taxable Value 18%", "CGST 18%", "SGST 18%", "IGST 18%", "Taxable Value 5%", "CGST 5%", "SGST 5%", "IGST 5%", "TOTAL"]; const summaryRows = summaryRowsData.map(row => [row.state, Number(row.taxable18.toFixed(2)), Number(row.cgst18.toFixed(2)), Number(row.sgst18.toFixed(2)), Number(row.igst18.toFixed(2)), Number(row.taxable5.toFixed(2)), Number(row.cgst5.toFixed(2)), Number(row.sgst5.toFixed(2)), Number(row.igst5.toFixed(2)), Number(row.total.toFixed(2))]); generateExcel(`Sales_Report${filenameSuffix}_${dateRange.start}.xls`, [{ name: "Sales Data", headers: salesHeader, rows: salesRows }, { name: "State Summary", headers: summaryHeader, rows: summaryRows }]); setIsDownloadModalOpen(false); };
    
    const handleExportSideBySide = () => {
        const detailHeaders = ["Settled Date", "Order Date", "Order ID", "Bill No", "Customer", "Settle Type", "Order Amt", "Settled Amt", "Charge", "UTR"];
        const summaryHeaders = ["", "Summary Date", "Summary Type", "Count", "Tot Order Amt", "Tot Settled", "Tot Charge", "Common UTR", "Bill No"];

        const allHeaders = [...detailHeaders, ...summaryHeaders];

        const rows = [];
        const maxCount = Math.max(settlementData.length, compressedSettlementData.length);

        for (let i = 0; i < maxCount; i++) {
            const d = settlementData[i];
            const s = compressedSettlementData[i];
            const row = [];

            // Detail Part (A-J)
            if (d) {
                row.push(
                    formatDate(d.displaySettledDate),
                    formatDate(d.date),
                    d.orderId,
                    d.billNo,
                    d.customerName ? d.customerName.replace(/,/g, ' ') : "",
                    d.displaySettleType,
                    Number(d.parsedOrderAmount.toFixed(2)),
                    Number(d.parsedSettledAmount.toFixed(2)),
                    Number(d.calculatedCharge.toFixed(2)),
                    d.displayUtr
                );
            } else {
                row.push("","","","","","","","","","");
            }

            // Summary Part (K-S)
            if (s) {
                const utrStr =
                    s.utrs.size === 1
                        ? Array.from(s.utrs)[0]
                        : s.utrs.size > 1
                        ? "Multiple"
                        : "-";

                const billStr =
                    s.bills.size > 0
                        ? Array.from(s.bills).join(", ")
                        : "-";

                row.push(
                    "", // gap
                    formatDate(s.date),
                    s.type,
                    s.count,
                    Number(s.orderAmt.toFixed(2)),
                    Number(s.settledAmt.toFixed(2)),
                    Number(s.charge.toFixed(2)),
                    utrStr,
                    billStr
                );

            } else {
                row.push("","","","","","","","","");
            }
            rows.push(row);
        }

        generateExcel(`Settlement_Report_Export_${settleDateRange.start}.xls`, [
            { name: "Settlement Data", headers: allHeaders, rows: rows }
        ]);
    };

    return (
        <div className="w-full max-w-[1600px] mx-auto p-6 space-y-6 h-[calc(100vh-4rem)] flex flex-col">
            <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-6" onClick={() => setShowReport(!showReport)}>
                <div><h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">Report <span className="text-indigo-600">Center</span></h1><p className="text-slate-500 text-sm mt-1">Generate Sales and Settlement Reports.</p></div>
                <div className="flex bg-slate-100 p-1 rounded-xl shadow-inner border border-slate-200" onClick={e => e.stopPropagation()}>
                    <button onClick={() => setActiveReportTab('sales')} className={`px-5 py-2.5 rounded-lg text-sm font-bold transition-all ${activeReportTab === 'sales' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'}`}>Sales Report</button>
                    <button onClick={() => setActiveReportTab('settlement')} className={`px-5 py-2.5 rounded-lg text-sm font-bold transition-all ${activeReportTab === 'settlement' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50'}`}>Settlement Report</button>
                </div> 
                
                <TodaySalesModal
                    isOpen={isTodayModalOpen}
                    onClose={() => setIsTodayModalOpen(false)}
                    orders={orders}  />
                
                <div className="flex bg-slate-100 p-1 rounded-lg">
                    <button
                        onClick={(e) => { e.stopPropagation(); setIsTodayModalOpen(true); }}
                        className="flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-200 transition-all"
                    >
                        <FileSpreadsheet size={18} /> Today Report
                    </button>
                </div>
                
                <div className="flex gap-3" onClick={e => e.stopPropagation()}>
                    {activeReportTab === 'sales' ? ( <button onClick={() => setIsDownloadModalOpen(true)} className="flex items-center gap-2 px-5 py-2.5 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all"><Download size={18} /> Download Report</button> ) : ( <button onClick={handleExportSideBySide} className="flex items-center gap-2 px-5 py-2.5 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all"><FileSpreadsheet size={18} /> Export Settlement Data</button> )}
                </div>
            </div>

            {isDownloadModalOpen && (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="bg-slate-900 text-white p-4 flex justify-between items-center"><h3 className="font-bold flex items-center gap-2">Report Options</h3><button onClick={() => setIsDownloadModalOpen(false)}><X size={20} className="text-slate-400 hover:text-white transition-colors" /></button></div>
                        <div className="p-6 flex flex-col gap-6">
                            <div className="flex bg-slate-100 p-1 rounded-lg"><button onClick={() => setDownloadMode('all')} className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${downloadMode === 'all' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500'}`}>All Data</button><button onClick={() => setDownloadMode('new')} className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all ${downloadMode === 'new' ? 'bg-white text-orange-600 shadow-sm' : 'text-slate-500'}`}>New Data Only</button></div>
                            <p className="text-xs text-slate-500 text-center">{downloadMode === 'all' ? "Downloads complete filtered dataset + state summary." : "Downloads only new (not generated) and cancelled items + state summary."}</p>
                            <div className="flex flex-col gap-3"><button onClick={handleFinalize} className="w-full flex justify-center items-center gap-2 px-4 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 transition-all"><CheckCircle2 size={18} /> Mark as Generated</button><button onClick={handleDownloadReport} className="w-full flex justify-center items-center gap-2 px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all"><FileSpreadsheet size={18} /> Download Excel</button></div>
                        </div>
                    </div>
                </div>
            )}

            {showReport && (
                <>
                    {activeReportTab === 'sales' ? (
                        <>
                            <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm grid grid-cols-1 md:grid-cols-5 gap-4">
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 px-1 block">Date Range</label><div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200"><input type="date" className="bg-transparent text-xs font-bold w-full outline-none text-slate-700" value={dateRange.start} onChange={e => setDateRange({ ...dateRange, start: e.target.value })} /><span className="text-slate-300">-</span><input type="date" className="bg-transparent text-xs font-bold w-full outline-none text-slate-700" value={dateRange.end} onChange={e => setDateRange({ ...dateRange, end: e.target.value })} /></div></div>
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 px-1 block">Payment</label><select className="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500/20 h-[38px]" value={filterPayment} onChange={e => setFilterPayment(e.target.value)}><option value="">All</option><option value="Online Payment">Online Payment</option><option value="Cash On Delivery">COD</option></select></div>
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 px-1 block">State</label><MultiSelectDropdown options={uniqueStates} value={filterState} onChange={setFilterState} placeholder="Select States" /></div>
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 px-1 block">Category</label><select className="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500/20 h-[38px]" value={filterCategory} onChange={e => setFilterCategory(e.target.value)}><option value="">All</option><option value="Bags">Bags</option><option value="Luggages">Luggages</option></select></div>
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 px-1 block">Product Search</label><div className="relative"><Search className="absolute left-2.5 top-2.5 text-slate-400" size={14} /><input type="text" className="w-full pl-8 p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500/20 h-[38px]" placeholder="Product Name..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div></div>
                            </div>
                            <div className="flex-1 bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden flex flex-col">
                                <div className="p-4 bg-slate-50 border-b border-slate-200 font-bold text-xs uppercase text-slate-500 flex justify-between items-center"><span>Sales Preview ({processedData.length} entries)</span><span className="text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">Net Total: ₹{processedData.reduce((acc, r) => acc + r.displayTotal, 0).toFixed(2)}</span></div>
                                <div className="flex-1 overflow-auto custom-scrollbar">
                                    <table className="w-full text-left text-xs">
                                        <thead className="bg-white sticky top-0 z-10 shadow-sm text-[10px] uppercase font-bold text-slate-500"><tr><th className="p-3 border-b border-slate-100">Date</th><th className="p-3 border-b border-slate-100">Order No</th><th className="p-3 border-b border-slate-100">Product</th><th className="p-3 border-b border-slate-100 text-right">Qty</th><th className="p-3 border-b border-slate-100 text-right">Taxable</th><th className="p-3 border-b border-slate-100 text-right">Tax</th><th className="p-3 border-b border-slate-100 text-right">Total</th><th className="p-3 border-b border-slate-100">Type</th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">{processedData.map((row, i) => (<tr key={i} className={row.type === 'return' ? 'bg-red-50 text-red-700' : 'hover:bg-slate-50'}><td className="p-3 font-medium">{formatDate(row.date)}</td><td className="p-3 font-mono">{row.orderId}</td><td className="p-3 truncate max-w-[200px]" title={row.productName}>{row.productName}</td><td className="p-3 text-right font-bold">{row.displayQty}</td><td className="p-3 text-right">{row.displayTaxable.toFixed(2)}</td><td className="p-3 text-right">{(row.cgst + row.sgst + row.igst).toFixed(2)}</td><td className="p-3 text-right font-bold">{row.displayTotal.toFixed(2)}</td><td className="p-3"><span className={`px-2 py-0.5 rounded-full text-[10px] uppercase font-bold ${row.type === 'return' ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}`}>{row.type === 'return' ? 'Return' : 'Sales'}</span></td></tr>))}</tbody>
                                    </table>
                                </div>
                            </div>
                            <div className="bg-slate-900 text-white p-5 rounded-2xl shadow-lg grid grid-cols-4 gap-4 text-center bg-gradient-to-r from-slate-900 to-slate-800"><div><div className="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Total Taxable</div><div className="text-2xl font-bold">₹{processedData.reduce((acc, r) => acc + r.displayTaxable, 0).toFixed(2)}</div></div><div><div className="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Total CGST/SGST</div><div className="text-2xl font-bold">₹{processedData.reduce((acc, r) => acc + (r.cgst + r.sgst), 0).toFixed(2)}</div></div><div><div className="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Total IGST</div><div className="text-2xl font-bold">₹{processedData.reduce((acc, r) => acc + r.igst, 0).toFixed(2)}</div></div><div><div className="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Grand Total</div><div className="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-teal-300">₹{processedData.reduce((acc, r) => acc + r.displayTotal, 0).toFixed(2)}</div></div></div>
                        </>
                    ) : (
                        <>
                             <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 px-1 block">Settled Date Range</label><div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200"><input type="date" className="bg-transparent text-xs font-bold w-full outline-none text-slate-700" value={settleDateRange.start} onChange={e => setSettleDateRange({ ...settleDateRange, start: e.target.value })} /><span className="text-slate-300">-</span><input type="date" className="bg-transparent text-xs font-bold w-full outline-none text-slate-700" value={settleDateRange.end} onChange={e => setSettleDateRange({ ...settleDateRange, end: e.target.value })} /></div></div>
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 px-1 block">Settle Type</label><select className="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500/20 h-[38px]" value={settleTypeFilter} onChange={e => setSettleTypeFilter(e.target.value)}><option value="">All Settlement Types</option>{SETTLEMENT_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select></div>
                                <div className="md:col-span-2"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5 px-1 block">Search Settlement</label><div className="relative"><Search className="absolute left-2.5 top-2.5 text-slate-400" size={14} /><input type="text" className="w-full pl-8 p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500/20 h-[38px]" placeholder="Order ID, UTR, Bill No..." value={settleSearchTerm} onChange={e => setSettleSearchTerm(e.target.value)} /></div></div>
                            </div>

                             <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col justify-between"><div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Total Settled Amount</div><div className="text-3xl font-bold text-emerald-600">₹{settlementStats.totalSettled.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div></div>
                                <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col justify-between"><div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Total Order Value (Unique)</div><div className="text-3xl font-bold text-slate-700">₹{settlementStats.totalOrderValue.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div></div>
                                <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col justify-between"><div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Settlement Charges / Diff</div><div className="text-3xl font-bold text-red-500">₹{settlementStats.totalCharges.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div></div>
                            </div>

                            <div className="flex-1 bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden flex flex-col">
                                <div className="p-4 bg-slate-50 border-b border-slate-200 font-bold text-xs uppercase text-slate-500 flex justify-between"><span>Settlement Details ({settlementStats.count} records)</span></div>
                                <div className="flex-1 overflow-auto custom-scrollbar">
                                    <table className="w-full text-left text-xs">
                                        <thead className="bg-white sticky top-0 z-10 shadow-sm text-[10px] uppercase font-bold text-slate-500 tracking-wider">
                                            <tr>
                                                <th className="p-3 border-b border-slate-100">
                                                    <button 
                                                        onClick={() => setIsCompressed(!isCompressed)} 
                                                        className="flex items-center gap-1 hover:text-indigo-600 transition-colors uppercase font-bold"
                                                        title="Toggle View"
                                                    >
                                                        Settled Date {isCompressed ? '▼' : '▶'}
                                                    </button>
                                                </th>
                                                {isCompressed ? (
                                                    <>
                                                        <th className="p-3 border-b border-slate-100">Type</th>
                                                        <th className="p-3 border-b border-slate-100 text-center">Count</th>
                                                        <th className="p-3 border-b border-slate-100 text-right">Total Order Amt</th>
                                                        <th className="p-3 border-b border-slate-100 text-right">Total Settled Amt</th>
                                                        <th className="p-3 border-b border-slate-100 text-right">Total Charge/Diff</th>
                                                        <th className="p-3 border-b border-slate-100">Common UTR</th>
                                                    </>
                                                ) : (
                                                    <>
                                                        <th className="p-3 border-b border-slate-100">Order No</th>
                                                        <th className="p-3 border-b border-slate-100">Bill No</th>
                                                        <th className="p-3 border-b border-slate-100">Customer</th>
                                                        <th className="p-3 border-b border-slate-100">Type</th>
                                                        <th className="p-3 border-b border-slate-100 text-right">Order Amt</th>
                                                        <th className="p-3 border-b border-slate-100 text-right">Settled Amt</th>
                                                        <th className="p-3 border-b border-slate-100 text-right">Charge/Diff</th>
                                                        <th className="p-3 border-b border-slate-100">UTR</th>
                                                    </>
                                                )}
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {isCompressed ? (
                                                compressedSettlementData.map((row, i) => {
                                                    const utrStr = row.utrs.size === 1 ? Array.from(row.utrs)[0] : (row.utrs.size > 1 ? "Multiple" : "-");
                                                    return (
                                                        <tr key={i} className="hover:bg-slate-50">
                                                            <td className="p-3 font-medium text-slate-600">{formatDate(row.date)}</td>
                                                            <td className="p-3 text-[10px] font-bold text-slate-500 uppercase">{row.type}</td>
                                                            <td className="p-3 text-center font-bold">{row.count}</td>
                                                            <td className="p-3 text-right text-slate-600">₹{row.orderAmt.toFixed(2)}</td>
                                                            <td className="p-3 text-right font-bold text-emerald-600">₹{row.settledAmt.toFixed(2)}</td>
                                                            <td className="p-3 text-right text-red-500 font-medium">{row.charge.toFixed(2)}</td>
                                                            <td className="p-3 font-mono text-[10px] text-slate-400 truncate max-w-[150px]" title={utrStr}>{utrStr}</td>
                                                        </tr>
                                                    );
                                                })
                                            ) : (
                                                settlementData.map((row, i) => (
                                                    <tr key={i} className="hover:bg-slate-50">
                                                        <td className="p-3 font-medium text-slate-600">{formatDate(row.displaySettledDate)}</td>
                                                        <td className="p-3 font-mono text-indigo-700 font-bold">{row.orderId}</td>
                                                        <td className="p-3 font-mono text-slate-500">{row.billNo}</td>
                                                        <td className="p-3 truncate max-w-[150px] font-medium" title={row.customerName}>{row.customerName}</td>
                                                        <td className="p-3 text-[10px] font-bold text-slate-500 uppercase">{row.displaySettleType}</td>
                                                        <td className="p-3 text-right text-slate-600">₹{row.parsedOrderAmount.toFixed(2)}</td>
                                                        <td className="p-3 text-right font-bold text-emerald-600">₹{row.parsedSettledAmount.toFixed(2)}</td>
                                                        <td className="p-3 text-right text-red-500 font-medium">{row.calculatedCharge.toFixed(2)}</td>
                                                        <td className="p-3 font-mono text-[10px] text-slate-400 truncate max-w-[120px]" title={row.displayUtr}>{row.displayUtr}</td>
                                                    </tr>
                                                ))
                                            )}
                                            {(isCompressed ? compressedSettlementData.length === 0 : settlementData.length === 0) && ( 
                                                <tr><td colSpan={isCompressed ? 7 : 9} className="p-12 text-center text-slate-400">No settlement records found for selected period.</td></tr> 
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </>
                    )}
                </>
            )}
        </div>
    );
};
         const PendingChangesModal = ({ isOpen, onClose }) => {
            const { pendingOps, removePendingOp, updatePendingOp } = useOrders();
            const [editingId, setEditingId] = useState(null);
            const [editValue, setEditValue] = useState("");

            if (!isOpen) return null;

            const handleEdit = (op) => {
                setEditingId(op.timestamp);
                setEditValue(JSON.stringify(op.payload, null, 2));
            };

            const handleSave = (timestamp) => {
                try {
                    const parsed = JSON.parse(editValue);
                    updatePendingOp(timestamp, parsed);
                    setEditingId(null);
                } catch (e) {
                    alert("Invalid JSON format");
                }
            };

            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh] animate-in fade-in zoom-in duration-200">
                        <div className="bg-slate-900 text-white p-4 flex justify-between items-center bg-gradient-to-r from-slate-900 to-slate-800">
                            <h3 className="font-bold flex items-center gap-2 text-lg"><Upload size={20} className="text-indigo-400"/> Pending Uploads Manager</h3>
                            <button onClick={onClose}><X size={20} className="text-slate-400 hover:text-white transition-colors" /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50 custom-scrollbar">
                            {pendingOps.length === 0 ? (
                                <div className="text-center text-slate-400 py-12 flex flex-col items-center">
                                    <CheckCircle2 size={48} className="mb-3 opacity-20" />
                                    <p>No pending changes waiting to sync.</p>
                                </div>
                            ) : (
                                pendingOps.sort((a,b) => b.timestamp - a.timestamp).map(op => (
                                    <div key={op.timestamp} className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${op.type === 'create' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}`}>{op.type}</span>
                                                    <span className="text-xs font-mono font-bold text-slate-700">{op.id}</span>
                                                </div>
                                                <div className="text-[10px] text-slate-400 mt-1">{new Date(op.timestamp).toLocaleString()}</div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => removePendingOp(op.timestamp)} className="p-1.5 text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Discard Change"><Trash2 size={16} /></button>
                                                {editingId !== op.timestamp ? (
                                                     <button onClick={() => handleEdit(op)} className="p-1.5 text-indigo-500 hover:bg-indigo-50 rounded-lg transition-colors" title="View/Edit Data"><Eye size={16} /></button>
                                                ) : (
                                                     <button onClick={() => setEditingId(null)} className="p-1.5 text-slate-500 hover:bg-slate-50 rounded-lg transition-colors" title="Cancel Edit"><X size={16} /></button>
                                                )}
                                            </div>
                                        </div>
                                        {editingId === op.timestamp ? (
                                            <div className="mt-3 animate-in fade-in slide-in-from-top-2">
                                                <textarea className="w-full h-48 font-mono text-xs bg-slate-900 text-green-400 p-3 rounded-lg outline-none resize-y" value={editValue} onChange={(e) => setEditValue(e.target.value)} />
                                                <div className="flex justify-end gap-2 mt-2">
                                                    <button onClick={() => handleSave(op.timestamp)} className="px-3 py-1.5 bg-indigo-600 text-white text-xs font-bold rounded-lg hover:bg-indigo-700">Save JSON</button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="mt-2 text-xs text-slate-500 bg-slate-50 p-2 rounded border border-slate-100 font-mono truncate">
                                                {JSON.stringify(op.payload)}
                                            </div>
                                        )}
                                    </div>
                                ))
                            )}
                        </div>
                        <div className="p-4 bg-white border-t border-slate-200 text-right">
                            <button onClick={onClose} className="px-5 py-2 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition-colors">Close</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsPage = () => {
            const { settings, updateSettings, pendingOps, orders } = useOrders();
            const [isPendingModalOpen, setIsPendingModalOpen] = useState(false);
            const [showDispatchModal, setShowDispatchModal] = useState(false);

            const handleShippingModeChange = (e) => updateSettings({ shippingMode: e.target.value });
            const handleDateRangeChange = (e) => updateSettings({ dateRangeType: e.target.value });
            const handleStartDateChange = (e) => updateSettings({ customStartDate: e.target.value });
            const handleEndDateChange = (e) => updateSettings({ customEndDate: e.target.value });

            return (
                <div className="w-full max-w-[1000px] mx-auto p-8 space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-3"><Settings size={32} className="text-indigo-600" /> Application Settings</h1>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 flex flex-col h-full">
                            <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><Cloud size={20} className="text-indigo-500"/> Data Synchronization</h2>
                            <div className="flex-1 flex flex-col justify-between">
                                <div className="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-200 mb-4">
                                    <div>
                                        <div className="font-bold text-slate-700 text-sm">Pending Uploads</div>
                                        <div className="text-xs text-slate-500 mt-0.5">Local changes queue</div>
                                    </div>
                                    <span className={`px-2 py-0.5 rounded-full text-[10px] font-bold ${pendingOps.length > 0 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}`}>{pendingOps.length} items</span>
                                </div>
                                <button onClick={() => setIsPendingModalOpen(true)} className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-white border-2 border-slate-100 hover:border-indigo-600 hover:text-indigo-600 rounded-xl font-bold text-sm shadow-sm transition-all group">
                                    <span>Manage Queue</span>
                                    <ChevronRight size={16} className="text-slate-400 group-hover:text-indigo-600 transition-colors" />
                                </button>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col h-full">
                            <div className="flex items-center gap-3 mb-6"><div className="bg-orange-100 p-2.5 rounded-xl text-orange-600"><Truck size={20} /></div><h2 className="font-bold text-lg text-slate-800">Dispatch Management</h2></div>
                            <div className="flex-1 flex flex-col justify-between space-y-4">
                                <p className="text-sm text-slate-500">Generate dispatch manifests and send booking details for Post Office shipments.</p>
                                <button onClick={() => setShowDispatchModal(true)} className="w-full py-3 bg-white border-2 border-slate-200 hover:border-indigo-600 hover:text-indigo-600 text-slate-600 font-bold rounded-xl transition-all flex items-center justify-center gap-2 group"><Mail size={18} className="group-hover:text-indigo-600 text-slate-400 transition-colors" /> Send Dispatch Mail</button>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                        <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><Filter size={20} className="text-indigo-500"/> Data Filters</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Default Date Range</label>
                                <select className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium outline-none focus:ring-2 focus:ring-indigo-500/20" value={settings.dateRangeType || 'last_6_months'} onChange={handleDateRangeChange}>
                                    <option value="last_3_months">Last 3 Months</option>
                                    <option value="last_6_months">Last 6 Months</option>
                                    <option value="last_1_year">Last 1 Year</option>
                                    <option value="custom">Custom Range</option>
                                    <option value="all_data">All Data</option>
                                </select>
                            </div>
                            {settings.dateRangeType === 'custom' && (
                                <div className="flex gap-2 items-end">
                                    <div className="flex-1">
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Start</label>
                                        <input type="date" className="w-full p-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold" value={settings.customStartDate || ''} onChange={handleStartDateChange} />
                                    </div>
                                    <div className="flex-1">
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">End</label>
                                        <input type="date" className="w-full p-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold" value={settings.customEndDate || ''} onChange={handleEndDateChange} />
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <PendingChangesModal isOpen={isPendingModalOpen} onClose={() => setIsPendingModalOpen(false)} />
                    <PostOfficeDispatchModal isOpen={showDispatchModal} onClose={() => setShowDispatchModal(false)} orders={orders} />
                </div>
            );
        };

       const App = () => {
  const [activeTab, setActiveTab] = useState("order-entry");
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);

  return (
    <OrderProvider>
      <div className="flex h-screen bg-slate-100 font-sans text-slate-900 overflow-hidden">
        
        {/* SIDEBAR */}
        <Sidebar
          activeTab={activeTab}
          setActiveTab={setActiveTab}
          isOpen={isSidebarOpen}
          onClose={() => setIsSidebarOpen(false)}
        />

        {/* MAIN CONTENT */}
        <main className="flex-1 relative flex flex-col overflow-y-auto">
          
          {/* MOBILE TOP BAR */}
          <div className="md:hidden flex items-center gap-3 p-3 bg-white border-b shadow-sm">
            <button
              onClick={() => setIsSidebarOpen(true)}
              className="p-2 rounded-md hover:bg-slate-100"
            >
              <List size={22} />
            </button>
            <span className="text-sm font-semibold">Menu</span>
          </div>

          {/* PAGE CONTENT */}
          <div className="flex-1 p-3">
            {activeTab === "order-entry" && <OrderEntryForm />}
            {activeTab === "track-update" && <TrackAndUpdate />}
            {activeTab === "invoice" && <InvoicePage />}
            {activeTab === "edit-orders" && <EditOrdersPage />}
            {activeTab === "settlement" && <SettlementPage />}
            {activeTab === "reports" && <ReportsPage />}
            {activeTab === "settings" && <SettingsPage />}
          </div>
        </main>
      </div>
    </OrderProvider>
  );
};

        const container = document.getElementById('root');
        if (container) {
            const root = createRoot(container);
            root.render(<App />);
        }
    </script>
</body>
